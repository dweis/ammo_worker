/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

//     Underscore.js 1.4.4
//     http://underscorejs.org
//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore may be freely distributed under the MIT license.

!function(n,e){"function"==typeof define&&define.amd?define(e):n.AmmoProxy=e()}(this,function(){var n,e,t;return function(r){function i(n,e){return x.call(n,e)}function o(n,e){var t,r,i,o,a,u,s,c,l,f,h=e&&e.split("/"),p=g.map,m=p&&p["*"]||{};if(n&&"."===n.charAt(0))if(e){for(h=h.slice(0,h.length-1),n=h.concat(n.split("/")),c=0;c<n.length;c+=1)if(f=n[c],"."===f)n.splice(c,1),c-=1;else if(".."===f){if(1===c&&(".."===n[2]||".."===n[0]))break;c>0&&(n.splice(c-1,2),c-=2)}n=n.join("/")}else 0===n.indexOf("./")&&(n=n.substring(2));if((h||m)&&p){for(t=n.split("/"),c=t.length;c>0;c-=1){if(r=t.slice(0,c).join("/"),h)for(l=h.length;l>0;l-=1)if(i=p[h.slice(0,l).join("/")],i&&(i=i[r])){o=i,a=c;break}if(o)break;!u&&m&&m[r]&&(u=m[r],s=c)}!o&&u&&(o=u,a=s),o&&(t.splice(0,a,o),n=t.join("/"))}return n}function a(n,e){return function(){return p.apply(r,b.call(arguments,0).concat([n,e]))}}function u(n){return function(e){return o(e,n)}}function s(n){return function(e){v[n]=e}}function c(n){if(i(y,n)){var e=y[n];delete y[n],w[n]=!0,h.apply(r,e)}if(!i(v,n)&&!i(w,n))throw new Error("No "+n);return v[n]}function l(n){var e,t=n?n.indexOf("!"):-1;return t>-1&&(e=n.substring(0,t),n=n.substring(t+1,n.length)),[e,n]}function f(n){return function(){return g&&g.config&&g.config[n]||{}}}var h,p,m,d,v={},y={},g={},w={},x=Object.prototype.hasOwnProperty,b=[].slice;m=function(n,e){var t,r=l(n),i=r[0];return n=r[1],i&&(i=o(i,e),t=c(i)),i?n=t&&t.normalize?t.normalize(n,u(e)):o(n,e):(n=o(n,e),r=l(n),i=r[0],n=r[1],i&&(t=c(i))),{f:i?i+"!"+n:n,n:n,pr:i,p:t}},d={require:function(n){return a(n)},exports:function(n){var e=v[n];return"undefined"!=typeof e?e:v[n]={}},module:function(n){return{id:n,uri:"",exports:v[n],config:f(n)}}},h=function(n,e,t,o){var u,l,f,h,p,g,x=[];if(o=o||n,"function"==typeof t){for(e=!e.length&&t.length?["require","exports","module"]:e,p=0;p<e.length;p+=1)if(h=m(e[p],o),l=h.f,"require"===l)x[p]=d.require(n);else if("exports"===l)x[p]=d.exports(n),g=!0;else if("module"===l)u=x[p]=d.module(n);else if(i(v,l)||i(y,l)||i(w,l))x[p]=c(l);else{if(!h.p)throw new Error(n+" missing "+l);h.p.load(h.n,a(o,!0),s(l),{}),x[p]=v[l]}f=t.apply(v[n],x),n&&(u&&u.exports!==r&&u.exports!==v[n]?v[n]=u.exports:f===r&&g||(v[n]=f))}else n&&(v[n]=t)},n=e=p=function(n,e,t,i,o){return"string"==typeof n?d[n]?d[n](e):c(m(n,e).f):(n.splice||(g=n,e.splice?(n=e,e=t,t=null):n=r),e=e||function(){},"function"==typeof t&&(t=i,i=o),i?h(r,n,e,t):setTimeout(function(){h(r,n,e,t)},4),p)},p.config=function(n){return g=n,g.deps&&p(g.deps,g.callback),p},t=function(n,e,t){e.splice||(t=e,e=[]),i(v,n)||i(y,n)||(y[n]=[n,e,t])},t.amd={jQuery:!0}}(),t("vendor/almond",function(){}),function(){var n=this,e=n._,r={},i=Array.prototype,o=Object.prototype,a=Function.prototype,u=i.push,s=i.slice,c=i.concat,l=o.toString,f=o.hasOwnProperty,h=i.forEach,p=i.map,m=i.reduce,d=i.reduceRight,v=i.filter,y=i.every,g=i.some,w=i.indexOf,x=i.lastIndexOf,b=Array.isArray,A=Object.keys,_=a.bind,S=function(n){return n instanceof S?n:this instanceof S?(this._wrapped=n,void 0):new S(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=S),exports._=S):n._=S,S.VERSION="1.4.4";var R=S.each=S.forEach=function(n,e,t){if(null!=n)if(h&&n.forEach===h)n.forEach(e,t);else if(n.length===+n.length){for(var i=0,o=n.length;o>i;i++)if(e.call(t,n[i],i,n)===r)return}else for(var a in n)if(S.has(n,a)&&e.call(t,n[a],a,n)===r)return};S.map=S.collect=function(n,e,t){var r=[];return null==n?r:p&&n.map===p?n.map(e,t):(R(n,function(n,i,o){r[r.length]=e.call(t,n,i,o)}),r)};var E="Reduce of empty array with no initial value";S.reduce=S.foldl=S.inject=function(n,e,t,r){var i=arguments.length>2;if(null==n&&(n=[]),m&&n.reduce===m)return r&&(e=S.bind(e,r)),i?n.reduce(e,t):n.reduce(e);if(R(n,function(n,o,a){i?t=e.call(r,t,n,o,a):(t=n,i=!0)}),!i)throw new TypeError(E);return t},S.reduceRight=S.foldr=function(n,e,t,r){var i=arguments.length>2;if(null==n&&(n=[]),d&&n.reduceRight===d)return r&&(e=S.bind(e,r)),i?n.reduceRight(e,t):n.reduceRight(e);var o=n.length;if(o!==+o){var a=S.keys(n);o=a.length}if(R(n,function(u,s,c){s=a?a[--o]:--o,i?t=e.call(r,t,n[s],s,c):(t=n[s],i=!0)}),!i)throw new TypeError(E);return t},S.find=S.detect=function(n,e,t){var r;return I(n,function(n,i,o){return e.call(t,n,i,o)?(r=n,!0):void 0}),r},S.filter=S.select=function(n,e,t){var r=[];return null==n?r:v&&n.filter===v?n.filter(e,t):(R(n,function(n,i,o){e.call(t,n,i,o)&&(r[r.length]=n)}),r)},S.reject=function(n,e,t){return S.filter(n,function(n,r,i){return!e.call(t,n,r,i)},t)},S.every=S.all=function(n,e,t){e||(e=S.identity);var i=!0;return null==n?i:y&&n.every===y?n.every(e,t):(R(n,function(n,o,a){return(i=i&&e.call(t,n,o,a))?void 0:r}),!!i)};var I=S.some=S.any=function(n,e,t){e||(e=S.identity);var i=!1;return null==n?i:g&&n.some===g?n.some(e,t):(R(n,function(n,o,a){return i||(i=e.call(t,n,o,a))?r:void 0}),!!i)};S.contains=S.include=function(n,e){return null==n?!1:w&&n.indexOf===w?-1!=n.indexOf(e):I(n,function(n){return n===e})},S.invoke=function(n,e){var t=s.call(arguments,2),r=S.isFunction(e);return S.map(n,function(n){return(r?e:n[e]).apply(n,t)})},S.pluck=function(n,e){return S.map(n,function(n){return n[e]})},S.where=function(n,e,t){return S.isEmpty(e)?t?null:[]:S[t?"find":"filter"](n,function(n){for(var t in e)if(e[t]!==n[t])return!1;return!0})},S.findWhere=function(n,e){return S.where(n,e,!0)},S.max=function(n,e,t){if(!e&&S.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.max.apply(Math,n);if(!e&&S.isEmpty(n))return-1/0;var r={computed:-1/0,value:-1/0};return R(n,function(n,i,o){var a=e?e.call(t,n,i,o):n;a>=r.computed&&(r={value:n,computed:a})}),r.value},S.min=function(n,e,t){if(!e&&S.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.min.apply(Math,n);if(!e&&S.isEmpty(n))return 1/0;var r={computed:1/0,value:1/0};return R(n,function(n,i,o){var a=e?e.call(t,n,i,o):n;a<r.computed&&(r={value:n,computed:a})}),r.value},S.shuffle=function(n){var e,t=0,r=[];return R(n,function(n){e=S.random(t++),r[t-1]=r[e],r[e]=n}),r};var j=function(n){return S.isFunction(n)?n:function(e){return e[n]}};S.sortBy=function(n,e,t){var r=j(e);return S.pluck(S.map(n,function(n,e,i){return{value:n,index:e,criteria:r.call(t,n,e,i)}}).sort(function(n,e){var t=n.criteria,r=e.criteria;if(t!==r){if(t>r||void 0===t)return 1;if(r>t||void 0===r)return-1}return n.index<e.index?-1:1}),"value")};var k=function(n,e,t,r){var i={},o=j(e||S.identity);return R(n,function(e,a){var u=o.call(t,e,a,n);r(i,u,e)}),i};S.groupBy=function(n,e,t){return k(n,e,t,function(n,e,t){(S.has(n,e)?n[e]:n[e]=[]).push(t)})},S.countBy=function(n,e,t){return k(n,e,t,function(n,e){S.has(n,e)||(n[e]=0),n[e]++})},S.sortedIndex=function(n,e,t,r){t=null==t?S.identity:j(t);for(var i=t.call(r,e),o=0,a=n.length;a>o;){var u=o+a>>>1;t.call(r,n[u])<i?o=u+1:a=u}return o},S.toArray=function(n){return n?S.isArray(n)?s.call(n):n.length===+n.length?S.map(n,S.identity):S.values(n):[]},S.size=function(n){return null==n?0:n.length===+n.length?n.length:S.keys(n).length},S.first=S.head=S.take=function(n,e,t){return null==n?void 0:null==e||t?n[0]:s.call(n,0,e)},S.initial=function(n,e,t){return s.call(n,0,n.length-(null==e||t?1:e))},S.last=function(n,e,t){return null==n?void 0:null==e||t?n[n.length-1]:s.call(n,Math.max(n.length-e,0))},S.rest=S.tail=S.drop=function(n,e,t){return s.call(n,null==e||t?1:e)},S.compact=function(n){return S.filter(n,S.identity)};var V=function(n,e,t){return R(n,function(n){S.isArray(n)?e?u.apply(t,n):V(n,e,t):t.push(n)}),t};S.flatten=function(n,e){return V(n,e,[])},S.without=function(n){return S.difference(n,s.call(arguments,1))},S.uniq=S.unique=function(n,e,t,r){S.isFunction(e)&&(r=t,t=e,e=!1);var i=t?S.map(n,t,r):n,o=[],a=[];return R(i,function(t,r){(e?r&&a[a.length-1]===t:S.contains(a,t))||(a.push(t),o.push(n[r]))}),o},S.union=function(){return S.uniq(c.apply(i,arguments))},S.intersection=function(n){var e=s.call(arguments,1);return S.filter(S.uniq(n),function(n){return S.every(e,function(e){return S.indexOf(e,n)>=0})})},S.difference=function(n){var e=c.apply(i,s.call(arguments,1));return S.filter(n,function(n){return!S.contains(e,n)})},S.zip=function(){for(var n=s.call(arguments),e=S.max(S.pluck(n,"length")),t=new Array(e),r=0;e>r;r++)t[r]=S.pluck(n,""+r);return t},S.object=function(n,e){if(null==n)return{};for(var t={},r=0,i=n.length;i>r;r++)e?t[n[r]]=e[r]:t[n[r][0]]=n[r][1];return t},S.indexOf=function(n,e,t){if(null==n)return-1;var r=0,i=n.length;if(t){if("number"!=typeof t)return r=S.sortedIndex(n,e),n[r]===e?r:-1;r=0>t?Math.max(0,i+t):t}if(w&&n.indexOf===w)return n.indexOf(e,t);for(;i>r;r++)if(n[r]===e)return r;return-1},S.lastIndexOf=function(n,e,t){if(null==n)return-1;var r=null!=t;if(x&&n.lastIndexOf===x)return r?n.lastIndexOf(e,t):n.lastIndexOf(e);for(var i=r?t:n.length;i--;)if(n[i]===e)return i;return-1},S.range=function(n,e,t){arguments.length<=1&&(e=n||0,n=0),t=arguments[2]||1;for(var r=Math.max(Math.ceil((e-n)/t),0),i=0,o=new Array(r);r>i;)o[i++]=n,n+=t;return o},S.bind=function(n,e){if(n.bind===_&&_)return _.apply(n,s.call(arguments,1));var t=s.call(arguments,2);return function(){return n.apply(e,t.concat(s.call(arguments)))}},S.partial=function(n){var e=s.call(arguments,1);return function(){return n.apply(this,e.concat(s.call(arguments)))}},S.bindAll=function(n){var e=s.call(arguments,1);return 0===e.length&&(e=S.functions(n)),R(e,function(e){n[e]=S.bind(n[e],n)}),n},S.memoize=function(n,e){var t={};return e||(e=S.identity),function(){var r=e.apply(this,arguments);return S.has(t,r)?t[r]:t[r]=n.apply(this,arguments)}},S.delay=function(n,e){var t=s.call(arguments,2);return setTimeout(function(){return n.apply(null,t)},e)},S.defer=function(n){return S.delay.apply(S,[n,1].concat(s.call(arguments,1)))},S.throttle=function(n,e){var t,r,i,o,a=0,u=function(){a=new Date,i=null,o=n.apply(t,r)};return function(){var s=new Date,c=e-(s-a);return t=this,r=arguments,0>=c?(clearTimeout(i),i=null,a=s,o=n.apply(t,r)):i||(i=setTimeout(u,c)),o}},S.debounce=function(n,e,t){var r,i;return function(){var o=this,a=arguments,u=function(){r=null,t||(i=n.apply(o,a))},s=t&&!r;return clearTimeout(r),r=setTimeout(u,e),s&&(i=n.apply(o,a)),i}},S.once=function(n){var e,t=!1;return function(){return t?e:(t=!0,e=n.apply(this,arguments),n=null,e)}},S.wrap=function(n,e){return function(){var t=[n];return u.apply(t,arguments),e.apply(this,t)}},S.compose=function(){var n=arguments;return function(){for(var e=arguments,t=n.length-1;t>=0;t--)e=[n[t].apply(this,e)];return e[0]}},S.after=function(n,e){return 0>=n?e():function(){return--n<1?e.apply(this,arguments):void 0}},S.keys=A||function(n){if(n!==Object(n))throw new TypeError("Invalid object");var e=[];for(var t in n)S.has(n,t)&&(e[e.length]=t);return e},S.values=function(n){var e=[];for(var t in n)S.has(n,t)&&e.push(n[t]);return e},S.pairs=function(n){var e=[];for(var t in n)S.has(n,t)&&e.push([t,n[t]]);return e},S.invert=function(n){var e={};for(var t in n)S.has(n,t)&&(e[n[t]]=t);return e},S.functions=S.methods=function(n){var e=[];for(var t in n)S.isFunction(n[t])&&e.push(t);return e.sort()},S.extend=function(n){return R(s.call(arguments,1),function(e){if(e)for(var t in e)n[t]=e[t]}),n},S.pick=function(n){var e={},t=c.apply(i,s.call(arguments,1));return R(t,function(t){t in n&&(e[t]=n[t])}),e},S.omit=function(n){var e={},t=c.apply(i,s.call(arguments,1));for(var r in n)S.contains(t,r)||(e[r]=n[r]);return e},S.defaults=function(n){return R(s.call(arguments,1),function(e){if(e)for(var t in e)null==n[t]&&(n[t]=e[t])}),n},S.clone=function(n){return S.isObject(n)?S.isArray(n)?n.slice():S.extend({},n):n},S.tap=function(n,e){return e(n),n};var O=function(n,e,t,r){if(n===e)return 0!==n||1/n==1/e;if(null==n||null==e)return n===e;n instanceof S&&(n=n._wrapped),e instanceof S&&(e=e._wrapped);var i=l.call(n);if(i!=l.call(e))return!1;switch(i){case"[object String]":return n==String(e);case"[object Number]":return n!=+n?e!=+e:0==n?1/n==1/e:n==+e;case"[object Date]":case"[object Boolean]":return+n==+e;case"[object RegExp]":return n.source==e.source&&n.global==e.global&&n.multiline==e.multiline&&n.ignoreCase==e.ignoreCase}if("object"!=typeof n||"object"!=typeof e)return!1;for(var o=t.length;o--;)if(t[o]==n)return r[o]==e;t.push(n),r.push(e);var a=0,u=!0;if("[object Array]"==i){if(a=n.length,u=a==e.length)for(;a--&&(u=O(n[a],e[a],t,r)););}else{var s=n.constructor,c=e.constructor;if(s!==c&&!(S.isFunction(s)&&s instanceof s&&S.isFunction(c)&&c instanceof c))return!1;for(var f in n)if(S.has(n,f)&&(a++,!(u=S.has(e,f)&&O(n[f],e[f],t,r))))break;if(u){for(f in e)if(S.has(e,f)&&!a--)break;u=!a}}return t.pop(),r.pop(),u};S.isEqual=function(n,e){return O(n,e,[],[])},S.isEmpty=function(n){if(null==n)return!0;if(S.isArray(n)||S.isString(n))return 0===n.length;for(var e in n)if(S.has(n,e))return!1;return!0},S.isElement=function(n){return!(!n||1!==n.nodeType)},S.isArray=b||function(n){return"[object Array]"==l.call(n)},S.isObject=function(n){return n===Object(n)},R(["Arguments","Function","String","Number","Date","RegExp"],function(n){S["is"+n]=function(e){return l.call(e)=="[object "+n+"]"}}),S.isArguments(arguments)||(S.isArguments=function(n){return!(!n||!S.has(n,"callee"))}),"function"!=typeof/./&&(S.isFunction=function(n){return"function"==typeof n}),S.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},S.isNaN=function(n){return S.isNumber(n)&&n!=+n},S.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"==l.call(n)},S.isNull=function(n){return null===n},S.isUndefined=function(n){return void 0===n},S.has=function(n,e){return f.call(n,e)},S.noConflict=function(){return n._=e,this},S.identity=function(n){return n},S.times=function(n,e,t){for(var r=Array(n),i=0;n>i;i++)r[i]=e.call(t,i);return r},S.random=function(n,e){return null==e&&(e=n,n=0),n+Math.floor(Math.random()*(e-n+1))};var z={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};z.unescape=S.invert(z.escape);var T={escape:new RegExp("["+S.keys(z.escape).join("")+"]","g"),unescape:new RegExp("("+S.keys(z.unescape).join("|")+")","g")};S.each(["escape","unescape"],function(n){S[n]=function(e){return null==e?"":(""+e).replace(T[n],function(e){return z[n][e]})}}),S.result=function(n,e){if(null==n)return null;var t=n[e];return S.isFunction(t)?t.call(n):t},S.mixin=function(n){R(S.functions(n),function(e){var t=S[e]=n[e];S.prototype[e]=function(){var n=[this._wrapped];return u.apply(n,arguments),D.call(this,t.apply(S,n))}})};var B=0;S.uniqueId=function(n){var e=++B+"";return n?n+e:e},S.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var F=/(.)^/,C={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},W=/\\|'|\r|\n|\t|\u2028|\u2029/g;S.template=function(n,e,t){var r;t=S.defaults({},t,S.templateSettings);var i=new RegExp([(t.escape||F).source,(t.interpolate||F).source,(t.evaluate||F).source].join("|")+"|$","g"),o=0,a="__p+='";n.replace(i,function(e,t,r,i,u){return a+=n.slice(o,u).replace(W,function(n){return"\\"+C[n]}),t&&(a+="'+\n((__t=("+t+"))==null?'':_.escape(__t))+\n'"),r&&(a+="'+\n((__t=("+r+"))==null?'':__t)+\n'"),i&&(a+="';\n"+i+"\n__p+='"),o=u+e.length,e}),a+="';\n",t.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{r=new Function(t.variable||"obj","_",a)}catch(u){throw u.source=a,u}if(e)return r(e,S);var s=function(n){return r.call(this,n,S)};return s.source="function("+(t.variable||"obj")+"){\n"+a+"}",s},S.chain=function(n){return S(n).chain()};var D=function(n){return this._chain?S(n).chain():n};S.mixin(S),R(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var e=i[n];S.prototype[n]=function(){var t=this._wrapped;return e.apply(t,arguments),"shift"!=n&&"splice"!=n||0!==t.length||delete t[0],D.call(this,t)}}),R(["concat","join","slice"],function(n){var e=i[n];S.prototype[n]=function(){return D.call(this,e.apply(this._wrapped,arguments))}}),S.extend(S.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof t&&t.amd&&t("underscore",[],function(){return S})}.call(this),t("ammo_worker_api",[],function(){function n(n){this.maxBodies=1e3,this.maxVehicles=32,this.maxWheelsPerVehicle=8;for(var e in n)n.hasOwnProperty(e)&&(this[e]=n[e])}return n.prototype={init:function(){importScripts("./js/ammo.js"),this.bodies=[],this.vehicles=[],this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.fire("ready")},startSimulation:function(){var n,e=this,t=new Ammo.btTransform,r=0,i=0,o=1,a=8*7*this.maxBodies+8*7*this.maxVehicles*this.maxWheelsPerVehicle;this.buffers=[new ArrayBuffer(a),new ArrayBuffer(a),new ArrayBuffer(a)],n=Date.now(),this.simulationTimerId=setInterval(function(){var a,u,s,c,l,f=Date.now(),h=f-n||1;e.dynamicsWorld.stepSimulation(e.step,e.iterations);var p;p=r>0?Math.min(.1,h/1e3):.1,r=p*h+(1-p)*r;var m=1/o++;if(i=m*h+(1-m)*i,n=Date.now(),e.buffers.length>0&&(u=new Float64Array(e.buffers.pop())),u&&u.buffer instanceof ArrayBuffer){for(s in e.bodies)e.bodies[s]&&(t.setIdentity(),e.bodies[s].getMotionState().getWorldTransform(t),u[7*s+0]=t.getOrigin().x(),u[7*s+1]=t.getOrigin().y(),u[7*s+2]=t.getOrigin().z(),u[7*s+3]=t.getRotation().x(),u[7*s+4]=t.getRotation().y(),u[7*s+5]=t.getRotation().z(),u[7*s+6]=t.getRotation().w());for(s in e.vehicles)if(e.vehicles[s])for(a=e.vehicles[s],c=0;c<a.getNumWheels()+1;c++)t=a.getWheelInfo(c).get_m_worldTransform(),l=7*e.maxBodies+7*s*e.maxWheelsPerVehicle+7*c,u[l+0]=t.getOrigin().x(),u[l+1]=t.getOrigin().y(),u[l+2]=t.getOrigin().z(),u[l+3]=t.getRotation().x(),u[l+4]=t.getRotation().y(),u[l+5]=t.getRotation().z(),u[l+6]=t.getRotation().w();e.fire("update",u.buffer,[u.buffer]),e.fire("stats",{currFPS:Math.round(1e3/r),allFPS:Math.round(1e3/i)})}},1e3*this.step)},stopSimulation:function(){this.simulationTimerId&&clearInterval(this.simulationTimerId)},swap:function(n){n instanceof ArrayBuffer&&this.buffers.push(n)},setStep:function(n){this.step=n},setIterations:function(n){this.iterations=n},setGravity:function(n){this.dynamicsWorld.setGravity(new Ammo.btVector3(n.x,n.y,n.z))},_createCompoundShape:function(n){var e,t,r=new Ammo.btCompoundShape,i=new Ammo.btTransform;if(n.children&&n.children.length)for(var o in n.children)n.children.hasOwnProperty(o)&&(e=n.children[o],t=this._createShape(e),i.setIdentity(),i.setOrigin(new Ammo.btVector3(e.localTransform.position.x,e.localTransform.position.y,e.localTransform.position.z)),i.setRotation(new Ammo.btQuaternion(e.localTransform.rotation.x,e.localTransform.rotation.y,e.localTransform.rotation.z,e.localTransform.rotation.w)),r.addChildShape(i,t));return r},_createShape:function(n){var e;switch(n.shape){case"box":e=new Ammo.btBoxShape(new Ammo.btVector3(n.halfExtents.x,n.halfExtents.y,n.halfExtents.z));break;case"sphere":e=new Ammo.btSphereShape(n.radius);break;case"staticplane":e=new Ammo.btStaticPlaneShape(new Ammo.btVector3(n.normal.x,n.normal.y,n.normal.z),n.distance);break;case"cylinder":e=new Ammo.btCylinderShape(new Ammo.btVector3(n.width,n.height,n.depth));break;case"capsule":e=new Ammo.btCapsuleShape(n.radius,n.height);break;case"cone":e=new Ammo.btConeShape(n.radius,n.height);break;case"compound":e=this._createCompoundShape(n);break;default:return console.error("Unknown shape: "+n.shape)}return e},addVehicle:function(n,e){var t,r=new Ammo.btVehicleTuning,i=this.bodies[n.bodyId];if(!i)return console.error("could not find body");r.set_m_suspensionStiffness(n.suspensionStiffness),r.set_m_suspensionCompression(n.suspensionCompression),r.set_m_suspensionDamping(n.suspensionDamping),r.set_m_maxSuspensionTravelCm(n.maxSuspensionTravel),r.set_m_maxSuspensionForce(n.maxSuspensionForce),t=new Ammo.btRaycastVehicle(r,i,new Ammo.btDefaultVehicleRaycaster(this.dynamicsWorld)),t.tuning=r,i.setActivationState(4),t.setCoordinateSystem(0,1,2),this.dynamicsWorld.addVehicle(t);var o=this.vehicles.push(t)-1;"function"==typeof e&&(console.log("added"),e(o))},removeVehicle:function(n){this.dynamicsWorld.removeVehicle(this.vehicles[n]),delete this.vehicles[n]},addWheel:function(n,e){var t=this.vehicles[n.vehicleId];if(void 0!==t){var r=t.tuning,i=new Ammo.btVector3(n.connectionPoint.x,n.connectionPoint.y,n.connectionPoint.z),o=new Ammo.btVector3(n.wheelDirection.x,n.wheelDirection.y,n.wheelDirection.z),a=new Ammo.btVector3(n.wheelAxle.x,n.wheelAxle.y,n.wheelAxle.z);t.addWheel(i,o,a,n.suspensionRestLength,n.wheelRadius,r,n.isFrontWheel),"function"==typeof e&&e(t.getNumWheels()-1)}},setSteeringValue:function(n){void 0!==this.vehicles[n.vehicleId]&&this.vehicles[n.vehicleId].setSteeringValue(n.steering,n.wheel)},setBrake:function(n){void 0!==this.vehicles[n.vehicleId]&&this.vehicles[n.vehicleId].setBrake(n.brake,n.wheel)},setWheelInfo:function(n){if(void 0!==this.vehicles[n.vehicleId]){var e=this.vehicles[n.vehicleId].getWheelInfo(n.wheel);n.suspensionStiffness&&e.set_m_suspensionStiffness(n.suspensionStiffness),n.wheelsDampingRelaxation&&e.set_m_wheelsDampingRelaxation(n.wheelsDampingRelaxation),n.wheelsDampingCompression&&e.set_m_wheelsDampingCompression(n.wheelsDampingCompression),n.frictionSlip&&e.set_m_frictionSlip(n.frictionSlip),n.rollInfluence&&e.set_m_rollInfluence(n.rollInfluence)}},applyEngineForce:function(n){void 0!==this.vehicles[n.vehicleId]&&this.vehicles[n.vehicleId].applyEngineForce(n.force,n.wheel)},addRigidBody:function(n,e){var t,r,i,o,a=new Ammo.btTransform,u=0!==n.mass,s=new Ammo.btVector3(0,0,0);a.setIdentity(),t=this._createShape(n.shape),u&&t.calculateLocalInertia(n.mass,s),a.setOrigin(new Ammo.btVector3(n.position.x,n.position.y,n.position.z)),a.setRotation(new Ammo.btQuaternion(n.quaternion.x,n.quaternion.y,n.quaternion.z,n.quaternion.w)),r=new Ammo.btDefaultMotionState(a),i=new Ammo.btRigidBodyConstructionInfo(n.mass,r,t,s),o=new Ammo.btRigidBody(i),this.dynamicsWorld.addRigidBody(o);var c=this.bodies.push(o)-1;"function"==typeof e&&e(c)},setRestition:function(n){var e=this.bodies[n.bodyId];e&&e.setRestitution(n.restitution)},setFriction:function(n){var e=this.bodies[n.bodyId];e&&e.setFriction(n.friction)},removeRigidBody:function(n){this.dynamicsWorld.removeRigidBody(this.bodies[n]),Ammo.destroy(this.bodies[n])},shutdown:function(){Ammo.destroy(this.collisionConfiguration),Ammo.destroy(this.dispatcher),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.solver)}},n}),t("ammo_proxy",["underscore","ammo_worker_api"],function(n,e){function t(t){function r(n){o[n]=function(){return o.worker[n].apply(o.worker,arguments)}}var i,o=this,a=["on","fire","addRigidBody","setStep","setIterations","setGravity","startSimulation","stopSimulation","addVehicle","removeVehicle","addWheel","applyEngineForce","setBrake","setSteeringValue","setWheelInfo"];t=t||{},t.gravity=t.gravity||{x:0,y:-9.82,z:0},t.iterations=t.iterations||10,t.step=t.step||1/60,t.maxBodies=t.maxBodies||1e3,t.maxVehicles=t.maxVehicles||32,t.maxWheelsPerVehicle=t.maxWheelsPerVehicle||8,this.worker=cw(new e(t)),this.worker.on("update",n.bind(this.update,this));for(i in a)a.hasOwnProperty(i)&&r(a[i]);this.setStep(t.step),this.setIterations(t.iterations),this.setGravity(t.gravity)}return t.prototype.update=function(n){this.next&&(this.worker.swap(this.data&&this.data.buffer),this.data=this.next),this.next=new Float64Array(n)},t.prototype.addRigidBodyObject=function(n,e,t){t||(t=this.getShapeJSON(n));var r={mass:e,shape:t,position:{x:n.position.x,y:n.position.y,z:n.position.z},quaternion:{x:n.quaternion.x,y:n.quaternion.y,z:n.quaternion.z,w:n.quaternion.w}};return this.worker.addRigidBody(r)},t.prototype.updateBody=function(n,e){var t,r,i;this.data&&(i=7*e,t=n.position,r=n.quaternion,t.x=this.data[i+0],t.y=this.data[i+1],t.z=this.data[i+2],r.x=this.data[i+3],r.y=this.data[i+4],r.z=this.data[i+5],r.w=this.data[i+6])},t.prototype.updateWheel=function(n,e,t){var r,i,o;this.data&&(o=7e3+7*8*e+7*t,r=n.position,i=n.quaternion,r.x=this.data[o+0],r.y=this.data[o+1],r.z=this.data[o+2],i.x=this.data[o+3],i.y=this.data[o+4],i.z=this.data[o+5],i.w=this.data[o+6])},t.prototype.getShapeJSON=function(n){var e=new THREE.Matrix4,t=new THREE.Matrix4,r={shape:"compound",children:[]};return e.getInverse(n.matrixWorld),n.traverse(function(n){if(n instanceof THREE.Mesh){var i,o,a,u=new THREE.Vector3,s=new THREE.Vector3,c=new THREE.Quaternion,l=n.matrixWorld.clone(),f=new THREE.Vector3;t.copy(e),t.multiply(l),s.getPositionFromMatrix(t),f.getScaleFromMatrix(l),t.extractRotation(t),c.setFromRotationMatrix(t),n.geometry.computeBoundingBox(),i=n.geometry.boundingBox.min.clone(),o=n.geometry.boundingBox.max.clone(),u.subVectors(o,i),u.multiplyScalar(.5),u.multiplyVectors(u,f),a=u;var h=new THREE.Vector3;h.x=(i.x+o.x)/2,h.y=(i.y+o.y)/2,h.z=(i.z+o.z)/2,h.multiplyVectors(h,f),r.children.push({shape:"box",halfExtents:{x:a.x,y:a.y,z:a.z},localTransform:{position:{x:s.x,y:s.y,z:s.z},rotation:{x:c.x,y:c.y,z:c.z,w:c.w}}})}}),r},t}),e("ammo_proxy")});