/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/** @license MIT License (c) copyright 2011-2013 original author or authors */

/**
 * A lightweight CommonJS Promises/A and when() implementation
 * when is part of the cujo.js family of libraries (http://cujojs.com/)
 *
 * Licensed under the MIT License at:
 * http://www.opensource.org/licenses/mit-license.php
 *
 * @author Brian Cavalier
 * @author John Hann
 * @version 2.5.1
 */

//     Underscore.js 1.4.4
//     http://underscorejs.org
//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore may be freely distributed under the MIT license.

!function(t,e){"function"==typeof define&&define.amd?define(e):t.AmmoProxy=e()}(this,function(){var t,e,n;return function(i){function r(t,e){return b.call(t,e)}function o(t,e){var n,i,r,o,u,s,a,c,l,f,p=e&&e.split("/"),h=g.map,m=h&&h["*"]||{};if(t&&"."===t.charAt(0))if(e){for(p=p.slice(0,p.length-1),t=p.concat(t.split("/")),c=0;c<t.length;c+=1)if(f=t[c],"."===f)t.splice(c,1),c-=1;else if(".."===f){if(1===c&&(".."===t[2]||".."===t[0]))break;c>0&&(t.splice(c-1,2),c-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((p||m)&&h){for(n=t.split("/"),c=n.length;c>0;c-=1){if(i=n.slice(0,c).join("/"),p)for(l=p.length;l>0;l-=1)if(r=h[p.slice(0,l).join("/")],r&&(r=r[i])){o=r,u=c;break}if(o)break;!s&&m&&m[i]&&(s=m[i],a=c)}!o&&s&&(o=s,u=a),o&&(n.splice(0,u,o),t=n.join("/"))}return t}function u(t,e){return function(){return h.apply(i,w.call(arguments,0).concat([t,e]))}}function s(t){return function(e){return o(e,t)}}function a(t){return function(e){y[t]=e}}function c(t){if(r(v,t)){var e=v[t];delete v[t],x[t]=!0,p.apply(i,e)}if(!r(y,t)&&!r(x,t))throw new Error("No "+t);return y[t]}function l(t){var e,n=t?t.indexOf("!"):-1;return n>-1&&(e=t.substring(0,n),t=t.substring(n+1,t.length)),[e,t]}function f(t){return function(){return g&&g.config&&g.config[t]||{}}}var p,h,m,d,y={},v={},g={},x={},b=Object.prototype.hasOwnProperty,w=[].slice;m=function(t,e){var n,i=l(t),r=i[0];return t=i[1],r&&(r=o(r,e),n=c(r)),r?t=n&&n.normalize?n.normalize(t,s(e)):o(t,e):(t=o(t,e),i=l(t),r=i[0],t=i[1],r&&(n=c(r))),{f:r?r+"!"+t:t,n:t,pr:r,p:n}},d={require:function(t){return u(t)},exports:function(t){var e=y[t];return"undefined"!=typeof e?e:y[t]={}},module:function(t){return{id:t,uri:"",exports:y[t],config:f(t)}}},p=function(t,e,n,o){var s,l,f,p,h,g,b=[];if(o=o||t,"function"==typeof n){for(e=!e.length&&n.length?["require","exports","module"]:e,h=0;h<e.length;h+=1)if(p=m(e[h],o),l=p.f,"require"===l)b[h]=d.require(t);else if("exports"===l)b[h]=d.exports(t),g=!0;else if("module"===l)s=b[h]=d.module(t);else if(r(y,l)||r(v,l)||r(x,l))b[h]=c(l);else{if(!p.p)throw new Error(t+" missing "+l);p.p.load(p.n,u(o,!0),a(l),{}),b[h]=y[l]}f=n.apply(y[t],b),t&&(s&&s.exports!==i&&s.exports!==y[t]?y[t]=s.exports:f===i&&g||(y[t]=f))}else t&&(y[t]=n)},t=e=h=function(t,e,n,r,o){return"string"==typeof t?d[t]?d[t](e):c(m(t,e).f):(t.splice||(g=t,e.splice?(t=e,e=n,n=null):t=i),e=e||function(){},"function"==typeof n&&(n=r,r=o),r?p(i,t,e,n):setTimeout(function(){p(i,t,e,n)},4),h)},h.config=function(t){return g=t,g.deps&&h(g.deps,g.callback),h},n=function(t,e,n){e.splice||(n=e,e=[]),r(y,t)||r(v,t)||(v[t]=[t,e,n])},n.amd={jQuery:!0}}(),n("vendor/almond",function(){}),function(t,e){t("when",["require"],function(t){function n(t,e,n,r){return i(t).then(e,n,r)}function i(t){return t instanceof r?t:o(t)}function r(t,e){this._message=t,this.inspect=e}function o(t){return a(function(e){e(t)})}function u(t){return n(t,p)}function s(){function t(t,r,u){e.resolve=e.resolver.resolve=function(e){return i?o(e):(i=!0,t(e),n)},e.reject=e.resolver.reject=function(t){return i?o(p(t)):(i=!0,r(t),n)},e.notify=e.resolver.notify=function(t){return u(t),t}}var e,n,i;return e={promise:H,resolve:H,reject:H,notify:H,resolver:{resolve:H,reject:H,notify:H}},e.promise=n=a(t),e}function a(t){return c(t,X.PromiseStatus&&X.PromiseStatus())}function c(t,e){function n(t,e,n,i){function r(r){r._message(t,e,n,i)}f?f.push(r):E(function(){r(c)})}function i(){return c?c.inspect():k()}function o(t){if(f){var n=f;f=H,E(function(){c=d(a,t),e&&x(c,e),l(n,c)})}}function u(t){o(p(t))}function s(t){if(f){var e=f;E(function(){l(e,m(t))})}}var a,c,f=[];a=new r(n,i),a._status=e;try{t(o,u,s)}catch(h){u(h)}return a}function l(t,e){for(var n=0;n<t.length;n++)t[n](e)}function f(t){return h(new v(t),function(){return R(t)})}function p(t){return h(new g(t),function(){return O(t)})}function h(t,e){return new r(function(e,n,i){try{i(t[e].apply(t,n))}catch(r){i(p(r))}},e)}function m(t){return new r(function(e,n,i,r){var o=n[2];try{r("function"==typeof o?o(t):t)}catch(u){r(u)}})}function d(t,e){if(e===t)return p(new TypeError);if(e instanceof r)return e;try{var n=e===Object(e)&&e.then;return"function"==typeof n?y(n,e):f(e)}catch(i){return p(i)}}function y(t,e){return a(function(n,i){C(t,e,n,i)})}function v(t){this.value=t}function g(t){this.reason=t}function x(t,e){function n(){e.fulfilled()}function i(t){e.rejected(t)}t.then(n,i)}function b(t){return t&&"function"==typeof t.then}function w(t,e,i,r,o){return n(t,function(t){function u(i,r,o){function u(t){h(t)}function s(t){p(t)}var a,c,l,f,p,h,m,d;if(m=t.length>>>0,a=Math.max(0,Math.min(e,m)),l=[],c=m-a+1,f=[],a)for(h=function(t){f.push(t),--c||(p=h=F,r(f))},p=function(t){l.push(t),--a||(p=h=F,i(l))},d=0;m>d;++d)d in t&&n(t[d],s,u,o);else i(l)}return a(u).then(i,r,o)})}function _(t,e,n,i){function r(t){return e?e(t[0]):t[0]}return w(t,1,r,n,i)}function V(t,e,n,i){return A(t,F).then(e,n,i)}function S(){return A(arguments,F)}function I(t){return A(t,R,O)}function T(t,e){return A(t,e)}function A(t,e,i){return n(t,function(t){function r(r,o,u){function s(t,s){n(t,e,i).then(function(t){a[s]=t,--l||r(a)},o,u)}var a,c,l,f;if(l=c=t.length>>>0,a=[],!l)return r(a),void 0;for(f=0;c>f;f++)f in t?s(t[f],f):--l}return c(r)})}function j(t,e){var i=C(W,arguments,1);return n(t,function(t){var r;return r=t.length,i[0]=function(t,i,o){return n(t,function(t){return n(i,function(n){return e(t,n,o,r)})})},z.apply(t,i)})}function R(t){return{state:"fulfilled",value:t}}function O(t){return{state:"rejected",reason:t}}function k(){return{state:"pending"}}function E(t){1===M.push(t)&&P(B)}function B(){l(M),M=[]}function F(t){return t}n.promise=a,n.resolve=o,n.reject=u,n.defer=s,n.join=S,n.all=V,n.map=T,n.reduce=j,n.settle=I,n.any=_,n.some=w,n.isPromise=b,n.isPromiseLike=b,r.prototype={then:function(){var t,e;return t=arguments,e=this._message,c(function(n,i,r){e("when",t,n,r)},this._status&&this._status.observed())},otherwise:function(t){return this.then(H,t)},ensure:function(t){function e(){return o(t())}return"function"==typeof t?this.then(e,e).yield(this):this},yield:function(t){return this.then(function(){return t})},tap:function(t){return this.then(t).yield(this)},spread:function(t){return this.then(function(e){return V(e,function(e){return t.apply(H,e)})})},always:function(t,e){return this.then(t,t,e)}},v.prototype.when=function(t){return"function"==typeof t?t(this.value):this.value},g.prototype.when=function(t,e){if("function"==typeof e)return e(this.reason);throw this.reason};var z,W,C,P,M,q,D,N,Z,X,Y,Q,H;if(Y=t,M=[],q=e.setTimeout,X="undefined"!=typeof console?console:n,"object"==typeof process&&process.nextTick)P=process.nextTick;else if(Q=e.MutationObserver||e.WebKitMutationObserver)P=function(t,e,n){var i=t.createElement("div");return new e(n).observe(i,{attributes:!0}),function(){i.setAttribute("x","x")}}(document,Q,B);else try{P=Y("vertx").runOnLoop||Y("vertx").runOnContext}catch(L){P=function(t){q(t,0)}}return D=Function.prototype,N=D.call,C=D.bind?N.bind(N):function(t,e){return t.apply(e,W.call(arguments,2))},Z=[],W=Z.slice,z=Z.reduce||function(t){var e,n,i,r,o;if(o=0,e=Object(this),r=e.length>>>0,n=arguments,n.length<=1)for(;;){if(o in e){i=e[o++];break}if(++o>=r)throw new TypeError}else i=n[1];for(;r>o;++o)o in e&&(i=t(i,e[o],o,e));return i},n})}("function"==typeof n&&n.amd?n:function(t){module.exports=t(e)},this),function(){var t=this,e=t._,i={},r=Array.prototype,o=Object.prototype,u=Function.prototype,s=r.push,a=r.slice,c=r.concat,l=o.toString,f=o.hasOwnProperty,p=r.forEach,h=r.map,m=r.reduce,d=r.reduceRight,y=r.filter,v=r.every,g=r.some,x=r.indexOf,b=r.lastIndexOf,w=Array.isArray,_=Object.keys,V=u.bind,S=function(t){return t instanceof S?t:this instanceof S?(this._wrapped=t,void 0):new S(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=S),exports._=S):t._=S,S.VERSION="1.4.4";var I=S.each=S.forEach=function(t,e,n){if(null!=t)if(p&&t.forEach===p)t.forEach(e,n);else if(t.length===+t.length){for(var r=0,o=t.length;o>r;r++)if(e.call(n,t[r],r,t)===i)return}else for(var u in t)if(S.has(t,u)&&e.call(n,t[u],u,t)===i)return};S.map=S.collect=function(t,e,n){var i=[];return null==t?i:h&&t.map===h?t.map(e,n):(I(t,function(t,r,o){i[i.length]=e.call(n,t,r,o)}),i)};var T="Reduce of empty array with no initial value";S.reduce=S.foldl=S.inject=function(t,e,n,i){var r=arguments.length>2;if(null==t&&(t=[]),m&&t.reduce===m)return i&&(e=S.bind(e,i)),r?t.reduce(e,n):t.reduce(e);if(I(t,function(t,o,u){r?n=e.call(i,n,t,o,u):(n=t,r=!0)}),!r)throw new TypeError(T);return n},S.reduceRight=S.foldr=function(t,e,n,i){var r=arguments.length>2;if(null==t&&(t=[]),d&&t.reduceRight===d)return i&&(e=S.bind(e,i)),r?t.reduceRight(e,n):t.reduceRight(e);var o=t.length;if(o!==+o){var u=S.keys(t);o=u.length}if(I(t,function(s,a,c){a=u?u[--o]:--o,r?n=e.call(i,n,t[a],a,c):(n=t[a],r=!0)}),!r)throw new TypeError(T);return n},S.find=S.detect=function(t,e,n){var i;return A(t,function(t,r,o){return e.call(n,t,r,o)?(i=t,!0):void 0}),i},S.filter=S.select=function(t,e,n){var i=[];return null==t?i:y&&t.filter===y?t.filter(e,n):(I(t,function(t,r,o){e.call(n,t,r,o)&&(i[i.length]=t)}),i)},S.reject=function(t,e,n){return S.filter(t,function(t,i,r){return!e.call(n,t,i,r)},n)},S.every=S.all=function(t,e,n){e||(e=S.identity);var r=!0;return null==t?r:v&&t.every===v?t.every(e,n):(I(t,function(t,o,u){return(r=r&&e.call(n,t,o,u))?void 0:i}),!!r)};var A=S.some=S.any=function(t,e,n){e||(e=S.identity);var r=!1;return null==t?r:g&&t.some===g?t.some(e,n):(I(t,function(t,o,u){return r||(r=e.call(n,t,o,u))?i:void 0}),!!r)};S.contains=S.include=function(t,e){return null==t?!1:x&&t.indexOf===x?-1!=t.indexOf(e):A(t,function(t){return t===e})},S.invoke=function(t,e){var n=a.call(arguments,2),i=S.isFunction(e);return S.map(t,function(t){return(i?e:t[e]).apply(t,n)})},S.pluck=function(t,e){return S.map(t,function(t){return t[e]})},S.where=function(t,e,n){return S.isEmpty(e)?n?null:[]:S[n?"find":"filter"](t,function(t){for(var n in e)if(e[n]!==t[n])return!1;return!0})},S.findWhere=function(t,e){return S.where(t,e,!0)},S.max=function(t,e,n){if(!e&&S.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.max.apply(Math,t);if(!e&&S.isEmpty(t))return-1/0;var i={computed:-1/0,value:-1/0};return I(t,function(t,r,o){var u=e?e.call(n,t,r,o):t;u>=i.computed&&(i={value:t,computed:u})}),i.value},S.min=function(t,e,n){if(!e&&S.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.min.apply(Math,t);if(!e&&S.isEmpty(t))return 1/0;var i={computed:1/0,value:1/0};return I(t,function(t,r,o){var u=e?e.call(n,t,r,o):t;u<i.computed&&(i={value:t,computed:u})}),i.value},S.shuffle=function(t){var e,n=0,i=[];return I(t,function(t){e=S.random(n++),i[n-1]=i[e],i[e]=t}),i};var j=function(t){return S.isFunction(t)?t:function(e){return e[t]}};S.sortBy=function(t,e,n){var i=j(e);return S.pluck(S.map(t,function(t,e,r){return{value:t,index:e,criteria:i.call(n,t,e,r)}}).sort(function(t,e){var n=t.criteria,i=e.criteria;if(n!==i){if(n>i||void 0===n)return 1;if(i>n||void 0===i)return-1}return t.index<e.index?-1:1}),"value")};var R=function(t,e,n,i){var r={},o=j(e||S.identity);return I(t,function(e,u){var s=o.call(n,e,u,t);i(r,s,e)}),r};S.groupBy=function(t,e,n){return R(t,e,n,function(t,e,n){(S.has(t,e)?t[e]:t[e]=[]).push(n)})},S.countBy=function(t,e,n){return R(t,e,n,function(t,e){S.has(t,e)||(t[e]=0),t[e]++})},S.sortedIndex=function(t,e,n,i){n=null==n?S.identity:j(n);for(var r=n.call(i,e),o=0,u=t.length;u>o;){var s=o+u>>>1;n.call(i,t[s])<r?o=s+1:u=s}return o},S.toArray=function(t){return t?S.isArray(t)?a.call(t):t.length===+t.length?S.map(t,S.identity):S.values(t):[]},S.size=function(t){return null==t?0:t.length===+t.length?t.length:S.keys(t).length},S.first=S.head=S.take=function(t,e,n){return null==t?void 0:null==e||n?t[0]:a.call(t,0,e)},S.initial=function(t,e,n){return a.call(t,0,t.length-(null==e||n?1:e))},S.last=function(t,e,n){return null==t?void 0:null==e||n?t[t.length-1]:a.call(t,Math.max(t.length-e,0))},S.rest=S.tail=S.drop=function(t,e,n){return a.call(t,null==e||n?1:e)},S.compact=function(t){return S.filter(t,S.identity)};var O=function(t,e,n){return I(t,function(t){S.isArray(t)?e?s.apply(n,t):O(t,e,n):n.push(t)}),n};S.flatten=function(t,e){return O(t,e,[])},S.without=function(t){return S.difference(t,a.call(arguments,1))},S.uniq=S.unique=function(t,e,n,i){S.isFunction(e)&&(i=n,n=e,e=!1);var r=n?S.map(t,n,i):t,o=[],u=[];return I(r,function(n,i){(e?i&&u[u.length-1]===n:S.contains(u,n))||(u.push(n),o.push(t[i]))}),o},S.union=function(){return S.uniq(c.apply(r,arguments))},S.intersection=function(t){var e=a.call(arguments,1);return S.filter(S.uniq(t),function(t){return S.every(e,function(e){return S.indexOf(e,t)>=0})})},S.difference=function(t){var e=c.apply(r,a.call(arguments,1));return S.filter(t,function(t){return!S.contains(e,t)})},S.zip=function(){for(var t=a.call(arguments),e=S.max(S.pluck(t,"length")),n=new Array(e),i=0;e>i;i++)n[i]=S.pluck(t,""+i);return n},S.object=function(t,e){if(null==t)return{};for(var n={},i=0,r=t.length;r>i;i++)e?n[t[i]]=e[i]:n[t[i][0]]=t[i][1];return n},S.indexOf=function(t,e,n){if(null==t)return-1;var i=0,r=t.length;if(n){if("number"!=typeof n)return i=S.sortedIndex(t,e),t[i]===e?i:-1;i=0>n?Math.max(0,r+n):n}if(x&&t.indexOf===x)return t.indexOf(e,n);for(;r>i;i++)if(t[i]===e)return i;return-1},S.lastIndexOf=function(t,e,n){if(null==t)return-1;var i=null!=n;if(b&&t.lastIndexOf===b)return i?t.lastIndexOf(e,n):t.lastIndexOf(e);for(var r=i?n:t.length;r--;)if(t[r]===e)return r;return-1},S.range=function(t,e,n){arguments.length<=1&&(e=t||0,t=0),n=arguments[2]||1;for(var i=Math.max(Math.ceil((e-t)/n),0),r=0,o=new Array(i);i>r;)o[r++]=t,t+=n;return o},S.bind=function(t,e){if(t.bind===V&&V)return V.apply(t,a.call(arguments,1));var n=a.call(arguments,2);return function(){return t.apply(e,n.concat(a.call(arguments)))}},S.partial=function(t){var e=a.call(arguments,1);return function(){return t.apply(this,e.concat(a.call(arguments)))}},S.bindAll=function(t){var e=a.call(arguments,1);return 0===e.length&&(e=S.functions(t)),I(e,function(e){t[e]=S.bind(t[e],t)}),t},S.memoize=function(t,e){var n={};return e||(e=S.identity),function(){var i=e.apply(this,arguments);return S.has(n,i)?n[i]:n[i]=t.apply(this,arguments)}},S.delay=function(t,e){var n=a.call(arguments,2);return setTimeout(function(){return t.apply(null,n)},e)},S.defer=function(t){return S.delay.apply(S,[t,1].concat(a.call(arguments,1)))},S.throttle=function(t,e){var n,i,r,o,u=0,s=function(){u=new Date,r=null,o=t.apply(n,i)};return function(){var a=new Date,c=e-(a-u);return n=this,i=arguments,0>=c?(clearTimeout(r),r=null,u=a,o=t.apply(n,i)):r||(r=setTimeout(s,c)),o}},S.debounce=function(t,e,n){var i,r;return function(){var o=this,u=arguments,s=function(){i=null,n||(r=t.apply(o,u))},a=n&&!i;return clearTimeout(i),i=setTimeout(s,e),a&&(r=t.apply(o,u)),r}},S.once=function(t){var e,n=!1;return function(){return n?e:(n=!0,e=t.apply(this,arguments),t=null,e)}},S.wrap=function(t,e){return function(){var n=[t];return s.apply(n,arguments),e.apply(this,n)}},S.compose=function(){var t=arguments;return function(){for(var e=arguments,n=t.length-1;n>=0;n--)e=[t[n].apply(this,e)];return e[0]}},S.after=function(t,e){return 0>=t?e():function(){return--t<1?e.apply(this,arguments):void 0}},S.keys=_||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var n in t)S.has(t,n)&&(e[e.length]=n);return e},S.values=function(t){var e=[];for(var n in t)S.has(t,n)&&e.push(t[n]);return e},S.pairs=function(t){var e=[];for(var n in t)S.has(t,n)&&e.push([n,t[n]]);return e},S.invert=function(t){var e={};for(var n in t)S.has(t,n)&&(e[t[n]]=n);return e},S.functions=S.methods=function(t){var e=[];for(var n in t)S.isFunction(t[n])&&e.push(n);return e.sort()},S.extend=function(t){return I(a.call(arguments,1),function(e){if(e)for(var n in e)t[n]=e[n]}),t},S.pick=function(t){var e={},n=c.apply(r,a.call(arguments,1));return I(n,function(n){n in t&&(e[n]=t[n])}),e},S.omit=function(t){var e={},n=c.apply(r,a.call(arguments,1));for(var i in t)S.contains(n,i)||(e[i]=t[i]);return e},S.defaults=function(t){return I(a.call(arguments,1),function(e){if(e)for(var n in e)null==t[n]&&(t[n]=e[n])}),t},S.clone=function(t){return S.isObject(t)?S.isArray(t)?t.slice():S.extend({},t):t},S.tap=function(t,e){return e(t),t};var k=function(t,e,n,i){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof S&&(t=t._wrapped),e instanceof S&&(e=e._wrapped);var r=l.call(t);if(r!=l.call(e))return!1;switch(r){case"[object String]":return t==String(e);case"[object Number]":return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if("object"!=typeof t||"object"!=typeof e)return!1;for(var o=n.length;o--;)if(n[o]==t)return i[o]==e;n.push(t),i.push(e);var u=0,s=!0;if("[object Array]"==r){if(u=t.length,s=u==e.length)for(;u--&&(s=k(t[u],e[u],n,i)););}else{var a=t.constructor,c=e.constructor;if(a!==c&&!(S.isFunction(a)&&a instanceof a&&S.isFunction(c)&&c instanceof c))return!1;for(var f in t)if(S.has(t,f)&&(u++,!(s=S.has(e,f)&&k(t[f],e[f],n,i))))break;if(s){for(f in e)if(S.has(e,f)&&!u--)break;s=!u}}return n.pop(),i.pop(),s};S.isEqual=function(t,e){return k(t,e,[],[])},S.isEmpty=function(t){if(null==t)return!0;if(S.isArray(t)||S.isString(t))return 0===t.length;for(var e in t)if(S.has(t,e))return!1;return!0},S.isElement=function(t){return!(!t||1!==t.nodeType)},S.isArray=w||function(t){return"[object Array]"==l.call(t)},S.isObject=function(t){return t===Object(t)},I(["Arguments","Function","String","Number","Date","RegExp"],function(t){S["is"+t]=function(e){return l.call(e)=="[object "+t+"]"}}),S.isArguments(arguments)||(S.isArguments=function(t){return!(!t||!S.has(t,"callee"))}),"function"!=typeof/./&&(S.isFunction=function(t){return"function"==typeof t}),S.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},S.isNaN=function(t){return S.isNumber(t)&&t!=+t},S.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==l.call(t)},S.isNull=function(t){return null===t},S.isUndefined=function(t){return void 0===t},S.has=function(t,e){return f.call(t,e)},S.noConflict=function(){return t._=e,this},S.identity=function(t){return t},S.times=function(t,e,n){for(var i=Array(t),r=0;t>r;r++)i[r]=e.call(n,r);return i},S.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))};var E={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};E.unescape=S.invert(E.escape);var B={escape:new RegExp("["+S.keys(E.escape).join("")+"]","g"),unescape:new RegExp("("+S.keys(E.unescape).join("|")+")","g")};S.each(["escape","unescape"],function(t){S[t]=function(e){return null==e?"":(""+e).replace(B[t],function(e){return E[t][e]})}}),S.result=function(t,e){if(null==t)return null;var n=t[e];return S.isFunction(n)?n.call(t):n},S.mixin=function(t){I(S.functions(t),function(e){var n=S[e]=t[e];S.prototype[e]=function(){var t=[this._wrapped];return s.apply(t,arguments),P.call(this,n.apply(S,t))}})};var F=0;S.uniqueId=function(t){var e=++F+"";return t?t+e:e},S.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var z=/(.)^/,W={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},C=/\\|'|\r|\n|\t|\u2028|\u2029/g;S.template=function(t,e,n){var i;n=S.defaults({},n,S.templateSettings);var r=new RegExp([(n.escape||z).source,(n.interpolate||z).source,(n.evaluate||z).source].join("|")+"|$","g"),o=0,u="__p+='";t.replace(r,function(e,n,i,r,s){return u+=t.slice(o,s).replace(C,function(t){return"\\"+W[t]}),n&&(u+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),i&&(u+="'+\n((__t=("+i+"))==null?'':__t)+\n'"),r&&(u+="';\n"+r+"\n__p+='"),o=s+e.length,e}),u+="';\n",n.variable||(u="with(obj||{}){\n"+u+"}\n"),u="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+u+"return __p;\n";try{i=new Function(n.variable||"obj","_",u)}catch(s){throw s.source=u,s}if(e)return i(e,S);var a=function(t){return i.call(this,t,S)};return a.source="function("+(n.variable||"obj")+"){\n"+u+"}",a},S.chain=function(t){return S(t).chain()};var P=function(t){return this._chain?S(t).chain():t};S.mixin(S),I(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=r[t];S.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!=t&&"splice"!=t||0!==n.length||delete n[0],P.call(this,n)}}),I(["concat","join","slice"],function(t){var e=r[t];S.prototype[t]=function(){return P.call(this,e.apply(this._wrapped,arguments))}}),S.extend(S.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof n&&n.amd&&n("underscore",[],function(){return S})}.call(this),n("ammo_worker_api",[],function(){function t(t){this.maxBodies=1e3,this.maxVehicles=32,this.maxWheelsPerVehicle=8;for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e])}return t.prototype={init:function(){importScripts("./js/ammo.js"),this.tmpVec=[new Ammo.btVector3,new Ammo.btVector3,new Ammo.btVector3],this.tmpQuaternion=[new Ammo.btQuaternion],this.tmpTrans=[new Ammo.btTransform],this.bodies=[],this.vehicles=[],this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.fire("ready")},startSimulation:function(){var t,e=this,n=0,i=0,r=1,o=8*7*this.maxBodies+8*7*this.maxVehicles*this.maxWheelsPerVehicle;this.buffers=[new ArrayBuffer(o),new ArrayBuffer(o),new ArrayBuffer(o)],t=Date.now(),this.simulationTimerId=setInterval(function(){var o,u,s,a,c,l=Date.now(),f=l-t||1;e.dynamicsWorld.stepSimulation(e.step,e.iterations);var p;p=n>0?Math.min(.1,f/1e3):.1,n=p*f+(1-p)*n;var h=1/r++;if(i=h*f+(1-h)*i,t=Date.now(),e.buffers.length>0&&(u=new Float64Array(e.buffers.pop())),u&&u.buffer instanceof ArrayBuffer){for(s in e.bodies)e.bodies[s]&&(e.tmpTrans[0].setIdentity(),e.bodies[s].getMotionState().getWorldTransform(e.tmpTrans[0]),u[7*s+0]=e.tmpTrans[0].getOrigin().x(),u[7*s+1]=e.tmpTrans[0].getOrigin().y(),u[7*s+2]=e.tmpTrans[0].getOrigin().z(),u[7*s+3]=e.tmpTrans[0].getRotation().x(),u[7*s+4]=e.tmpTrans[0].getRotation().y(),u[7*s+5]=e.tmpTrans[0].getRotation().z(),u[7*s+6]=e.tmpTrans[0].getRotation().w());for(s in e.vehicles)if(e.vehicles[s])for(o=e.vehicles[s],a=0;a<o.getNumWheels()+1;a++)e.tmpTrans[0]=o.getWheelInfo(a).get_m_worldTransform(),c=7*e.maxBodies+7*s*e.maxWheelsPerVehicle+7*a,u[c+0]=e.tmpTrans[0].getOrigin().x(),u[c+1]=e.tmpTrans[0].getOrigin().y(),u[c+2]=e.tmpTrans[0].getOrigin().z(),u[c+3]=e.tmpTrans[0].getRotation().x(),u[c+4]=e.tmpTrans[0].getRotation().y(),u[c+5]=e.tmpTrans[0].getRotation().z(),u[c+6]=e.tmpTrans[0].getRotation().w();e.fire("update",u.buffer,[u.buffer]),e.fire("stats",{currFPS:Math.round(1e3/n),allFPS:Math.round(1e3/i)})}},1e3*this.step)},stopSimulation:function(){this.simulationTimerId&&clearInterval(this.simulationTimerId)},swap:function(t){t instanceof ArrayBuffer&&this.buffers.push(t)},setStep:function(t){this.step=t},setIterations:function(t){this.iterations=t},setGravity:function(t){this.tmpVec[0].setX(t.x),this.tmpVec[0].setY(t.y),this.tmpVec[0].setZ(t.z),this.dynamicsWorld.setGravity(this.tmpVec[0])},_createCompoundShape:function(t){var e,n,i=new Ammo.btCompoundShape,r=this.tmpTrans[0];if(t.children&&t.children.length)for(var o in t.children)t.children.hasOwnProperty(o)&&(e=t.children[o],n=this._createShape(e),r.setIdentity(),this.tmpVec[0].setX(e.localTransform.position.x),this.tmpVec[0].setY(e.localTransform.position.y),this.tmpVec[0].setZ(e.localTransform.position.z),r.setOrigin(this.tmpVec[0]),this.tmpQuaternion[0].setX(e.localTransform.rotation.x),this.tmpQuaternion[0].setY(e.localTransform.rotation.y),this.tmpQuaternion[0].setZ(e.localTransform.rotation.z),this.tmpQuaternion[0].setW(e.localTransform.rotation.w),r.setRotation(this.tmpQuaternion[0]),i.addChildShape(r,n));return i},_createShape:function(t){var e;switch(t.shape){case"box":this.tmpVec[0].setX(t.halfExtents.x),this.tmpVec[0].setY(t.halfExtents.y),this.tmpVec[0].setZ(t.halfExtents.z),e=new Ammo.btBoxShape(this.tmpVec[0]);break;case"sphere":e=new Ammo.btSphereShape(t.radius);break;case"staticplane":this.tmpVec[0].setX(t.normal.x),this.tmpVec[0].setY(t.normal.y),this.tmpVec[0].setZ(t.normal.z),e=new Ammo.btStaticPlaneShape(this.tmpVec[0],t.distance);break;case"cylinder":this.tmpVec[0].setX(t.width),this.tmpVec[0].setY(t.height),this.tmpVec[0].setZ(t.depth),e=new Ammo.btCylinderShape(this.tmpVec[0]);break;case"capsule":e=new Ammo.btCapsuleShape(t.radius,t.height);break;case"cone":e=new Ammo.btConeShape(t.radius,t.height);break;case"compound":e=this._createCompoundShape(t);break;default:return console.error("Unknown shape: "+t.shape)}return e},Vehicle_create:function(t,e){var n,i=new Ammo.btVehicleTuning,r=this.bodies[t.bodyId];if(!r)return console.error("could not find body");t.tuning&&(t.tuning.suspensionStiffness&&i.set_m_suspensionStiffness(t.tuning.suspensionStiffness),t.tuning.suspensionCompression&&i.set_m_suspensionCompression(t.tuning.suspensionCompression),t.tuning.suspensionDamping&&i.set_m_suspensionDamping(t.tuning.suspensionDamping),t.tuning.maxSuspensionTravelCm&&i.set_m_maxSuspensionTravelCm(t.tuning.maxSuspensionTravelCm),t.tuning.maxSuspensionForce&&i.set_m_maxSuspensionForce(t.tuning.maxSuspensionForce),t.tuning.frictionSlip&&i.set_m_frictionSlip(t.tuning.frictionSlip)),n=new Ammo.btRaycastVehicle(i,r,new Ammo.btDefaultVehicleRaycaster(this.dynamicsWorld)),n.tuning=i,r.setActivationState(4),n.setCoordinateSystem(0,1,2),this.dynamicsWorld.addVehicle(n);var o=this.vehicles.push(n)-1;"function"==typeof e&&e(o)},Vehicle_destroy:function(t){this.dynamicsWorld.removeVehicle(this.vehicles[t]),this.vehicles[t]=void 0},Vehicle_addWheel:function(t,e){var n=this.vehicles[t.vehicleId];if(void 0!==n){var i=n.tuning,r=this.tmpVec[0],o=this.tmpVec[1],u=this.tmpVec[2];"object"==typeof t.tuning&&(i=new Ammo.btVehicleTuning,t.tuning.suspensionStiffness&&i.set_m_suspensionStiffness(t.tuning.suspensionStiffness),t.tuning.suspensionCompression&&i.set_m_suspensionCompression(t.tuning.suspensionCompression),t.tuning.suspensionDamping&&i.set_m_suspensionDamping(t.tuning.suspensionDamping),t.tuning.maxSuspensionTravelCm&&i.set_m_maxSuspensionTravelCm(t.tuning.maxSuspensionTravelCm),t.tuning.maxSuspensionForce&&i.set_m_maxSuspensionForce(t.tuning.maxSuspensionForce),t.tuning.frictionSlip&&i.set_m_frictionSlip(t.tuning.frictionSlip)),r.setX(t.connectionPoint.x),r.setY(t.connectionPoint.y),r.setZ(t.connectionPoint.z),o.setX(t.wheelDirection.x),o.setY(t.wheelDirection.y),o.setZ(t.wheelDirection.z),u.setX(t.wheelAxle.x),u.setY(t.wheelAxle.y),u.setZ(t.wheelAxle.z),n.addWheel(r,o,u,t.suspensionRestLength,t.wheelRadius,i,t.isFrontWheel),"function"==typeof e&&e(n.getNumWheels()-1)}},Vehicle_setSteeringValue:function(t){var e=this.vehicles[t.vehicleId];e&&this.vehicles[t.vehicleId].setSteeringValue(t.steeringValue,t.wheelIndex)},Vehicle_setBrake:function(t){var e=this.vehicles[t.vehicleId];e&&this.vehicles[t.vehicleId].setBrake(t.brake,t.wheelIndex)},Vehicle_setWheelInfo:function(t){var e,n=this.vehicles[t.vehicleId];if(n){e=this.vehicles[t.vehicleId].getWheelInfo(t.wheelIndex);for(var i in t.properties)t.properties.hasOwnProperty(i)&&e["set_m_"+i](t.properties[i])}},Vehicle_applyEngineForce:function(t){var e=this.vehicles[t.vehicleId];e&&this.vehicles[t.vehicleId].applyEngineForce(t.force,t.wheelIndex)},RigidBody_create:function(t,e){var n,i,r,o,u=this.tmpTrans[0],s=0!==t.mass,a=this.tmpVec[0],c=this.tmpVec[1],l=this.tmpQuaternion[0];u.setIdentity(),a.setZero(),n=this._createShape(t.shape),s&&n.calculateLocalInertia(t.mass,a),c.setX(t.position.x),c.setY(t.position.y),c.setZ(t.position.z),l.setX(t.quaternion.x),l.setY(t.quaternion.y),l.setZ(t.quaternion.z),l.setW(t.quaternion.w),u.setOrigin(c),u.setRotation(l),i=new Ammo.btDefaultMotionState(u),r=new Ammo.btRigidBodyConstructionInfo(t.mass,i,n,a),o=new Ammo.btRigidBody(r),this.dynamicsWorld.addRigidBody(o);var f=this.bodies.push(o)-1;"function"==typeof e&&e(f)},RigidBody_applyForce:function(t,e){var n=this.bodies[t.bodyId];n&&(this.tmpVec[0].setX(t.force.x),this.tmpVec[0].setY(t.force.y),this.tmpVec[0].setZ(t.force.z),this.tmpVec[1].setX(t.relativePosition.x),this.tmpVec[1].setY(t.relativePosition.y),this.tmpVec[1].setZ(t.relativePosition.z),n.applyForce(this.tmpVec[0],this.tmpVec[1])),"function"==typeof e&&e()},RigidBody_setRestitution:function(t,e){var n=this.bodies[t.bodyId];n&&n.setRestitution(t.restitution),"function"==typeof e&&e()},RigidBody_setFriction:function(t,e){var n=this.bodies[t.bodyId];n&&n.setFriction(t.friction),"function"==typeof e&&e()},RigidBody_destroy:function(t){this.dynamicsWorld.removeRigidBody(this.bodies[t]),Ammo.destroy(this.bodies[t]),this.bodies[t]=void 0},shutdown:function(){Ammo.destroy(this.collisionConfiguration),Ammo.destroy(this.dispatcher),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.solver)}},t}),n("ammo_rigid_body",[],function(){function t(t,e){this.proxy=t,this.bodyId=e,this.object=void 0}return t.prototype.update=function(){var t,e,n,i=this.proxy.data;this.object&&i&&(n=this.proxy.getRigidBodyOffset(this.bodyId),t=this.object.position,e=this.object.quaternion,t.x=i[n+0],t.y=i[n+1],t.z=i[n+2],e.x=i[n+3],e.y=i[n+4],e.z=i[n+5],e.w=i[n+6])},t.prototype.applyForce=function(t,e){return this.proxy.execute("RigidBody_applyForce",{bodyId:this.bodyId,force:t,relativePosition:e})},t.prototype.setFriction=function(t){return this.proxy.execute("RigidBody_setFriction",{bodyId:this.bodyId,friction:t})},t.prototype.setRestitution=function(t){return this.proxy.execute("RigidBody_setRestitution",{bodyId:this.bodyId,restitution:t})},t.prototype.destroy=function(){return this.proxy.execute("RigidBody_destroy",{bodyId:this.bodyId})},t.prototype.setObject=function(t){this.object=t},t}),n("ammo_vehicle",[],function(){function t(t,e){this.proxy=t,this.vehicleId=e,this.wheelObjects=[]}return t.prototype.addWheel=function(t,e,n,i,r,o,u){var s={vehicleId:this.vehicleId,connectionPoint:t,wheelDirection:e,wheelAxle:n,suspensionRestLength:i,wheelRadius:r,isFrontWheel:o,tuning:u};return this.proxy.execute("Vehicle_addWheel",s)},t.prototype.setWheelInfo=function(t,e){var n={vehicleId:this.vehicleId,wheelIndex:t,properties:e};return this.proxy.execute("Vehicle_setWheelInfo",n)},t.prototype.setBrake=function(t,e){var n={vehicleId:this.vehicleId,wheelIndex:t,brake:e};return this.proxy.execute("Vehicle_setBrake",n)},t.prototype.applyEngineForce=function(t,e){var n={vehicleId:this.vehicleId,wheelIndex:t,force:e};return this.proxy.execute("Vehicle_applyEngineForce",n)},t.prototype.setSteeringValue=function(t,e){var n={vehicleId:this.vehicleId,wheelIndex:t,steeringValue:e};return this.proxy.execute("Vehicle_setSteeringValue",n)},t.prototype.destroy=function(){var t={vehicleId:this.vehicleId};return this.proxy.execute("Vehicle_destroy",t)},t.prototype.addWheelObject=function(t,e){this.wheelObjects[t]=e},t.prototype.update=function(){for(var t in this.wheelObjects)this.wheelObjects.hasOwnProperty(t)&&this._updateWheel(this.wheelObjects[t],t)},t.prototype._updateWheel=function(t,e){var n,i,r,o=this.proxy.data;o&&(r=this.proxy.getWheelOffset(this.vehicleId,e),n=t.position,i=t.quaternion,n.x=o[r+0],n.y=o[r+1],n.z=o[r+2],i.x=o[r+3],i.y=o[r+4],i.z=o[r+5],i.w=o[r+6])},t}),n("ammo_proxy",["when","underscore","ammo_worker_api","ammo_rigid_body","ammo_vehicle"],function(t,e,n,i,r){function o(t){function i(t){o[t]=function(){return o.worker[t].apply(o.worker,arguments)}}var r,o=this,u=["on","fire","setStep","setIterations","setGravity","startSimulation","stopSimulation"];
t=this.opts=t||{},t.gravity=t.gravity||{x:0,y:-9.82,z:0},t.iterations=t.iterations||10,t.step=t.step||1/60,t.maxBodies=t.maxBodies||1e3,t.maxVehicles=t.maxVehicles||32,t.maxWheelsPerVehicle=t.maxWheelsPerVehicle||8,this.worker=cw(new n(t)),this.worker.on("update",e.bind(this.update,this)),this.worker.on("error",function(t){console.warn(t.message)});for(r in u)u.hasOwnProperty(r)&&i(u[r]);this.setStep(t.step),this.setIterations(t.iterations),this.setGravity(t.gravity)}return o.prototype.execute=function(t,e){return this.worker[t](e)},o.prototype.addVehicle=function(n){var i=t.defer();return this.worker.Vehicle_create(n).then(e.bind(function(t){var e=this;setTimeout(function(){i.resolve(new r(e,t))},0)},this)),i.promise},o.prototype.addRigidBody=function(n){var r=t.defer();return this.worker.RigidBody_create(n).then(e.bind(function(t){var e=this;setTimeout(function(){r.resolve(new i(e,t))},0)},this)),r.promise},o.prototype.update=function(t){this.next&&(this.worker.swap(this.data&&this.data.buffer),this.data=this.next),this.next=new Float64Array(t)},o.prototype.addRigidBodyObject=function(t,e,n){n||(n=this.getShapeJSON(t));var i={mass:e,shape:n,position:{x:t.position.x,y:t.position.y,z:t.position.z},quaternion:{x:t.quaternion.x,y:t.quaternion.y,z:t.quaternion.z,w:t.quaternion.w}};return this.addRigidBody(i)},o.prototype.getRigidBodyOffset=function(t){return 7*t},o.prototype.getWheelOffset=function(t,e){return 7*this.opts.maxBodies+7*8*t+7*e},o.prototype.getShapeJSON=function(t){var e=new THREE.Matrix4,n=new THREE.Matrix4,i={shape:"compound",children:[]};return e.getInverse(t.matrixWorld),t.traverse(function(t){if(t instanceof THREE.Mesh){var r,o,u,s=new THREE.Vector3,a=new THREE.Vector3,c=new THREE.Quaternion,l=t.matrixWorld.clone(),f=new THREE.Vector3;n.copy(e),n.multiply(l),a.getPositionFromMatrix(n),f.getScaleFromMatrix(l),n.extractRotation(n),c.setFromRotationMatrix(n),t.geometry.computeBoundingBox(),r=t.geometry.boundingBox.min.clone(),o=t.geometry.boundingBox.max.clone(),s.subVectors(o,r),s.multiplyScalar(.5),s.multiplyVectors(s,f),u=s;var p=new THREE.Vector3;p.x=(r.x+o.x)/2,p.y=(r.y+o.y)/2,p.z=(r.z+o.z)/2,p.multiplyVectors(p,f),i.children.push({shape:"box",halfExtents:{x:u.x,y:u.y,z:u.z},localTransform:{position:{x:a.x,y:a.y,z:a.z},rotation:{x:c.x,y:c.y,z:c.z,w:c.w}}})}}),i},o}),e("ammo_proxy")});