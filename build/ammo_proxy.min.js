/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/** @license MIT License (c) copyright 2011-2013 original author or authors */

/**
 * A lightweight CommonJS Promises/A and when() implementation
 * when is part of the cujo.js family of libraries (http://cujojs.com/)
 *
 * Licensed under the MIT License at:
 * http://www.opensource.org/licenses/mit-license.php
 *
 * @author Brian Cavalier
 * @author John Hann
 * @version 2.5.1
 */

//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud Inc.

//     Underscore may be freely distributed under the MIT license.

!function(t,e){"function"==typeof define&&define.amd?define(e):t.AmmoProxy=e()}(this,function(){var t,e,i;return function(n){function r(t,e){return b.call(t,e)}function o(t,e){var i,n,r,o,s,a,c,u,l,h,p=e&&e.split("/"),f=v.map,d=f&&f["*"]||{};if(t&&"."===t.charAt(0))if(e){for(p=p.slice(0,p.length-1),t=p.concat(t.split("/")),u=0;u<t.length;u+=1)if(h=t[u],"."===h)t.splice(u,1),u-=1;else if(".."===h){if(1===u&&(".."===t[2]||".."===t[0]))break;u>0&&(t.splice(u-1,2),u-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((p||d)&&f){for(i=t.split("/"),u=i.length;u>0;u-=1){if(n=i.slice(0,u).join("/"),p)for(l=p.length;l>0;l-=1)if(r=f[p.slice(0,l).join("/")],r&&(r=r[n])){o=r,s=u;break}if(o)break;!a&&d&&d[n]&&(a=d[n],c=u)}!o&&a&&(o=a,s=c),o&&(i.splice(0,s,o),t=i.join("/"))}return t}function s(t,e){return function(){return f.apply(n,_.call(arguments,0).concat([t,e]))}}function a(t){return function(e){return o(e,t)}}function c(t){return function(e){y[t]=e}}function u(t){if(r(g,t)){var e=g[t];delete g[t],x[t]=!0,p.apply(n,e)}if(!r(y,t)&&!r(x,t))throw new Error("No "+t);return y[t]}function l(t){var e,i=t?t.indexOf("!"):-1;return i>-1&&(e=t.substring(0,i),t=t.substring(i+1,t.length)),[e,t]}function h(t){return function(){return v&&v.config&&v.config[t]||{}}}var p,f,d,m,y={},g={},v={},x={},b=Object.prototype.hasOwnProperty,_=[].slice;d=function(t,e){var i,n=l(t),r=n[0];return t=n[1],r&&(r=o(r,e),i=u(r)),r?t=i&&i.normalize?i.normalize(t,a(e)):o(t,e):(t=o(t,e),n=l(t),r=n[0],t=n[1],r&&(i=u(r))),{f:r?r+"!"+t:t,n:t,pr:r,p:i}},m={require:function(t){return s(t)},exports:function(t){var e=y[t];return"undefined"!=typeof e?e:y[t]={}},module:function(t){return{id:t,uri:"",exports:y[t],config:h(t)}}},p=function(t,e,i,o){var a,l,h,p,f,v,b=[];if(o=o||t,"function"==typeof i){for(e=!e.length&&i.length?["require","exports","module"]:e,f=0;f<e.length;f+=1)if(p=d(e[f],o),l=p.f,"require"===l)b[f]=m.require(t);else if("exports"===l)b[f]=m.exports(t),v=!0;else if("module"===l)a=b[f]=m.module(t);else if(r(y,l)||r(g,l)||r(x,l))b[f]=u(l);else{if(!p.p)throw new Error(t+" missing "+l);p.p.load(p.n,s(o,!0),c(l),{}),b[f]=y[l]}h=i.apply(y[t],b),t&&(a&&a.exports!==n&&a.exports!==y[t]?y[t]=a.exports:h===n&&v||(y[t]=h))}else t&&(y[t]=i)},t=e=f=function(t,e,i,r,o){return"string"==typeof t?m[t]?m[t](e):u(d(t,e).f):(t.splice||(v=t,e.splice?(t=e,e=i,i=null):t=n),e=e||function(){},"function"==typeof i&&(i=r,r=o),r?p(n,t,e,i):setTimeout(function(){p(n,t,e,i)},4),f)},f.config=function(t){return v=t,v.deps&&f(v.deps,v.callback),f},i=function(t,e,i){e.splice||(i=e,e=[]),r(y,t)||r(g,t)||(g[t]=[t,e,i])},i.amd={jQuery:!0}}(),i("vendor/almond",function(){}),function(t,e){t("when",["require"],function(t){function i(t,e,i,r){return n(t).then(e,i,r)}function n(t){return t instanceof r?t:o(t)}function r(t,e){this._message=t,this.inspect=e}function o(t){return c(function(e){e(t)})}function s(t){return i(t,p)}function a(){function t(t,r,s){e.resolve=e.resolver.resolve=function(e){return n?o(e):(n=!0,t(e),i)},e.reject=e.resolver.reject=function(t){return n?o(p(t)):(n=!0,r(t),i)},e.notify=e.resolver.notify=function(t){return s(t),t}}var e,i,n;return e={promise:G,resolve:G,reject:G,notify:G,resolver:{resolve:G,reject:G,notify:G}},e.promise=i=c(t),e}function c(t){return u(t,X.PromiseStatus&&X.PromiseStatus())}function u(t,e){function i(t,e,i,n){function r(r){r._message(t,e,i,n)}h?h.push(r):R(function(){r(u)})}function n(){return u?u.inspect():z()}function o(t){if(h){var i=h;h=G,R(function(){u=m(c,t),e&&x(u,e),l(i,u)})}}function s(t){o(p(t))}function a(t){if(h){var e=h;R(function(){l(e,d(t))})}}var c,u,h=[];c=new r(i,n),c._status=e;try{t(o,s,a)}catch(f){s(f)}return c}function l(t,e){for(var i=0;i<t.length;i++)t[i](e)}function h(t){return f(new g(t),function(){return S(t)})}function p(t){return f(new v(t),function(){return F(t)})}function f(t,e){return new r(function(e,i,n){try{n(t[e].apply(t,i))}catch(r){n(p(r))}},e)}function d(t){return new r(function(e,i,n,r){var o=i[2];try{r("function"==typeof o?o(t):t)}catch(s){r(s)}})}function m(t,e){if(e===t)return p(new TypeError);if(e instanceof r)return e;try{var i=e===Object(e)&&e.then;return"function"==typeof i?y(i,e):h(e)}catch(n){return p(n)}}function y(t,e){return c(function(i,n){W(t,e,i,n)})}function g(t){this.value=t}function v(t){this.reason=t}function x(t,e){function i(){e.fulfilled()}function n(t){e.rejected(t)}t.then(i,n)}function b(t){return t&&"function"==typeof t.then}function _(t,e,n,r,o){return i(t,function(t){function s(n,r,o){function s(t){f(t)}function a(t){p(t)}var c,u,l,h,p,f,d,m;if(d=t.length>>>0,c=Math.max(0,Math.min(e,d)),l=[],u=d-c+1,h=[],c)for(f=function(t){h.push(t),--u||(p=f=O,r(h))},p=function(t){l.push(t),--c||(p=f=O,n(l))},m=0;d>m;++m)m in t&&i(t[m],a,s,o);else n(l)}return c(s).then(n,r,o)})}function I(t,e,i,n){function r(t){return e?e(t[0]):t[0]}return _(t,1,r,i,n)}function C(t,e,i,n){return A(t,O).then(e,i,n)}function w(){return A(arguments,O)}function V(t){return A(t,S,F)}function T(t,e){return A(t,e)}function A(t,e,n){return i(t,function(t){function r(r,o,s){function a(t,a){i(t,e,n).then(function(t){c[a]=t,--l||r(c)},o,s)}var c,u,l,h;if(l=u=t.length>>>0,c=[],!l)return r(c),void 0;for(h=0;u>h;h++)h in t?a(t[h],h):--l}return u(r)})}function B(t,e){var n=W(j,arguments,1);return i(t,function(t){var r;return r=t.length,n[0]=function(t,n,o){return i(t,function(t){return i(n,function(i){return e(t,i,o,r)})})},k.apply(t,n)})}function S(t){return{state:"fulfilled",value:t}}function F(t){return{state:"rejected",reason:t}}function z(){return{state:"pending"}}function R(t){1===L.push(t)&&M(E)}function E(){l(L),L=[]}function O(t){return t}i.promise=c,i.resolve=o,i.reject=s,i.defer=a,i.join=w,i.all=C,i.map=T,i.reduce=B,i.settle=V,i.any=I,i.some=_,i.isPromise=b,i.isPromiseLike=b,r.prototype={then:function(){var t,e;return t=arguments,e=this._message,u(function(i,n,r){e("when",t,i,r)},this._status&&this._status.observed())},otherwise:function(t){return this.then(G,t)},ensure:function(t){function e(){return o(t())}return"function"==typeof t?this.then(e,e).yield(this):this},yield:function(t){return this.then(function(){return t})},tap:function(t){return this.then(t).yield(this)},spread:function(t){return this.then(function(e){return C(e,function(e){return t.apply(G,e)})})},always:function(t,e){return this.then(t,t,e)}},g.prototype.when=function(t){return"function"==typeof t?t(this.value):this.value},v.prototype.when=function(t,e){if("function"==typeof e)return e(this.reason);throw this.reason};var k,j,W,M,L,D,P,H,Y,X,Z,q,G;if(Z=t,L=[],D=e.setTimeout,X="undefined"!=typeof console?console:i,"object"==typeof process&&process.nextTick)M=process.nextTick;else if(q=e.MutationObserver||e.WebKitMutationObserver)M=function(t,e,i){var n=t.createElement("div");return new e(i).observe(n,{attributes:!0}),function(){n.setAttribute("x","x")}}(document,q,E);else try{M=Z("vertx").runOnLoop||Z("vertx").runOnContext}catch(K){M=function(t){D(t,0)}}return P=Function.prototype,H=P.call,W=P.bind?H.bind(H):function(t,e){return t.apply(e,j.call(arguments,2))},Y=[],j=Y.slice,k=Y.reduce||function(t){var e,i,n,r,o;if(o=0,e=Object(this),r=e.length>>>0,i=arguments,i.length<=1)for(;;){if(o in e){n=e[o++];break}if(++o>=r)throw new TypeError}else n=i[1];for(;r>o;++o)o in e&&(n=t(n,e[o],o,e));return n},i})}("function"==typeof i&&i.amd?i:function(t){module.exports=t(e)},this),function(){var t=this,e=t._,n={},r=Array.prototype,o=Object.prototype,s=Function.prototype,a=r.push,c=r.slice,u=r.concat,l=o.toString,h=o.hasOwnProperty,p=r.forEach,f=r.map,d=r.reduce,m=r.reduceRight,y=r.filter,g=r.every,v=r.some,x=r.indexOf,b=r.lastIndexOf,_=Array.isArray,I=Object.keys,C=s.bind,w=function(t){return t instanceof w?t:this instanceof w?(this._wrapped=t,void 0):new w(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=w),exports._=w):t._=w,w.VERSION="1.4.4";var V=w.each=w.forEach=function(t,e,i){if(null!=t)if(p&&t.forEach===p)t.forEach(e,i);else if(t.length===+t.length){for(var r=0,o=t.length;o>r;r++)if(e.call(i,t[r],r,t)===n)return}else for(var s in t)if(w.has(t,s)&&e.call(i,t[s],s,t)===n)return};w.map=w.collect=function(t,e,i){var n=[];return null==t?n:f&&t.map===f?t.map(e,i):(V(t,function(t,r,o){n[n.length]=e.call(i,t,r,o)}),n)};var T="Reduce of empty array with no initial value";w.reduce=w.foldl=w.inject=function(t,e,i,n){var r=arguments.length>2;if(null==t&&(t=[]),d&&t.reduce===d)return n&&(e=w.bind(e,n)),r?t.reduce(e,i):t.reduce(e);if(V(t,function(t,o,s){r?i=e.call(n,i,t,o,s):(i=t,r=!0)}),!r)throw new TypeError(T);return i},w.reduceRight=w.foldr=function(t,e,i,n){var r=arguments.length>2;if(null==t&&(t=[]),m&&t.reduceRight===m)return n&&(e=w.bind(e,n)),r?t.reduceRight(e,i):t.reduceRight(e);var o=t.length;if(o!==+o){var s=w.keys(t);o=s.length}if(V(t,function(a,c,u){c=s?s[--o]:--o,r?i=e.call(n,i,t[c],c,u):(i=t[c],r=!0)}),!r)throw new TypeError(T);return i},w.find=w.detect=function(t,e,i){var n;return A(t,function(t,r,o){return e.call(i,t,r,o)?(n=t,!0):void 0}),n},w.filter=w.select=function(t,e,i){var n=[];return null==t?n:y&&t.filter===y?t.filter(e,i):(V(t,function(t,r,o){e.call(i,t,r,o)&&(n[n.length]=t)}),n)},w.reject=function(t,e,i){return w.filter(t,function(t,n,r){return!e.call(i,t,n,r)},i)},w.every=w.all=function(t,e,i){e||(e=w.identity);var r=!0;return null==t?r:g&&t.every===g?t.every(e,i):(V(t,function(t,o,s){return(r=r&&e.call(i,t,o,s))?void 0:n}),!!r)};var A=w.some=w.any=function(t,e,i){e||(e=w.identity);var r=!1;return null==t?r:v&&t.some===v?t.some(e,i):(V(t,function(t,o,s){return r||(r=e.call(i,t,o,s))?n:void 0}),!!r)};w.contains=w.include=function(t,e){return null==t?!1:x&&t.indexOf===x?-1!=t.indexOf(e):A(t,function(t){return t===e})},w.invoke=function(t,e){var i=c.call(arguments,2),n=w.isFunction(e);return w.map(t,function(t){return(n?e:t[e]).apply(t,i)})},w.pluck=function(t,e){return w.map(t,function(t){return t[e]})},w.where=function(t,e,i){return w.isEmpty(e)?i?null:[]:w[i?"find":"filter"](t,function(t){for(var i in e)if(e[i]!==t[i])return!1;return!0})},w.findWhere=function(t,e){return w.where(t,e,!0)},w.max=function(t,e,i){if(!e&&w.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.max.apply(Math,t);if(!e&&w.isEmpty(t))return-1/0;var n={computed:-1/0,value:-1/0};return V(t,function(t,r,o){var s=e?e.call(i,t,r,o):t;s>=n.computed&&(n={value:t,computed:s})}),n.value},w.min=function(t,e,i){if(!e&&w.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.min.apply(Math,t);if(!e&&w.isEmpty(t))return 1/0;var n={computed:1/0,value:1/0};return V(t,function(t,r,o){var s=e?e.call(i,t,r,o):t;s<n.computed&&(n={value:t,computed:s})}),n.value},w.shuffle=function(t){var e,i=0,n=[];return V(t,function(t){e=w.random(i++),n[i-1]=n[e],n[e]=t}),n};var B=function(t){return w.isFunction(t)?t:function(e){return e[t]}};w.sortBy=function(t,e,i){var n=B(e);return w.pluck(w.map(t,function(t,e,r){return{value:t,index:e,criteria:n.call(i,t,e,r)}}).sort(function(t,e){var i=t.criteria,n=e.criteria;if(i!==n){if(i>n||void 0===i)return 1;if(n>i||void 0===n)return-1}return t.index<e.index?-1:1}),"value")};var S=function(t,e,i,n){var r={},o=B(e||w.identity);return V(t,function(e,s){var a=o.call(i,e,s,t);n(r,a,e)}),r};w.groupBy=function(t,e,i){return S(t,e,i,function(t,e,i){(w.has(t,e)?t[e]:t[e]=[]).push(i)})},w.countBy=function(t,e,i){return S(t,e,i,function(t,e){w.has(t,e)||(t[e]=0),t[e]++})},w.sortedIndex=function(t,e,i,n){i=null==i?w.identity:B(i);for(var r=i.call(n,e),o=0,s=t.length;s>o;){var a=o+s>>>1;i.call(n,t[a])<r?o=a+1:s=a}return o},w.toArray=function(t){return t?w.isArray(t)?c.call(t):t.length===+t.length?w.map(t,w.identity):w.values(t):[]},w.size=function(t){return null==t?0:t.length===+t.length?t.length:w.keys(t).length},w.first=w.head=w.take=function(t,e,i){return null==t?void 0:null==e||i?t[0]:c.call(t,0,e)},w.initial=function(t,e,i){return c.call(t,0,t.length-(null==e||i?1:e))},w.last=function(t,e,i){return null==t?void 0:null==e||i?t[t.length-1]:c.call(t,Math.max(t.length-e,0))},w.rest=w.tail=w.drop=function(t,e,i){return c.call(t,null==e||i?1:e)},w.compact=function(t){return w.filter(t,w.identity)};var F=function(t,e,i){return V(t,function(t){w.isArray(t)?e?a.apply(i,t):F(t,e,i):i.push(t)}),i};w.flatten=function(t,e){return F(t,e,[])},w.without=function(t){return w.difference(t,c.call(arguments,1))},w.uniq=w.unique=function(t,e,i,n){w.isFunction(e)&&(n=i,i=e,e=!1);var r=i?w.map(t,i,n):t,o=[],s=[];return V(r,function(i,n){(e?n&&s[s.length-1]===i:w.contains(s,i))||(s.push(i),o.push(t[n]))}),o},w.union=function(){return w.uniq(u.apply(r,arguments))},w.intersection=function(t){var e=c.call(arguments,1);return w.filter(w.uniq(t),function(t){return w.every(e,function(e){return w.indexOf(e,t)>=0})})},w.difference=function(t){var e=u.apply(r,c.call(arguments,1));return w.filter(t,function(t){return!w.contains(e,t)})},w.zip=function(){for(var t=c.call(arguments),e=w.max(w.pluck(t,"length")),i=new Array(e),n=0;e>n;n++)i[n]=w.pluck(t,""+n);return i},w.object=function(t,e){if(null==t)return{};for(var i={},n=0,r=t.length;r>n;n++)e?i[t[n]]=e[n]:i[t[n][0]]=t[n][1];return i},w.indexOf=function(t,e,i){if(null==t)return-1;var n=0,r=t.length;if(i){if("number"!=typeof i)return n=w.sortedIndex(t,e),t[n]===e?n:-1;n=0>i?Math.max(0,r+i):i}if(x&&t.indexOf===x)return t.indexOf(e,i);for(;r>n;n++)if(t[n]===e)return n;return-1},w.lastIndexOf=function(t,e,i){if(null==t)return-1;var n=null!=i;if(b&&t.lastIndexOf===b)return n?t.lastIndexOf(e,i):t.lastIndexOf(e);for(var r=n?i:t.length;r--;)if(t[r]===e)return r;return-1},w.range=function(t,e,i){arguments.length<=1&&(e=t||0,t=0),i=arguments[2]||1;for(var n=Math.max(Math.ceil((e-t)/i),0),r=0,o=new Array(n);n>r;)o[r++]=t,t+=i;return o},w.bind=function(t,e){if(t.bind===C&&C)return C.apply(t,c.call(arguments,1));var i=c.call(arguments,2);return function(){return t.apply(e,i.concat(c.call(arguments)))}},w.partial=function(t){var e=c.call(arguments,1);return function(){return t.apply(this,e.concat(c.call(arguments)))}},w.bindAll=function(t){var e=c.call(arguments,1);return 0===e.length&&(e=w.functions(t)),V(e,function(e){t[e]=w.bind(t[e],t)}),t},w.memoize=function(t,e){var i={};return e||(e=w.identity),function(){var n=e.apply(this,arguments);return w.has(i,n)?i[n]:i[n]=t.apply(this,arguments)}},w.delay=function(t,e){var i=c.call(arguments,2);return setTimeout(function(){return t.apply(null,i)},e)},w.defer=function(t){return w.delay.apply(w,[t,1].concat(c.call(arguments,1)))},w.throttle=function(t,e){var i,n,r,o,s=0,a=function(){s=new Date,r=null,o=t.apply(i,n)};return function(){var c=new Date,u=e-(c-s);return i=this,n=arguments,0>=u?(clearTimeout(r),r=null,s=c,o=t.apply(i,n)):r||(r=setTimeout(a,u)),o}},w.debounce=function(t,e,i){var n,r;return function(){var o=this,s=arguments,a=function(){n=null,i||(r=t.apply(o,s))},c=i&&!n;return clearTimeout(n),n=setTimeout(a,e),c&&(r=t.apply(o,s)),r}},w.once=function(t){var e,i=!1;return function(){return i?e:(i=!0,e=t.apply(this,arguments),t=null,e)}},w.wrap=function(t,e){return function(){var i=[t];return a.apply(i,arguments),e.apply(this,i)}},w.compose=function(){var t=arguments;return function(){for(var e=arguments,i=t.length-1;i>=0;i--)e=[t[i].apply(this,e)];return e[0]}},w.after=function(t,e){return 0>=t?e():function(){return--t<1?e.apply(this,arguments):void 0}},w.keys=I||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var i in t)w.has(t,i)&&(e[e.length]=i);return e},w.values=function(t){var e=[];for(var i in t)w.has(t,i)&&e.push(t[i]);return e},w.pairs=function(t){var e=[];for(var i in t)w.has(t,i)&&e.push([i,t[i]]);return e},w.invert=function(t){var e={};for(var i in t)w.has(t,i)&&(e[t[i]]=i);return e},w.functions=w.methods=function(t){var e=[];for(var i in t)w.isFunction(t[i])&&e.push(i);return e.sort()},w.extend=function(t){return V(c.call(arguments,1),function(e){if(e)for(var i in e)t[i]=e[i]}),t},w.pick=function(t){var e={},i=u.apply(r,c.call(arguments,1));return V(i,function(i){i in t&&(e[i]=t[i])}),e},w.omit=function(t){var e={},i=u.apply(r,c.call(arguments,1));for(var n in t)w.contains(i,n)||(e[n]=t[n]);return e},w.defaults=function(t){return V(c.call(arguments,1),function(e){if(e)for(var i in e)null==t[i]&&(t[i]=e[i])}),t},w.clone=function(t){return w.isObject(t)?w.isArray(t)?t.slice():w.extend({},t):t},w.tap=function(t,e){return e(t),t};var z=function(t,e,i,n){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof w&&(t=t._wrapped),e instanceof w&&(e=e._wrapped);var r=l.call(t);if(r!=l.call(e))return!1;switch(r){case"[object String]":return t==String(e);case"[object Number]":return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if("object"!=typeof t||"object"!=typeof e)return!1;for(var o=i.length;o--;)if(i[o]==t)return n[o]==e;i.push(t),n.push(e);var s=0,a=!0;if("[object Array]"==r){if(s=t.length,a=s==e.length)for(;s--&&(a=z(t[s],e[s],i,n)););}else{var c=t.constructor,u=e.constructor;if(c!==u&&!(w.isFunction(c)&&c instanceof c&&w.isFunction(u)&&u instanceof u))return!1;for(var h in t)if(w.has(t,h)&&(s++,!(a=w.has(e,h)&&z(t[h],e[h],i,n))))break;if(a){for(h in e)if(w.has(e,h)&&!s--)break;a=!s}}return i.pop(),n.pop(),a};w.isEqual=function(t,e){return z(t,e,[],[])},w.isEmpty=function(t){if(null==t)return!0;if(w.isArray(t)||w.isString(t))return 0===t.length;for(var e in t)if(w.has(t,e))return!1;return!0},w.isElement=function(t){return!(!t||1!==t.nodeType)},w.isArray=_||function(t){return"[object Array]"==l.call(t)},w.isObject=function(t){return t===Object(t)},V(["Arguments","Function","String","Number","Date","RegExp"],function(t){w["is"+t]=function(e){return l.call(e)=="[object "+t+"]"}}),w.isArguments(arguments)||(w.isArguments=function(t){return!(!t||!w.has(t,"callee"))}),"function"!=typeof/./&&(w.isFunction=function(t){return"function"==typeof t}),w.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},w.isNaN=function(t){return w.isNumber(t)&&t!=+t},w.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==l.call(t)},w.isNull=function(t){return null===t},w.isUndefined=function(t){return void 0===t},w.has=function(t,e){return h.call(t,e)},w.noConflict=function(){return t._=e,this},w.identity=function(t){return t},w.times=function(t,e,i){for(var n=Array(t),r=0;t>r;r++)n[r]=e.call(i,r);return n},w.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))};var R={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};R.unescape=w.invert(R.escape);var E={escape:new RegExp("["+w.keys(R.escape).join("")+"]","g"),unescape:new RegExp("("+w.keys(R.unescape).join("|")+")","g")};w.each(["escape","unescape"],function(t){w[t]=function(e){return null==e?"":(""+e).replace(E[t],function(e){return R[t][e]})}}),w.result=function(t,e){if(null==t)return null;var i=t[e];return w.isFunction(i)?i.call(t):i},w.mixin=function(t){V(w.functions(t),function(e){var i=w[e]=t[e];w.prototype[e]=function(){var t=[this._wrapped];return a.apply(t,arguments),M.call(this,i.apply(w,t))}})};var O=0;w.uniqueId=function(t){var e=++O+"";return t?t+e:e},w.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var k=/(.)^/,j={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},W=/\\|'|\r|\n|\t|\u2028|\u2029/g;w.template=function(t,e,i){var n;i=w.defaults({},i,w.templateSettings);var r=new RegExp([(i.escape||k).source,(i.interpolate||k).source,(i.evaluate||k).source].join("|")+"|$","g"),o=0,s="__p+='";t.replace(r,function(e,i,n,r,a){return s+=t.slice(o,a).replace(W,function(t){return"\\"+j[t]}),i&&(s+="'+\n((__t=("+i+"))==null?'':_.escape(__t))+\n'"),n&&(s+="'+\n((__t=("+n+"))==null?'':__t)+\n'"),r&&(s+="';\n"+r+"\n__p+='"),o=a+e.length,e}),s+="';\n",i.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{n=new Function(i.variable||"obj","_",s)}catch(a){throw a.source=s,a}if(e)return n(e,w);var c=function(t){return n.call(this,t,w)};return c.source="function("+(i.variable||"obj")+"){\n"+s+"}",c},w.chain=function(t){return w(t).chain()};var M=function(t){return this._chain?w(t).chain():t};w.mixin(w),V(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=r[t];w.prototype[t]=function(){var i=this._wrapped;return e.apply(i,arguments),"shift"!=t&&"splice"!=t||0!==i.length||delete i[0],M.call(this,i)}}),V(["concat","join","slice"],function(t){var e=r[t];w.prototype[t]=function(){return M.call(this,e.apply(this._wrapped,arguments))}}),w.extend(w.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof i&&i.amd&&i("underscore",[],function(){return w})}.call(this),i("ammo_worker_api",[],function(){function t(t){this.maxBodies=1e3,this.maxVehicles=32,this.maxWheelsPerVehicle=8,this.maxKinematicCharacterControllers=16;for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e])}return t.prototype={collisionFlags:{CF_STATIC_OBJECT:1,CF_KINEMATIC_OBJECT:2,CF_NO_CONTACT_RESPONSE:4,CF_CUSTOM_MATERIAL_CALLBACK:8,CF_CHARACTER_OBJECT:16,CF_DISABLE_VISUALIZE_OBJECT:32,CF_DISABLE_SPU_COLLISION_PROCESSING:64},activationStates:{ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5},collisionFilterGroups:{DefaultFilter:1,StaticFilter:2,KinematicFilter:4,DebrisFilter:8,SensorTrigger:16,CharacterFilter:32,AllFilter:-1},init:function(){var t=8*(7*this.maxBodies+7*this.maxVehicles*this.maxWheelsPerVehicle+7*this.maxKinematicCharacterControllers);this.OFFSET_RIGID_BODY=0,this.OFFSET_VEHICLE=7*this.maxBodies,this.OFFSET_KINEMATIC_CHARACTER=this.OFFSET_VEHICLE+7*this.maxVehicles*this.maxWheelsPerVehicle,this.OFFSET_GHOST_COLLISION=this.OFFSET_KINEMATIC_CHARACTER+7*this.maxKinematicCharacterControllers,importScripts("./js/ammo.js"),this.tmpVec=[new Ammo.btVector3,new Ammo.btVector3,new Ammo.btVector3,new Ammo.btVector3],this.tmpQuaternion=[new Ammo.btQuaternion,new Ammo.btQuaternion],this.tmpTrans=[new Ammo.btTransform,new Ammo.btTransform],this.bodies=[],this.vehicles=[],this.constraints=[],this.ghosts=[],this.characterControllers=[],this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.ghostPairCallback=new Ammo.btGhostPairCallback,this.dynamicsWorld.getPairCache().setInternalGhostPairCallback(this.ghostPairCallback),this.dynamicsWorld.getDispatchInfo().set_m_allowedCcdPenetration(1e-4),this.buffers=[new ArrayBuffer(t),new ArrayBuffer(t),new ArrayBuffer(t),new ArrayBuffer(t)],this.ghostCollisions={},this.fire("ready")},getStats:function(t,e){return e({totalTime:this.totalTime,frames:this.frames,fps:this.fps,buffersReady:this.buffers.length})},startSimulation:function(){var t=this,e=Date.now();t.totalTime=0,t.frames=0,this.simulationTimerId=setInterval(function(){var i,n,r,o,s,a=Date.now(),c=(a-e)/1e3;if(t.dynamicsWorld.stepSimulation(c,t.iterations,t.step),t.buffers.length>0&&(n=new Float64Array(t.buffers.pop())),n&&n.buffer instanceof ArrayBuffer){for(r in t.bodies)t.bodies[r]&&(t.tmpTrans[0].setIdentity(),t.bodies[r].getMotionState().getWorldTransform(t.tmpTrans[0]),s=t.OFFSET_RIGID_BODY+7*r,n[s+0]=t.tmpTrans[0].getOrigin().x(),n[s+1]=t.tmpTrans[0].getOrigin().y(),n[s+2]=t.tmpTrans[0].getOrigin().z(),n[s+3]=t.tmpTrans[0].getRotation().x(),n[s+4]=t.tmpTrans[0].getRotation().y(),n[s+5]=t.tmpTrans[0].getRotation().z(),n[s+6]=t.tmpTrans[0].getRotation().w());for(r in t.vehicles)if(t.vehicles[r])for(i=t.vehicles[r],o=0;o<i.getNumWheels()+1;o++)t.tmpTrans[0]=i.getWheelInfo(o).get_m_worldTransform(),s=t.OFFSET_VEHICLE+7*r*t.maxWheelsPerVehicle+7*o,n[s+0]=t.tmpTrans[0].getOrigin().x(),n[s+1]=t.tmpTrans[0].getOrigin().y(),n[s+2]=t.tmpTrans[0].getOrigin().z(),n[s+3]=t.tmpTrans[0].getRotation().x(),n[s+4]=t.tmpTrans[0].getRotation().y(),n[s+5]=t.tmpTrans[0].getRotation().z(),n[s+6]=t.tmpTrans[0].getRotation().w();for(r in t.characterControllers)if(t.characterControllers[r]){var u=t.characterControllers[r].getGhostObject().getWorldTransform();s=t.OFFSET_KINEMATIC_CHARACTER+7*r,n[s+0]=u.getOrigin().x(),n[s+1]=u.getOrigin().y(),n[s+2]=u.getOrigin().z(),n[s+3]=u.getRotation().x(),n[s+4]=u.getRotation().y(),n[s+5]=u.getRotation().z(),n[s+6]=u.getRotation().w()}t.ghosts.forEach(function(e,i){var n;t.ghostCollisions[i]=t.ghostCollisions[i]||{};var r,o,s,a=e.getNumOverlappingObjects();if(a>0){for(n={},r=0;a>r;r++)s=Ammo.castObject(e.getOverlappingObject(r),Ammo.btRigidBody),n[s.id]=!0,t.ghostCollisions[i][s.id]||t.fire("ghost_enter",{objectA:{type:"ghost",id:i},objectB:{type:"rigidBody",id:s.id}});for(o in t.ghostCollisions[i])n[o]||(t.fire("ghost_exit",{objectA:{type:"ghost",id:i},objectB:{type:"rigidBody",id:s.id}}),t.ghostCollisions[i][o]=!1);t.ghostCollisions[i]=n}}.bind(this)),t.fire("update",n.buffer,[n.buffer]),t.frames++,e=a,t.totalTime+=c,t.fps=Math.round(t.frames/t.totalTime)}},1e3*this.step)},stopSimulation:function(){this.simulationTimerId&&clearInterval(this.simulationTimerId)},swap:function(t){t instanceof ArrayBuffer&&this.buffers.push(t)},setStep:function(t){this.step=t},setIterations:function(t){this.iterations=t},setGravity:function(t){this.tmpVec[0].setX(t.x),this.tmpVec[0].setY(t.y),this.tmpVec[0].setZ(t.z),this.dynamicsWorld.setGravity(this.tmpVec[0])},_createCompoundShape:function(t){var e,i,n=new Ammo.btCompoundShape,r=this.tmpTrans[0];if(t.children&&t.children.length)for(var o in t.children)t.children.hasOwnProperty(o)&&(e=t.children[o],i=this._createShape(e),r.setIdentity(),this.tmpVec[0].setX(e.localTransform.position.x),this.tmpVec[0].setY(e.localTransform.position.y),this.tmpVec[0].setZ(e.localTransform.position.z),r.setOrigin(this.tmpVec[0]),this.tmpQuaternion[0].setX(e.localTransform.rotation.x),this.tmpQuaternion[0].setY(e.localTransform.rotation.y),this.tmpQuaternion[0].setZ(e.localTransform.rotation.z),this.tmpQuaternion[0].setW(e.localTransform.rotation.w),r.setRotation(this.tmpQuaternion[0]),n.addChildShape(r,i));return n},_createConvexHullMeshShape:function(t){var e;if(!t.vertices)throw new Error("You must supply a list of vertices!");e=new Ammo.btConvexHullShape;for(var i=0;i<t.vertices.length/3;i+=3)this.tmpVec[0].setX(t.vertices[3*i+0]),this.tmpVec[0].setY(t.vertices[3*i+1]),this.tmpVec[0].setZ(t.vertices[3*i+2]),e.addPoint(this.tmpVec[0]);return e},_createTriangleMeshShape:function(t,e){var i,n,r;if(!t.triangles)throw new Error("You must supply a list of triangles!");switch(e){case"bvh":r="btBvhTriangleMeshShape";break;case"convex":r="btConvexTriangleMeshShape";break;default:throw new Error("You must supply a valid mesh type!")}for(n=new Ammo.btTriangleMesh(!0,!0),i=0;i<t.triangles.length/9;i++)this.tmpVec[0].setX(t.triangles[9*i+0]),this.tmpVec[0].setY(t.triangles[9*i+1]),this.tmpVec[0].setZ(t.triangles[9*i+2]),this.tmpVec[1].setX(t.triangles[9*i+3]),this.tmpVec[1].setY(t.triangles[9*i+4]),this.tmpVec[1].setZ(t.triangles[9*i+5]),this.tmpVec[2].setX(t.triangles[9*i+6]),this.tmpVec[2].setY(t.triangles[9*i+7]),this.tmpVec[2].setZ(t.triangles[9*i+8]),n.addTriangle(this.tmpVec[0],this.tmpVec[1],this.tmpVec[2],!1);return new Ammo[r](n,!0,!0)},_createShape:function(t){var e;switch(t.shape){case"box":this.tmpVec[0].setX(t.halfExtents.x),this.tmpVec[0].setY(t.halfExtents.y),this.tmpVec[0].setZ(t.halfExtents.z),e=new Ammo.btBoxShape(this.tmpVec[0]);break;case"sphere":e=new Ammo.btSphereShape(t.radius);break;case"staticplane":this.tmpVec[0].setX(t.normal.x),this.tmpVec[0].setY(t.normal.y),this.tmpVec[0].setZ(t.normal.z),e=new Ammo.btStaticPlaneShape(this.tmpVec[0],t.distance);break;case"cylinder":this.tmpVec[0].setX(t.width),this.tmpVec[0].setY(t.height),this.tmpVec[0].setZ(t.depth),e=new Ammo.btCylinderShape(this.tmpVec[0]);break;case"capsule":e=new Ammo.btCapsuleShape(t.radius,t.height);break;case"cone":e=new Ammo.btConeShape(t.radius,t.height);break;case"compound":e=this._createCompoundShape(t);break;case"convex_hull_mesh":e=this._createConvexHullMeshShape(t);break;case"convex_triangle_mesh":e=this._createTriangleMeshShape(t,"convex");break;case"bvh_triangle_mesh":e=this._createTriangleMeshShape(t,"bvh");break;default:return console.error("Unknown shape: "+t.shape)}return e},Broadphase_aabbTest:function(t,e){var i=this;this.aabbCallback||(this.aabbCallback=new Ammo.ConcreteBroadphaseAabbCallback,this.aabbCallback.bodies=[],function(){Ammo.customizeVTable(i.aabbCallback,[{original:Ammo.ConcreteBroadphaseAabbCallback.prototype.process,replacement:function(t,e){var i=Ammo.wrapPointer(e,Ammo.btBroadphaseProxy),n=Ammo.wrapPointer(i.get_m_clientObject(),Ammo.btRigidBody),r=Ammo.wrapPointer(t,Ammo.ConcreteBroadphaseAabbCallback);return n.id&&r.bodies.push(n.id),!0}}])}()),this.tmpVec[0].setX(t.min.x),this.tmpVec[0].setY(t.min.y),this.tmpVec[0].setZ(t.min.z),this.tmpVec[1].setX(t.max.x),this.tmpVec[1].setY(t.max.y),this.tmpVec[1].setZ(t.max.z),this.aabbCallback.bodies=[],this.dynamicsWorld.getBroadphase().aabbTest(this.tmpVec[0],this.tmpVec[1],this.aabbCallback),e(this.aabbCallback.bodies)},Vehicle_create:function(t,e){var i,n=new Ammo.btVehicleTuning,r=this.bodies[t.bodyId];if(!r)return console.error("could not find body");t.tuning&&(t.tuning.suspensionStiffness&&n.set_m_suspensionStiffness(t.tuning.suspensionStiffness),t.tuning.suspensionCompression&&n.set_m_suspensionCompression(t.tuning.suspensionCompression),t.tuning.suspensionDamping&&n.set_m_suspensionDamping(t.tuning.suspensionDamping),t.tuning.maxSuspensionTravelCm&&n.set_m_maxSuspensionTravelCm(t.tuning.maxSuspensionTravelCm),t.tuning.maxSuspensionForce&&n.set_m_maxSuspensionForce(t.tuning.maxSuspensionForce),t.tuning.frictionSlip&&n.set_m_frictionSlip(t.tuning.frictionSlip)),i=new Ammo.btRaycastVehicle(n,r,new Ammo.btDefaultVehicleRaycaster(this.dynamicsWorld)),i.tuning=n,r.setActivationState(this.activationStates.DISABLE_DEACTIVATION),i.setCoordinateSystem(0,1,2),this.dynamicsWorld.addVehicle(i);var o=this.vehicles.push(i)-1;i.id=o,"function"==typeof e&&e(o)},Vehicle_addWheel:function(t,e){var i=this.vehicles[t.vehicleId];if(void 0!==i){var n=i.tuning,r=this.tmpVec[0],o=this.tmpVec[1],s=this.tmpVec[2];"object"==typeof t.tuning&&(n=new Ammo.btVehicleTuning,t.tuning.suspensionStiffness&&n.set_m_suspensionStiffness(t.tuning.suspensionStiffness),t.tuning.suspensionCompression&&n.set_m_suspensionCompression(t.tuning.suspensionCompression),t.tuning.suspensionDamping&&n.set_m_suspensionDamping(t.tuning.suspensionDamping),t.tuning.maxSuspensionTravelCm&&n.set_m_maxSuspensionTravelCm(t.tuning.maxSuspensionTravelCm),t.tuning.maxSuspensionForce&&n.set_m_maxSuspensionForce(t.tuning.maxSuspensionForce),t.tuning.frictionSlip&&n.set_m_frictionSlip(t.tuning.frictionSlip)),r.setX(t.connectionPoint.x),r.setY(t.connectionPoint.y),r.setZ(t.connectionPoint.z),o.setX(t.wheelDirection.x),o.setY(t.wheelDirection.y),o.setZ(t.wheelDirection.z),s.setX(t.wheelAxle.x),s.setY(t.wheelAxle.y),s.setZ(t.wheelAxle.z),i.addWheel(r,o,s,t.suspensionRestLength,t.wheelRadius,n,t.isFrontWheel),"function"==typeof e&&e(i.getNumWheels()-1)}},Vehicle_setSteeringValue:function(t){var e=this.vehicles[t.vehicleId];e&&this.vehicles[t.vehicleId].setSteeringValue(t.steeringValue,t.wheelIndex)},Vehicle_setBrake:function(t){var e=this.vehicles[t.vehicleId];e&&this.vehicles[t.vehicleId].setBrake(t.brake,t.wheelIndex)},Vehicle_setWheelInfo:function(t){var e,i=this.vehicles[t.vehicleId];if(i){e=this.vehicles[t.vehicleId].getWheelInfo(t.wheelIndex);for(var n in t.properties)t.properties.hasOwnProperty(n)&&e["set_m_"+n](t.properties[n])}},Vehicle_applyEngineForce:function(t){var e=this.vehicles[t.vehicleId];
e&&this.vehicles[t.vehicleId].applyEngineForce(t.force,t.wheelIndex)},Point2PointConstraint_create:function(t,e){var i,n,r=this.bodies[t.rigidBodyIdA],o="undefined"!=typeof t.rigidBodyIdB&&this.bodies[t.rigidBodyIdB];r&&(this.tmpVec[0].setX(t.pivotA.x),this.tmpVec[0].setY(t.pivotA.y),this.tmpVec[0].setZ(t.pivotA.z),o?(o=this.bodies[t.rigidBodyIdB],this.tmpVec[1].setX(t.pivotB.x),this.tmpVec[1].setY(t.pivotB.y),this.tmpVec[1].setZ(t.pivotB.z),i=new Ammo.btPoint2PointConstraint(r,o,this.tmpVec[0],this.tmpVec[1])):i=new Ammo.btPoint2PointConstraint(r,o),n=this.constraints.push(i)-1,this.dynamicsWorld.addConstraint(i),i.enableFeedback(),"function"==typeof e&&e(n))},SliderConstraint_create:function(t,e){var i,n,r=this.bodies[t.rigidBodyIdA],o="undefined"!=typeof t.rigidBodyIdB&&this.bodies[t.rigidBodyIdB];if(r){var s=new Ammo.btTransform;if(this.tmpVec[0].setX(t.frameInA.position.x),this.tmpVec[0].setY(t.frameInA.position.y),this.tmpVec[0].setZ(t.frameInA.position.z),this.tmpQuaternion[0].setX(t.frameInA.rotation.x),this.tmpQuaternion[0].setY(t.frameInA.rotation.y),this.tmpQuaternion[0].setZ(t.frameInA.rotation.z),this.tmpQuaternion[0].setW(t.frameInA.rotation.w),s.setOrigin(this.tmpVec[0]),s.setRotation(this.tmpQuaternion[0]),o){var a=new Ammo.btTransform;this.tmpVec[1].setX(t.frameInB.position.x),this.tmpVec[1].setY(t.frameInB.position.y),this.tmpVec[1].setZ(t.frameInB.position.z),this.tmpQuaternion[1].setX(t.frameInB.rotation.x),this.tmpQuaternion[1].setY(t.frameInB.rotation.y),this.tmpQuaternion[1].setZ(t.frameInB.rotation.z),this.tmpQuaternion[1].setW(t.frameInB.rotation.w),a.setOrigin(this.tmpVec[1]),a.setRotation(this.tmpQuaternion[1]),i=new Ammo.btSliderConstraint(r,o,s,a)}n=this.constraints.push(i)-1,this.dynamicsWorld.addConstraint(i),i.enableFeedback(),"function"==typeof e&&e(n)}},SliderConstraint_setLowerLinLimit:function(t){var e=this.constraints[t.constraintId];e&&e.setLowerLinLimit(t.limit)},SliderConstraint_setUpperLinLimit:function(t){var e=this.constraints[t.constraintId];e&&e.setUpperLinLimit(t.limit)},SliderConstraint_setLowerAngLimit:function(t){var e=this.constraints[t.constraintId];e&&e.setLowerAngLimit(t.limit)},SliderConstraint_setUpperAngLimit:function(t){var e=this.constraints[t.constraintId];e&&e.setUpperAngLimit(t.limit)},HingeConstraint_create:function(t,e){var i,n,r=this.bodies[t.rigidBodyIdA],o="undefined"!=typeof t.rigidBodyIdB&&this.bodies[t.rigidBodyIdB];r&&(this.tmpVec[0].setX(t.pivotA.x),this.tmpVec[0].setY(t.pivotA.y),this.tmpVec[0].setZ(t.pivotA.z),this.tmpVec[1].setX(t.axisA.x),this.tmpVec[1].setX(t.axisA.y),this.tmpVec[1].setX(t.axisA.z),o?(o=this.bodies[t.rigidBodyIdB],this.tmpVec[2].setX(t.pivotB.x),this.tmpVec[2].setY(t.pivotB.y),this.tmpVec[2].setZ(t.pivotB.z),this.tmpVec[3].setX(t.axisB.x),this.tmpVec[3].setY(t.axisB.y),this.tmpVec[3].setZ(t.axisB.z),i=new Ammo.btHingeConstraint(r,o,this.tmpVec[0],this.tmpVec[2],this.tmpVec[1],this.tmpVec[3])):i=new Ammo.btHingeConstraint(r,o,this.tmpVec[0],this.tmpVec[1]),n=this.constraints.push(i)-1,this.dynamicsWorld.addConstraint(i),i.enableFeedback(),"function"==typeof e&&e(n))},HingeConstraint_setLimit:function(t){var e=this.constraints[t.constraintId];e&&e.setLimit(t.low,t.high,t.softness,t.biasFactor,t.relaxationFactor)},DynamicsWorld_rayTestClosest:function(t,e){this.tmpVec[0].setX(t.rayFromWorld.x),this.tmpVec[0].setY(t.rayFromWorld.y),this.tmpVec[0].setZ(t.rayFromWorld.z),this.tmpVec[1].setX(t.rayToWorld.x),this.tmpVec[1].setY(t.rayToWorld.y),this.tmpVec[1].setZ(t.rayToWorld.z);var i=new Ammo.ClosestRayResultCallback(this.tmpVec[0],this.tmpVec[1]);if(this.dynamicsWorld.rayTest(this.tmpVec[0],this.tmpVec[1],i),i.hasHit()){var n=Ammo.castObject(i.get_m_collisionObject(),Ammo.btRigidBody);n.id&&"function"==typeof e&&e({type:"btRigidBody",bodyId:n.id,hitPointWorld:{x:i.get_m_hitPointWorld().x(),y:i.get_m_hitPointWorld().y(),z:i.get_m_hitPointWorld().z()},hitNormalWorld:{x:i.get_m_hitNormalWorld().x(),y:i.get_m_hitNormalWorld().y(),z:i.get_m_hitNormalWorld().z()}})}else"function"==typeof e&&e();Ammo.destroy(i)},DynamicsWorld_addRigidBody:function(t){var e=this.bodies[t.bodyId];e&&this.dynamicsWorld.addRigidBody(e,t.group,t.mask)},DynamicsWorld_addGhostObject:function(t){var e=this.ghosts[t.ghostId];e&&this.dynamicsWorld.addCollisionObject(e,t.group,t.mask)},GhostObject_create:function(t,e){var i,n=this._createShape(t.shape),r=this.tmpVec[0],o=this.tmpQuaternion[0];if(!n)return console.error("Invalid collision shape!");this.tmpTrans[0].setIdentity(),r.setX(t.position.x),r.setY(t.position.y),r.setZ(t.position.z),o.setX(t.quaternion.x),o.setY(t.quaternion.y),o.setZ(t.quaternion.z),o.setW(t.quaternion.w),this.tmpTrans[0].setOrigin(r),this.tmpTrans[0].setRotation(o),i=new Ammo.btPairCachingGhostObject,i.setWorldTransform(this.tmpTrans[0]),i.setCollisionShape(n),i.setCollisionFlags(this.collisionFlags.CF_NO_CONTACT_RESPONSE);var s=this.ghosts.push(i)-1;i.id=s,"function"==typeof e&&e(s)},KinematicCharacterController_create:function(t,e){var i,n,r,o=this.tmpTrans[0],s=this.tmpVec[1],a=this.tmpQuaternion[0];if(o.setIdentity(),i=this._createShape(t.shape),!i)throw"Invalid collision shape!";s.setX(t.position.x),s.setY(t.position.y),s.setZ(t.position.z),a.setX(t.quaternion.x),a.setY(t.quaternion.y),a.setZ(t.quaternion.z),a.setW(t.quaternion.w),o.setOrigin(s),o.setRotation(a),n=new Ammo.btPairCachingGhostObject,n.setWorldTransform(o),n.setCollisionShape(i),n.setCollisionFlags(this.collisionFlags.CF_CHARACTER_OBJECT),r=new Ammo.btKinematicCharacterController(n,i,t.stepHeight),this.dynamicsWorld.addCollisionObject(n,this.collisionFilterGroups.CharacterFilter,this.collisionFilterGroups.StaticFilter|this.collisionFilterGroups.DefaultFilter),this.dynamicsWorld.addAction(r);var c=this.characterControllers.push(r)-1;this.ghost=n,r.id=c,"function"==typeof e&&e(c)},KinematicCharacterController_setWalkDirection:function(t){var e=this.characterControllers[t.controllerId];e&&(this.tmpVec[0].setX(t.direction.x),this.tmpVec[0].setY(t.direction.y),this.tmpVec[0].setZ(t.direction.z),e.setWalkDirection(this.tmpVec[0]))},KinematicCharacterController_jump:function(t){var e=this.characterControllers[t.controllerId];e&&e.jump()},KinematicCharacterController_setJumpSpeed:function(t){var e=this.characterControllers[t.controllerId];e&&e.setJumpSpeed(t.jumpSpeed)},KinematicCharacterController_setFallSpeed:function(t){var e=this.characterControllers[t.controllerId];e&&e.setFallSpeed(t.fallSpeed)},KinematicCharacterController_setMaxJumpHeight:function(t){var e=this.characterControllers[t.controllerId];e&&e.setMaxJumpHeight(t.maxJumpHeight)},KinematicCharacterController_setGravity:function(t){var e=this.characterControllers[t.controllerId];e&&e.setGravity(t.gravity)},KinematicCharacterController_setUpAxis:function(t){var e=this.characterControllers[t.controllerId];e&&e.setUpAxis(t.upAxis)},KinematicCharacterController_setVelocityForTimeInterval:function(t){var e=this.characterControllers[t.controllerId];e&&(this.tmpVec[0].setX(t.velocity.x),this.tmpVec[0].setY(t.velocity.y),this.tmpVec[0].setZ(t.velocity.z),e.setVelocityForTimeInterval(this.tmpVec[0],t.interval))},KinematicCharacterController_setUseGhostSweepTest:function(t){var e=this.characterControllers[t.controllerId];e&&e.setUseGhostSweepTest(t.useGhostSweepTest)},KinematicCharacterController_setMaxSlope:function(t){var e=this.characterControllers[t.controllerId];e&&e.setMaxSlope(t.slopeRadians)},KinematicCharacterController_warp:function(t){var e=this.characterControllers[t.controllerId];e&&(this.tmpVec[0].setX(t.origin.x),this.tmpVec[0].setY(t.origin.y),this.tmpVec[0].setZ(t.origin.z),e.warp(this.tmpVec[0]))},RigidBody_create:function(t,e){var i,n,r,o,s=this.tmpTrans[0],a=0!==t.mass,c=this.tmpVec[0],u=this.tmpVec[1],l=this.tmpQuaternion[0];if(s.setIdentity(),c.setZero(),i=this._createShape(t.shape),!i)throw"Invalid collision shape!";a&&i.calculateLocalInertia(t.mass,c),u.setX(t.position.x),u.setY(t.position.y),u.setZ(t.position.z),l.setX(t.quaternion.x),l.setY(t.quaternion.y),l.setZ(t.quaternion.z),l.setW(t.quaternion.w),s.setOrigin(u),s.setRotation(l),n=new Ammo.btDefaultMotionState(s),r=new Ammo.btRigidBodyConstructionInfo(t.mass,n,i,c),o=new Ammo.btRigidBody(r);var h=this.bodies.push(o)-1;o.id=h,"function"==typeof e&&e(h)},RigidBody_setType:function(t){var e=this.bodies[t.bodyId];if(e)switch(t.type){case"static":e.setCollisionFlags(this.collisionFlags.CF_STATIC_OBJECT),e.setActivationState(this.activationStates.DISABLE_SIMULATION);break;case"kinematic":e.setCollisionFlags(this.collisionFlags.CF_KINEMATIC_OBJECT),e.setActivationState(this.activationStates.DISABLE_DEACTIVATION);break;default:console.warn("unknown body type: "+t.type+", defaulting to dynamic"),e.setCollisionFlags(0);break;case"dynamic":e.setCollisionFlags(0)}},RigidBody_setWorldTransform:function(t){var e,i,n=this.bodies[t.bodyId];n&&(this.tmpTrans[0].setIdentity(),n.getMotionState().getWorldTransform(this.tmpTrans[0]),e=this.tmpTrans[0].getOrigin(),i=this.tmpTrans[0].getRotation(),t.position&&(e.setX(t.position.x),e.setY(t.position.y),e.setZ(t.position.z)),t.rotation&&(i.setX(t.rotation.x),i.setY(t.rotation.y),i.setZ(t.rotation.z),i.setW(t.rotation.w)),n.isKinematicObject()?n.getMotionState().setWorldTransform(this.tmpTrans[0]):n.setWorldTransform(this.tmpTrans[0]))},RigidBody_clearForces:function(t){var e=this.bodies[t.bodyId];e&&(e.clearForces(),e.activate())},RigidBody_applyForce:function(t){var e=this.bodies[t.bodyId];e&&(this.tmpVec[0].setX(t.force.x),this.tmpVec[0].setY(t.force.y),this.tmpVec[0].setZ(t.force.z),this.tmpVec[1].setX(t.relativePosition.x),this.tmpVec[1].setY(t.relativePosition.y),this.tmpVec[1].setZ(t.relativePosition.z),e.applyForce(this.tmpVec[0],this.tmpVec[1]),e.activate())},RigidBody_applyCentralForce:function(t){var e=this.bodies[t.bodyId];e&&(this.tmpVec[0].setX(t.force.x),this.tmpVec[0].setY(t.force.y),this.tmpVec[0].setZ(t.force.z),e.applyCentralForce(this.tmpVec[0]),e.activate())},RigidBody_applyImpulse:function(t){var e=this.bodies[t.bodyId];e&&(this.tmpVec[0].setX(t.impulse.x),this.tmpVec[0].setY(t.impulse.y),this.tmpVec[0].setZ(t.impulse.z),this.tmpVec[1].setX(t.relativePosition.x),this.tmpVec[1].setY(t.relativePosition.y),this.tmpVec[1].setZ(t.relativePosition.z),e.applyImpulse(this.tmpVec[0],this.tmpVec[1]),e.activate())},RigidBody_applyCentralImpulse:function(t){var e=this.bodies[t.bodyId];e&&(this.tmpVec[0].setX(t.force.x),this.tmpVec[0].setY(t.force.y),this.tmpVec[0].setZ(t.force.z),e.applyCentralImpulse(this.tmpVec[0]),e.activate())},RigidBody_applyTorque:function(t){var e=this.bodies[t.bodyId];e&&(this.tmpVec[0].setX(t.torque.x),this.tmpVec[0].setY(t.torque.y),this.tmpVec[0].setZ(t.torque.z),e.applyTorque(this.tmpVec[0]),e.activate())},RigidBody_setRestitution:function(t){var e=this.bodies[t.bodyId];e&&e.setRestitution(t.restitution)},RigidBody_setFriction:function(t){var e=this.bodies[t.bodyId];e&&e.setFriction(t.friction)},RigidBody_setDamping:function(t){var e=this.bodies[t.bodyId];e&&e.setDamping(t.linearDamping,t.angularDamping)},RigidBody_setLinearFactor:function(t){var e=this.bodies[t.bodyId];e&&(this.tmpVec[0].setX(t.linearFactor.x),this.tmpVec[0].setY(t.linearFactor.y),this.tmpVec[0].setZ(t.linearFactor.z),e.setLinearFactor(this.tmpVec[0]))},RigidBody_setAngularFactor:function(t){var e=this.bodies[t.bodyId];e&&(this.tmpVec[0].setX(t.angularFactor.x),this.tmpVec[0].setY(t.angularFactor.y),this.tmpVec[0].setZ(t.angularFactor.z),e.setAngularFactor(this.tmpVec[0]))},RigidBody_setLinearVelocity:function(t){var e=this.bodies[t.bodyId];e&&(this.tmpVec[0].setX(t.linearVelocity.x),this.tmpVec[0].setY(t.linearVelocity.y),this.tmpVec[0].setZ(t.linearVelocity.z),e.setLinearVelocity(this.tmpVec[0]))},RigidBody_setAngularVelocity:function(t){var e=this.bodies[t.bodyId];e&&(this.tmpVec[0].setX(t.angularVelocity.x),this.tmpVec[0].setY(t.angularVelocity.y),this.tmpVec[0].setZ(t.angularVelocity.z),e.setAngularVelocity(this.tmpVec[0]))},Constraint_destroy:function(t){var e=this.constraints[t];e&&(this.dynamicsWorld.removeConstraint(e),Ammo.destroy(e),this.constraints[t]=void 0,this.trigger("Constraint_destroy",t))},RigidBody_destroy:function(t){var e=this.bodies[t];e&&(this.dynamicsWorld.removeRigidBody(e),Ammo.destroy(e),this.bodies[t]=void 0,this.trigger("RigidBody_destroy",t))},Vehicle_destroy:function(t){var e=this.vehicles[t];e&&(this.dynamicsWorld.removeVehicle(e),Ammo.destroy(e),this.vehicles[t]=void 0,this.trigger("Vehicle_destroy",t))},GhostObject_destroy:function(t){var e=this.ghosts[t];e&&(this.dynamicsWorld.removeCollisionObject(e),Ammo.destroy(e),this.ghosts[t]=void 0,this.trigger("GhostObject_destroy",t))},shutdown:function(){Ammo.destroy(this.collisionConfiguration),Ammo.destroy(this.dispatcher),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.solver)}},t}),i("vendor/backbone.events",["underscore"],function(t){var e={on:function(t,e,i){if(!n(this,"on",t,[e,i])||!e)return this;this._events||(this._events={});var r=this._events[t]||(this._events[t]=[]);return r.push({callback:e,context:i,ctx:i||this}),this},once:function(e,i,r){if(!n(this,"once",e,[i,r])||!i)return this;var o=this,s=t.once(function(){o.off(e,s),i.apply(this,arguments)});return s._callback=i,this.on(e,s,r)},off:function(e,i,r){var o,s,a,c,u,l,h,p;if(!this._events||!n(this,"off",e,[i,r]))return this;if(!e&&!i&&!r)return this._events=void 0,this;for(c=e?[e]:t.keys(this._events),u=0,l=c.length;l>u;u++)if(e=c[u],a=this._events[e]){if(this._events[e]=o=[],i||r)for(h=0,p=a.length;p>h;h++)s=a[h],(i&&i!==s.callback&&i!==s.callback._callback||r&&r!==s.context)&&o.push(s);o.length||delete this._events[e]}return this},trigger:function(t){if(!this._events)return this;var e=slice.call(arguments,1);if(!n(this,"trigger",t,e))return this;var i=this._events[t],o=this._events.all;return i&&r(i,e),o&&r(o,arguments),this},stopListening:function(e,i,n){var r=this._listeningTo;if(!r)return this;var o=!i&&!n;n||"object"!=typeof i||(n=this),e&&((r={})[e._listenId]=e);for(var s in r)e=r[s],e.off(i,n,this),(o||t.isEmpty(e._events))&&delete this._listeningTo[s];return this}},i=/\s+/,n=function(t,e,n,r){if(!n)return!0;if("object"==typeof n){for(var o in n)t[e].apply(t,[o,n[o]].concat(r));return!1}if(i.test(n)){for(var s=n.split(i),a=0,c=s.length;c>a;a++)t[e].apply(t,[s[a]].concat(r));return!1}return!0},r=function(t,e){var i,n=-1,r=t.length,o=e[0],s=e[1],a=e[2];switch(e.length){case 0:for(;++n<r;)(i=t[n]).callback.call(i.ctx);return;case 1:for(;++n<r;)(i=t[n]).callback.call(i.ctx,o);return;case 2:for(;++n<r;)(i=t[n]).callback.call(i.ctx,o,s);return;case 3:for(;++n<r;)(i=t[n]).callback.call(i.ctx,o,s,a);return;default:for(;++n<r;)(i=t[n]).callback.apply(i.ctx,e)}},o={listenTo:"on",listenToOnce:"once"};return t.each(o,function(i,n){e[n]=function(e,n,r){var o=this._listeningTo||(this._listeningTo={}),s=e._listenId||(e._listenId=t.uniqueId("l"));return o[s]=e,r||"object"!=typeof n||(r=this),e[i](n,r,this),this}}),e.bind=e.on,e.unbind=e.off,e}),i("ammo_base_object",["underscore","vendor/backbone.events"],function(t,e){function i(){}return t.extend(i.prototype,e),i}),i("ammo_rigid_body",["./ammo_base_object"],function(t){function e(t,e){this.proxy=t,this.bodyId=e,this.binding=void 0,this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:1},this.linearVelocity={x:0,y:0,z:0},this.angularVelocity={x:0,y:0,z:0}}return e.prototype=new t,e.prototype.update=function(){this.binding&&this.binding.update&&this.binding.update()},e.prototype.setType=function(t){return this.proxy.execute("RigidBody_setType",{bodyId:this.bodyId,type:t})},e.prototype.setDamping=function(t,e){return this.proxy.execute("RigidBody_setDamping",{bodyId:this.bodyId,linearDamping:t,angularDamping:e})},e.prototype.applyTorque=function(t){return this.proxy.execute("RigidBody_applyTorque",{bodyId:this.bodyId,torque:{x:t.x,y:t.y,z:t.z}})},e.prototype.applyForce=function(t,e){return this.proxy.execute("RigidBody_applyForce",{bodyId:this.bodyId,force:t,relativePosition:e||{x:0,y:0,z:0}})},e.prototype.applyCentralForce=function(t){return this.proxy.execute("RigidBody_applyCentralForce",{bodyId:this.bodyId,force:{x:t.x,y:t.y,z:t.z}})},e.prototype.applyImpulse=function(t,e){return this.proxy.execute("RigidBody_applyImpulse",{bodyId:this.bodyId,impulse:{x:t.x,y:t.y,z:t.z},relativePosition:e&&{x:e.x,y:e.y,z:e.z}||{x:0,y:0,z:0}})},e.prototype.applyCentralImpulse=function(t){return this.proxy.execute("RigidBody_applyCentralImpulse",{bodyId:this.bodyId,impulse:{x:t.x,y:t.y,z:t.z}})},e.prototype.setFriction=function(t){return this.proxy.execute("RigidBody_setFriction",{bodyId:this.bodyId,friction:t})},e.prototype.setRestitution=function(t){return this.proxy.execute("RigidBody_setRestitution",{bodyId:this.bodyId,restitution:t})},e.prototype.setLinearFactor=function(t){return this.proxy.execute("RigidBody_setLinearFactor",{bodyId:this.bodyId,linearFactor:{x:t.x,y:t.y,z:t.z}})},e.prototype.setAngularFactor=function(t){return this.proxy.execute("RigidBody_setAngularFactor",{bodyId:this.bodyId,angularFactor:{x:t.x,y:t.y,z:t.z}})},e.prototype.setLinearVelocity=function(t){return this.proxy.execute("RigidBody_setLinearVelocity",{bodyId:this.bodyId,linearVelocity:{x:t.x,y:t.y,z:t.z}})},e.prototype.setAngularVelocity=function(t){return this.proxy.execute("RigidBody_setAngularVelocity",{bodyId:this.bodyId,angularVelocity:{x:t.x,y:t.y,z:t.z}})},e.prototype.destroy=function(){var t=this.proxy.execute("RigidBody_destroy",{bodyId:this.bodyId});return this.bodyId=void 0,this.binding.destroy(),t},e.prototype.addToWorld=function(t,e){return this.proxy.execute("DynamicsWorld_addRigidBody",{bodyId:this.bodyId,group:t,mask:e})},e.prototype.setWorldTransform=function(t,e){return this.proxy.execute("RigidBody_setWorldTransform",{bodyId:this.bodyId,position:t,rotation:e})},e.prototype.clearForces=function(){return this.proxy.execute("RigidBody_clearForces",{bodyId:this.bodyId})},e}),i("ammo_vehicle",["underscore"],function(t){function e(t,e,i){this.proxy=t,this.vehicleId=e,this.wheelBindings=[],this.rigidBody=i}return e.prototype.addWheel=function(t,e,i,n,r,o,s){var a={vehicleId:this.vehicleId,connectionPoint:t,wheelDirection:e,wheelAxle:i,suspensionRestLength:n,wheelRadius:r,isFrontWheel:o,tuning:s};return this.proxy.execute("Vehicle_addWheel",a)},e.prototype.setWheelInfo=function(t,e){var i={vehicleId:this.vehicleId,wheelIndex:t,properties:e};return this.proxy.execute("Vehicle_setWheelInfo",i)},e.prototype.setBrake=function(t,e){var i={vehicleId:this.vehicleId,wheelIndex:t,brake:e};return this.proxy.execute("Vehicle_setBrake",i)},e.prototype.applyEngineForce=function(t,e){var i={vehicleId:this.vehicleId,wheelIndex:t,force:e};return this.proxy.execute("Vehicle_applyEngineForce",i)},e.prototype.setSteeringValue=function(t,e){var i={vehicleId:this.vehicleId,wheelIndex:t,steeringValue:e};return this.proxy.execute("Vehicle_setSteeringValue",i)},e.prototype.destroy=function(){var e={vehicleId:this.vehicleId};return t.each(this.wheelBindings,function(t){t.destroy()}),this.rigidBody.destroy(),this.proxy.execute("Vehicle_destroy",e)},e.prototype.addWheelObject=function(t,e){this.wheelBindings[t]=this.proxy.adapter.createBinding(e,this.proxy.getWheelOffset(this.vehicleId,t))},e.prototype.update=function(){this.rigidBody&&this.rigidBody.update(),t.each(this.wheelBindings,function(t){t.update()})},e}),i("ammo_point2point_constraint",[],function(){function t(t,e){this.proxy=t,this.constraintId=e}return t}),i("ammo_hinge_constraint",[],function(){function t(t,e){this.proxy=t,this.constraintId=e}return t.prototype.setLimit=function(t,e,i,n,r){var o={constraintId:this.constraintId,low:t,high:e,softness:i,biasFactor:n,relaxationFactor:r};return this.proxy.execute("HingeConstraint_setLimit",o)},t}),i("ammo_slider_constraint",[],function(){function t(t,e){this.proxy=t,this.constraintId=e}return t.prototype.setLowerLinLimit=function(t){return this.proxy.execute("SliderConstraint_setLowerLinLimit",{constraintId:this.constraintId,limit:t})},t.prototype.setUpperLinLimit=function(t){return this.proxy.execute("SliderConstraint_setUpperLinLimit",{constraintId:this.constraintId,limit:t})},t.prototype.setLowerAngLimit=function(t){return this.proxy.execute("SliderConstraint_setLowerAngLimit",{constraintId:this.constraintId,limit:t})},t.prototype.setUpperAngLimit=function(t){return this.proxy.execute("SliderConstraint_setUpperAngLimit",{constraintId:this.constraintId,limit:t})},t}),i("ammo_ghost_object",["./ammo_base_object"],function(t){function e(t,e){this.proxy=t,this.ghostId=e}return e.prototype=new t,e.prototype.addToWorld=function(t,e){return this.proxy.execute("DynamicsWorld_addGhostObject",{ghostId:this.ghostId,group:t,mask:e})},e.prototype.destroy=function(){return this.proxy.execute("GhostObject_destroy",{ghostId:this.ghostId})},e}),i("ammo_kinematic_character_controller",[],function(){function t(t,e){this.proxy=t,this.controllerId=e,this.binding=void 0,this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:1},this.linearVelocity={x:0,y:0,z:0},this.angularVelocity={x:0,y:0,z:0}}return t.prototype.update=function(){this.binding&&this.binding.update&&this.binding.update()},t.prototype.setWalkDirection=function(t){return this.proxy.execute("KinematicCharacterController_setWalkDirection",{controllerId:this.controllerId,direction:t})},t.prototype.setJumpSpeed=function(t){return this.proxy.execute("KinematicCharacterController_setJumpSpeed",{controllerId:this.controllerId,jumpSpeed:t})},t.prototype.setFallSpeed=function(t){return this.proxy.execute("KinematicCharacterController_setFallSpeed",{controllerId:this.controllerId,fallSpeed:t})},t.prototype.setMaxJumpHeight=function(t){return this.proxy.execute("KinematicCharacterController_setMaxJumpHeight",{controllerId:this.controllerId,maxJumpHeight:t})},t.prototype.setGravity=function(t){return this.proxy.execute("KinematicCharacterController_setGravity",{controllerId:this.controllerId,gravity:t})},t.prototype.setUpAxis=function(t){return this.proxy.execute("KinematicCharacterController_setUpAxis",{controllerId:this.controllerId,upAxis:t})},t.prototype.jump=function(){return this.proxy.execute("KinematicCharacterController_jump",{controllerId:this.controllerId})},t.prototype.setVelocityForTimeInterval=function(t,e){return this.proxy.execute("KinematicCharacterController_setVelocityForTimeInterval",{controllerId:this.controllerId,velocity:t,interval:e})},t.prototype.setUseGhostSweepTest=function(t){return this.proxy.execute("KinematicCharacterController_setUseGhostSweepTest",{controllerId:this.controllerId,useGhostSweepTest:t})},t.prototype.setMaxSlope=function(t){return this.proxy.execute("KinematicCharacterController_setMaxSlope",{controllerId:this.controllerId,slopRadians:t})},t.prototype.warp=function(t){return this.proxy.execute("KinematicCharacterController_warp",{controllerId:this.controllerId,origin:t})},t}),i("three/three_binding",[],function(){function t(t,e,i){this.proxy=t,this.object=e,this.offset=i,e.matrixAutoUpdate=!1,e.updateMatrixWorld(),this.originalScale=new THREE.Vector3,this.originalScale.getScaleFromMatrix(e.matrixWorld)}var e=new THREE.Quaternion,i=new THREE.Vector3;return t.prototype.update=function(){this.object&&this.proxy&&this.proxy.data&&(i.x=this.proxy.data[this.offset+0],i.y=this.proxy.data[this.offset+1],i.z=this.proxy.data[this.offset+2],e.x=this.proxy.data[this.offset+3],e.y=this.proxy.data[this.offset+4],e.z=this.proxy.data[this.offset+5],e.w=this.proxy.data[this.offset+6],this.object.matrixWorld.makeRotationFromQuaternion(e),this.object.matrixWorld.scale(this.originalScale),this.object.matrixWorld.setPosition(i))},t.prototype.destroy=function(){this.object=void 0,this.offset=void 0},t}),i("three/three_adapter",["underscore","three/three_binding"],function(t,e){function i(t){this.proxy=t}return i.prototype.createBinding=function(t,i){return new e(this.proxy,t,i)},i.prototype.createRigidBodyFromObject=function(e,i,n){n?"auto"===n.shape&&(n=this._getShapeJSON(e,{strategy:n.strategy})):n=this._getShapeJSON(e);var r={x:e.position.x,y:e.position.y,z:e.position.z},o={x:e.quaternion.x,y:e.quaternion.y,z:e.quaternion.z,w:e.quaternion.w},s=this.proxy.createRigidBody(n,i,r,o);return s.then(t.bind(function(t){t.binding=this.createBinding(e,this.proxy.getRigidBodyOffset(t.bodyId))},this)),s},i.prototype.createKinematicCharacterControllerFromObject=function(e,i,n){i?"auto"===i.shape&&(i=this._getShapeJSON(e,{strategy:i.strategy})):i=this._getShapeJSON(e);var r={x:e.position.x,y:e.position.y,z:e.position.z},o={x:e.quaternion.x,y:e.quaternion.y,z:e.quaternion.z,w:e.quaternion.w},s=this.proxy.createKinematicCharacterController(i,r,o,n);return s.then(t.bind(function(t){t.binding=this.createBinding(e,this.proxy.getKinematicCharacterControllerOffset(t.controllerId))},this)),s},i.prototype._getShapeJSON=function(t,e){switch(e=e||{},e.strategy=e.strategy||"convex_hull_mesh",e.strategy){case"compound_bounding_box":return this._createBoundingBoxCompoundShape(t);case"bvh_triangle_mesh":return this._createBvhTriangleMeshShape(t);case"convex_triangle_mesh":return this._createConvexTriangleMeshShape(t);case"convex_hull_mesh":return this._createConvexHullMeshShape(t);default:throw new Error("Unknown strategy: "+e.strategy)}},i.prototype._createConvexTriangleMeshShape=function(t){var e={shape:"convex_triangle_mesh",triangles:[]};return this._createTriangleMeshShape(t,e)},i.prototype._createBvhTriangleMeshShape=function(t){var e={shape:"bvh_triangle_mesh",triangles:[]};return this._createTriangleMeshShape(t,e)},i.prototype._createBoundingBoxCompoundShape=function(t){var e=new THREE.Matrix4,i=new THREE.Matrix4,n={shape:"compound",children:[]};return e.getInverse(t.matrixWorld),t.traverse(function(t){if(t instanceof THREE.Mesh&&!t.isBB){var r,o,s=new THREE.Vector3,a=new THREE.Vector3,c=new THREE.Quaternion,u=new THREE.Vector3;u.getScaleFromMatrix(t.matrixWorld),i.copy(e),i.multiply(t.matrixWorld),a.getPositionFromMatrix(i),i.extractRotation(i),c.setFromRotationMatrix(i),t.geometry.computeBoundingBox(),r=t.geometry.boundingBox.min.clone(),o=t.geometry.boundingBox.max.clone(),s.subVectors(o,r),s.multiplyScalar(.5),s.multiplyVectors(s,u);var l=new THREE.Vector3;l.x=(r.x+o.x)/2,l.y=(r.y+o.y)/2,l.z=(r.z+o.z)/2,l.multiplyVectors(l,u),n.children.push({shape:"box",halfExtents:{x:s.x,y:s.y,z:s.z},localTransform:{position:{x:a.x,y:a.y,z:a.z},rotation:{x:c.x,y:c.y,z:c.z,w:c.w}}})}}),n},i.prototype._createConvexHullMeshShape=function(t){var e={shape:"convex_hull_mesh",vertices:[]},i=0,n=new THREE.Matrix4,r=new THREE.Matrix4;return n.getInverse(t.matrixWorld),t.traverse(function(o){var s,a=o.geometry,c=new THREE.Vector3,u=new THREE.Vector3;if(r.copy(n),r.multiply(o.matrixWorld),o instanceof THREE.Mesh&&!o.isBB)if(c.getScaleFromMatrix(o.matrixWorld),a instanceof THREE.BufferGeometry){if(!a.attributes.position.array)return console.warn("BufferGeometry has no position attribute. Was it unloaded?");var l=a.attributes.position.array;for(s=0;s<l.length;s+=3)u.x=l[s+0],u.y=l[s+1],u.z=l[s+2],u.applyMatrix4(r),u.multiply(t.scale),e.vertices[9*i+0]=u.x,e.vertices[9*i+1]=u.y,e.vertices[9*i+2]=u.z,i++}else if(a instanceof THREE.Geometry)for(s=0;s<a.vertices.length;s++)u.copy(a.vertices[s]),u.applyMatrix4(r),u.multiply(t.scale),e.vertices[3*i+0]=u.x,e.vertices[3*i+1]=u.y,e.vertices[3*i+2]=u.z,i++}),e},i.prototype._createTriangleMeshShape=function(t,e){var i,n,r,o,s=new THREE.Matrix4,a=new THREE.Matrix4,c=new THREE.Vector3,u=0;return s.getInverse(t.matrixWorld),t.traverse(function(l){if(l instanceof THREE.Mesh&&!l.isBB)if(n=l.geometry,i=l,a.copy(s),a.multiply(l.matrixWorld),n instanceof THREE.BufferGeometry){if(!n.attributes.position.array)return console.warn("BufferGeometry has no position attribute. Was it unloaded?");for(var h,p,f,d,m=n.attributes.position.array,y=n.attributes.index.array,g=n.offsets,v=0,x=g.length;x>v;++v){var b=g[v].start,_=g[v].count,I=g[v].index;for(r=b,d=b+_;d>r;r+=3)h=I+y[r+0],p=I+y[r+1],f=I+y[r+2],c.x=m[3*h],c.y=m[3*h+1],c.z=m[3*h+2],c.applyMatrix4(a),c.multiply(t.scale),e.triangles[9*u+0]=c.x,e.triangles[9*u+1]=c.y,e.triangles[9*u+2]=c.z,c.x=m[3*p],c.y=m[3*p+1],c.z=m[3*p+2],c.applyMatrix4(a),c.multiply(t.scale),e.triangles[9*u+3]=c.x,e.triangles[9*u+4]=c.y,e.triangles[9*u+5]=c.z,c.x=m[3*f],c.y=m[3*f+1],c.z=m[3*f+2],c.applyMatrix4(a),c.multiply(t.scale),e.triangles[9*u+6]=c.x,e.triangles[9*u+7]=c.y,e.triangles[9*u+8]=c.z,u++}}else if(n instanceof THREE.Geometry)for(r=0;r<n.faces.length;r++)o=n.faces[r],c.copy(n.vertices[o.a]),c.applyMatrix4(a),c.multiply(t.scale),e.triangles[9*u+0]=c.x,e.triangles[9*u+1]=c.y,e.triangles[9*u+2]=c.z,c.copy(n.vertices[o.b]),c.applyMatrix4(a),c.multiply(t.scale),e.triangles[9*u+3]=c.x,e.triangles[9*u+4]=c.y,e.triangles[9*u+5]=c.z,c.copy(n.vertices[o.c]),c.applyMatrix4(a),c.multiply(t.scale),e.triangles[9*u+6]=c.x,e.triangles[9*u+7]=c.y,e.triangles[9*u+8]=c.z,u++}),e},i}),i("ammo_proxy",["when","underscore","ammo_worker_api","ammo_rigid_body","ammo_vehicle","ammo_point2point_constraint","ammo_hinge_constraint","ammo_slider_constraint","ammo_ghost_object","ammo_kinematic_character_controller","three/three_adapter"],function(t,e,i,n,r,o,s,a,c,u,l){function h(t){function n(t){o[t]=function(){return o.worker[t].apply(o.worker,arguments)}}var r,o=this,s=["on","fire","setStep","setIterations","setGravity","startSimulation","stopSimulation","getStats"];t=this.opts=t||{},t.gravity=t.gravity||{x:0,y:-9.82,z:0},t.iterations=t.iterations||10,t.step=t.step||1/60,t.maxBodies=t.maxBodies||1e3,t.maxVehicles=t.maxVehicles||32,t.maxWheelsPerVehicle=t.maxWheelsPerVehicle||8;var a=this.bodies=[],c=this.constraints=[],u=this.vehicles=[],h=this.ghosts=[],p=this.kinematicCharacterControllers=[];this.adapter=new l(this),this.worker=cw(new i(t)),this.worker.on("update",e.bind(this.update,this)),this.worker.on("error",function(t){console.error(t.message)}),this.worker.on("GhostObject_destroy",function(t){h[t]=void 0}),this.worker.on("RigidBody_destroy",function(t){a[t]=void 0}),this.worker.on("Vehicle_destroy",function(t){u[t]=void 0}),this.worker.on("Constraint_destroy",function(t){c[t]=void 0}),this.worker.on("KinematicCharacterController_destroy",function(t){p[t]=void 0}),this.worker.on("ghost_enter",e.bind(function(t){var e=this.getObjectByDescriptor(t.objectA),i=this.getObjectByDescriptor(t.objectB);e.trigger("ghost_enter",i,e),i.trigger("ghost_enter",e,i)},this)),this.worker.on("ghost_exit",e.bind(function(t){var e=this.getObjectByDescriptor(t.objectA),i=this.getObjectByDescriptor(t.objectB);e.trigger("ghost_exit",i,e),i.trigger("ghost_exit",e,i)},this));for(r in s)s.hasOwnProperty(r)&&n(s[r]);this.setStep(t.step),this.setIterations(t.iterations),this.setGravity(t.gravity)}return h.prototype.getObjectByDescriptor=function(t){switch(t.type){case"rigidBody":return this.bodies[t.id];case"ghost":return this.ghosts[t.id];default:return console.error("unknown type: ",t.type)}},h.prototype.execute=function(t,e){return this.worker[t](e)},h.prototype.aabbTest=function(t,e){return this.execute("Broadphase_aabbTest",{min:{x:t.x,y:t.y,z:t.z},max:{x:e.x,y:e.y,z:e.z}})},h.prototype.rayTestClosest=function(t,e){return this.execute("DynamicsWorld_rayTestClosest",{rayFromWorld:t,rayToWorld:e})},h.prototype.createVehicle=function(i,o){var s={bodyId:i instanceof n?i.bodyId:i,tuning:o},a=t.defer();return this.worker.Vehicle_create(s).then(e.bind(function(t){var e=this;setTimeout(function(){var n=new r(e,t,i);e.vehicles[t]=n,a.resolve(n)},0)},this)),a.promise},h.prototype.createGhostObject=function(i,n,r){var o={shape:i,position:n,quaternion:r},s=t.defer();return this.worker.GhostObject_create(o).then(e.bind(function(t){var e=this;setTimeout(function(){var i=new c(e,t);e.ghosts[t]=i,s.resolve(i)},0)},this)),s.promise},h.prototype.createKinematicCharacterController=function(i,n,r,o){var s={shape:i,position:n,quaternion:r,stepHeight:o},a=t.defer();return this.worker.KinematicCharacterController_create(s).then(e.bind(function(t){var e=this;setTimeout(function(){var i=new u(e,t);e.kinematicCharacterControllers[t]=i,a.resolve(i)
},0)},this)),a.promise},h.prototype.createRigidBody=function(i,r,o,s){var a={shape:i,mass:r,position:o,quaternion:s},c=t.defer();return this.worker.RigidBody_create(a).then(e.bind(function(t){var e=this;setTimeout(function(){var i=new n(e,t);e.bodies[t]=i,c.resolve(i)},0)},this)),c.promise},h.prototype.createPoint2PointConstraint=function(i,n,r,s){var a={rigidBodyIdA:i.bodyId,rigidBodyIdB:n.bodyId,pivotA:{x:r.x,y:r.y,z:r.z},pivotB:{x:s.x,y:s.y,z:s.z}},c=t.defer();return this.execute("Point2PointConstraint_create",a).then(e.bind(function(t){var e=this;setTimeout(function(){var i=new o(e,t);e.constraints[t]=i,c.resolve(i)},0)},this)),c.promise},h.prototype.createSliderConstraint=function(i,n,r,o){var s={rigidBodyIdA:i.bodyId,rigidBodyIdB:n.bodyId,frameInA:{position:{x:r.position.x,y:r.position.y,z:r.position.z},rotation:{x:r.rotation.x,y:r.rotation.y,z:r.rotation.z,w:r.rotation.w}},frameInB:{position:{x:o.position.x,y:o.position.y,z:o.position.z},rotation:{x:o.rotation.x,y:o.rotation.y,z:o.rotation.z,w:o.rotation.w}}},c=t.defer();return this.execute("SliderConstraint_create",s).then(e.bind(function(t){var e=this;setTimeout(function(){var i=new a(e,t);e.constraints[t]=i,c.resolve(i)},0)},this)),c.promise},h.prototype.createHingeConstraint=function(i,n,r,o,a,c){var u={rigidBodyIdA:i.bodyId,rigidBodyIdB:n.bodyId,pivotA:{x:r.x,y:r.y,z:r.z},pivotB:{x:o.x,y:o.y,z:o.z},axisA:{x:a.x,y:a.y,z:a.z},axisB:{x:c.x,y:c.y,z:c.z}},l=t.defer();return this.execute("HingeConstraint_create",u).then(e.bind(function(t){var e=this;setTimeout(function(){var i=new s(e,t);e.constraints[t]=i,l.resolve(i)},0)},this)),l.promise},h.prototype.update=function(t){this.next&&(this.worker.swap(this.data&&this.data.buffer),this.data=this.next),this.next=new Float64Array(t)},h.prototype.createRigidBodyFromObject=function(t,e,i){return this.adapter.createRigidBodyFromObject(t,e,i)},h.prototype.createKinematicCharacterControllerFromObject=function(t,e,i){return this.adapter.createKinematicCharacterControllerFromObject(t,e,i)},h.prototype.getRigidBodyOffset=function(t){return 7*t},h.prototype.getWheelOffset=function(t,e){return 7*this.opts.maxBodies+7*8*t+7*e},h.prototype.getVehicle=function(t){return this.vehicles[t]?this.vehicles[t]:(console.warn("Asked for non-existent vehicle with ID: "+t),void 0)},h.prototype.getKinematicCharacterControllerOffset=function(t){return 7*this.opts.maxBodies+7*8*this.opts.maxVehicles+7*t},h.prototype.getConstraint=function(t){return this.constraints[t]?this.constraints[t]:(console.warn("Asked for non-existent constraint with ID: "+t),void 0)},h.prototype.getRigidBody=function(t){return this.bodies[t]?this.bodies[t]:(console.warn("Asked for non-existent rigid body with ID: "+t),void 0)},h.prototype.getGhostObject=function(t){return this.ghosts[t]?this.ghosts[t]:(console.warn("Asked for non-existent ghost object with ID: "+t),void 0)},h}),e("ammo_proxy")});