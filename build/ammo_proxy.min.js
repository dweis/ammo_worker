/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/** @license MIT License (c) copyright 2011-2013 original author or authors */

/**
 * A lightweight CommonJS Promises/A and when() implementation
 * when is part of the cujo.js family of libraries (http://cujojs.com/)
 *
 * Licensed under the MIT License at:
 * http://www.opensource.org/licenses/mit-license.php
 *
 * @author Brian Cavalier
 * @author John Hann
 * @version 2.5.1
 */

//     Underscore.js 1.4.4
//     http://underscorejs.org
//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore may be freely distributed under the MIT license.

!function(t,e){"function"==typeof define&&define.amd?define(e):t.AmmoProxy=e()}(this,function(){var t,e,n;return function(i){function r(t,e){return b.call(t,e)}function o(t,e){var n,i,r,o,s,u,a,c,l,f,p=e&&e.split("/"),h=g.map,d=h&&h["*"]||{};if(t&&"."===t.charAt(0))if(e){for(p=p.slice(0,p.length-1),t=p.concat(t.split("/")),c=0;c<t.length;c+=1)if(f=t[c],"."===f)t.splice(c,1),c-=1;else if(".."===f){if(1===c&&(".."===t[2]||".."===t[0]))break;c>0&&(t.splice(c-1,2),c-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((p||d)&&h){for(n=t.split("/"),c=n.length;c>0;c-=1){if(i=n.slice(0,c).join("/"),p)for(l=p.length;l>0;l-=1)if(r=h[p.slice(0,l).join("/")],r&&(r=r[i])){o=r,s=c;break}if(o)break;!u&&d&&d[i]&&(u=d[i],a=c)}!o&&u&&(o=u,s=a),o&&(n.splice(0,s,o),t=n.join("/"))}return t}function s(t,e){return function(){return h.apply(i,w.call(arguments,0).concat([t,e]))}}function u(t){return function(e){return o(e,t)}}function a(t){return function(e){y[t]=e}}function c(t){if(r(v,t)){var e=v[t];delete v[t],x[t]=!0,p.apply(i,e)}if(!r(y,t)&&!r(x,t))throw new Error("No "+t);return y[t]}function l(t){var e,n=t?t.indexOf("!"):-1;return n>-1&&(e=t.substring(0,n),t=t.substring(n+1,t.length)),[e,t]}function f(t){return function(){return g&&g.config&&g.config[t]||{}}}var p,h,d,m,y={},v={},g={},x={},b=Object.prototype.hasOwnProperty,w=[].slice;d=function(t,e){var n,i=l(t),r=i[0];return t=i[1],r&&(r=o(r,e),n=c(r)),r?t=n&&n.normalize?n.normalize(t,u(e)):o(t,e):(t=o(t,e),i=l(t),r=i[0],t=i[1],r&&(n=c(r))),{f:r?r+"!"+t:t,n:t,pr:r,p:n}},m={require:function(t){return s(t)},exports:function(t){var e=y[t];return"undefined"!=typeof e?e:y[t]={}},module:function(t){return{id:t,uri:"",exports:y[t],config:f(t)}}},p=function(t,e,n,o){var u,l,f,p,h,g,b=[];if(o=o||t,"function"==typeof n){for(e=!e.length&&n.length?["require","exports","module"]:e,h=0;h<e.length;h+=1)if(p=d(e[h],o),l=p.f,"require"===l)b[h]=m.require(t);else if("exports"===l)b[h]=m.exports(t),g=!0;else if("module"===l)u=b[h]=m.module(t);else if(r(y,l)||r(v,l)||r(x,l))b[h]=c(l);else{if(!p.p)throw new Error(t+" missing "+l);p.p.load(p.n,s(o,!0),a(l),{}),b[h]=y[l]}f=n.apply(y[t],b),t&&(u&&u.exports!==i&&u.exports!==y[t]?y[t]=u.exports:f===i&&g||(y[t]=f))}else t&&(y[t]=n)},t=e=h=function(t,e,n,r,o){return"string"==typeof t?m[t]?m[t](e):c(d(t,e).f):(t.splice||(g=t,e.splice?(t=e,e=n,n=null):t=i),e=e||function(){},"function"==typeof n&&(n=r,r=o),r?p(i,t,e,n):setTimeout(function(){p(i,t,e,n)},4),h)},h.config=function(t){return g=t,g.deps&&h(g.deps,g.callback),h},n=function(t,e,n){e.splice||(n=e,e=[]),r(y,t)||r(v,t)||(v[t]=[t,e,n])},n.amd={jQuery:!0}}(),n("vendor/almond",function(){}),function(t,e){t("when",["require"],function(t){function n(t,e,n,r){return i(t).then(e,n,r)}function i(t){return t instanceof r?t:o(t)}function r(t,e){this._message=t,this.inspect=e}function o(t){return a(function(e){e(t)})}function s(t){return n(t,p)}function u(){function t(t,r,s){e.resolve=e.resolver.resolve=function(e){return i?o(e):(i=!0,t(e),n)},e.reject=e.resolver.reject=function(t){return i?o(p(t)):(i=!0,r(t),n)},e.notify=e.resolver.notify=function(t){return s(t),t}}var e,n,i;return e={promise:H,resolve:H,reject:H,notify:H,resolver:{resolve:H,reject:H,notify:H}},e.promise=n=a(t),e}function a(t){return c(t,Y.PromiseStatus&&Y.PromiseStatus())}function c(t,e){function n(t,e,n,i){function r(r){r._message(t,e,n,i)}f?f.push(r):B(function(){r(c)})}function i(){return c?c.inspect():z()}function o(t){if(f){var n=f;f=H,B(function(){c=m(a,t),e&&x(c,e),l(n,c)})}}function s(t){o(p(t))}function u(t){if(f){var e=f;B(function(){l(e,d(t))})}}var a,c,f=[];a=new r(n,i),a._status=e;try{t(o,s,u)}catch(h){s(h)}return a}function l(t,e){for(var n=0;n<t.length;n++)t[n](e)}function f(t){return h(new v(t),function(){return j(t)})}function p(t){return h(new g(t),function(){return O(t)})}function h(t,e){return new r(function(e,n,i){try{i(t[e].apply(t,n))}catch(r){i(p(r))}},e)}function d(t){return new r(function(e,n,i,r){var o=n[2];try{r("function"==typeof o?o(t):t)}catch(s){r(s)}})}function m(t,e){if(e===t)return p(new TypeError);if(e instanceof r)return e;try{var n=e===Object(e)&&e.then;return"function"==typeof n?y(n,e):f(e)}catch(i){return p(i)}}function y(t,e){return a(function(n,i){W(t,e,n,i)})}function v(t){this.value=t}function g(t){this.reason=t}function x(t,e){function n(){e.fulfilled()}function i(t){e.rejected(t)}t.then(n,i)}function b(t){return t&&"function"==typeof t.then}function w(t,e,i,r,o){return n(t,function(t){function s(i,r,o){function s(t){h(t)}function u(t){p(t)}var a,c,l,f,p,h,d,m;if(d=t.length>>>0,a=Math.max(0,Math.min(e,d)),l=[],c=d-a+1,f=[],a)for(h=function(t){f.push(t),--c||(p=h=E,r(f))},p=function(t){l.push(t),--a||(p=h=E,i(l))},m=0;d>m;++m)m in t&&n(t[m],u,s,o);else i(l)}return a(s).then(i,r,o)})}function _(t,e,n,i){function r(t){return e?e(t[0]):t[0]}return w(t,1,r,n,i)}function V(t,e,n,i){return R(t,E).then(e,n,i)}function I(){return R(arguments,E)}function S(t){return R(t,j,O)}function T(t,e){return R(t,e)}function R(t,e,i){return n(t,function(t){function r(r,o,s){function u(t,u){n(t,e,i).then(function(t){a[u]=t,--l||r(a)},o,s)}var a,c,l,f;if(l=c=t.length>>>0,a=[],!l)return r(a),void 0;for(f=0;c>f;f++)f in t?u(t[f],f):--l}return c(r)})}function A(t,e){var i=W(C,arguments,1);return n(t,function(t){var r;return r=t.length,i[0]=function(t,i,o){return n(t,function(t){return n(i,function(n){return e(t,n,o,r)})})},F.apply(t,i)})}function j(t){return{state:"fulfilled",value:t}}function O(t){return{state:"rejected",reason:t}}function z(){return{state:"pending"}}function B(t){1===q.push(t)&&P(k)}function k(){l(q),q=[]}function E(t){return t}n.promise=a,n.resolve=o,n.reject=s,n.defer=u,n.join=I,n.all=V,n.map=T,n.reduce=A,n.settle=S,n.any=_,n.some=w,n.isPromise=b,n.isPromiseLike=b,r.prototype={then:function(){var t,e;return t=arguments,e=this._message,c(function(n,i,r){e("when",t,n,r)},this._status&&this._status.observed())},otherwise:function(t){return this.then(H,t)},ensure:function(t){function e(){return o(t())}return"function"==typeof t?this.then(e,e).yield(this):this},yield:function(t){return this.then(function(){return t})},tap:function(t){return this.then(t).yield(this)},spread:function(t){return this.then(function(e){return V(e,function(e){return t.apply(H,e)})})},always:function(t,e){return this.then(t,t,e)}},v.prototype.when=function(t){return"function"==typeof t?t(this.value):this.value},g.prototype.when=function(t,e){if("function"==typeof e)return e(this.reason);throw this.reason};var F,C,W,P,q,M,D,Z,X,Y,N,Q,H;if(N=t,q=[],M=e.setTimeout,Y="undefined"!=typeof console?console:n,"object"==typeof process&&process.nextTick)P=process.nextTick;else if(Q=e.MutationObserver||e.WebKitMutationObserver)P=function(t,e,n){var i=t.createElement("div");return new e(n).observe(i,{attributes:!0}),function(){i.setAttribute("x","x")}}(document,Q,k);else try{P=N("vertx").runOnLoop||N("vertx").runOnContext}catch(L){P=function(t){M(t,0)}}return D=Function.prototype,Z=D.call,W=D.bind?Z.bind(Z):function(t,e){return t.apply(e,C.call(arguments,2))},X=[],C=X.slice,F=X.reduce||function(t){var e,n,i,r,o;if(o=0,e=Object(this),r=e.length>>>0,n=arguments,n.length<=1)for(;;){if(o in e){i=e[o++];break}if(++o>=r)throw new TypeError}else i=n[1];for(;r>o;++o)o in e&&(i=t(i,e[o],o,e));return i},n})}("function"==typeof n&&n.amd?n:function(t){module.exports=t(e)},this),function(){var t=this,e=t._,i={},r=Array.prototype,o=Object.prototype,s=Function.prototype,u=r.push,a=r.slice,c=r.concat,l=o.toString,f=o.hasOwnProperty,p=r.forEach,h=r.map,d=r.reduce,m=r.reduceRight,y=r.filter,v=r.every,g=r.some,x=r.indexOf,b=r.lastIndexOf,w=Array.isArray,_=Object.keys,V=s.bind,I=function(t){return t instanceof I?t:this instanceof I?(this._wrapped=t,void 0):new I(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=I),exports._=I):t._=I,I.VERSION="1.4.4";var S=I.each=I.forEach=function(t,e,n){if(null!=t)if(p&&t.forEach===p)t.forEach(e,n);else if(t.length===+t.length){for(var r=0,o=t.length;o>r;r++)if(e.call(n,t[r],r,t)===i)return}else for(var s in t)if(I.has(t,s)&&e.call(n,t[s],s,t)===i)return};I.map=I.collect=function(t,e,n){var i=[];return null==t?i:h&&t.map===h?t.map(e,n):(S(t,function(t,r,o){i[i.length]=e.call(n,t,r,o)}),i)};var T="Reduce of empty array with no initial value";I.reduce=I.foldl=I.inject=function(t,e,n,i){var r=arguments.length>2;if(null==t&&(t=[]),d&&t.reduce===d)return i&&(e=I.bind(e,i)),r?t.reduce(e,n):t.reduce(e);if(S(t,function(t,o,s){r?n=e.call(i,n,t,o,s):(n=t,r=!0)}),!r)throw new TypeError(T);return n},I.reduceRight=I.foldr=function(t,e,n,i){var r=arguments.length>2;if(null==t&&(t=[]),m&&t.reduceRight===m)return i&&(e=I.bind(e,i)),r?t.reduceRight(e,n):t.reduceRight(e);var o=t.length;if(o!==+o){var s=I.keys(t);o=s.length}if(S(t,function(u,a,c){a=s?s[--o]:--o,r?n=e.call(i,n,t[a],a,c):(n=t[a],r=!0)}),!r)throw new TypeError(T);return n},I.find=I.detect=function(t,e,n){var i;return R(t,function(t,r,o){return e.call(n,t,r,o)?(i=t,!0):void 0}),i},I.filter=I.select=function(t,e,n){var i=[];return null==t?i:y&&t.filter===y?t.filter(e,n):(S(t,function(t,r,o){e.call(n,t,r,o)&&(i[i.length]=t)}),i)},I.reject=function(t,e,n){return I.filter(t,function(t,i,r){return!e.call(n,t,i,r)},n)},I.every=I.all=function(t,e,n){e||(e=I.identity);var r=!0;return null==t?r:v&&t.every===v?t.every(e,n):(S(t,function(t,o,s){return(r=r&&e.call(n,t,o,s))?void 0:i}),!!r)};var R=I.some=I.any=function(t,e,n){e||(e=I.identity);var r=!1;return null==t?r:g&&t.some===g?t.some(e,n):(S(t,function(t,o,s){return r||(r=e.call(n,t,o,s))?i:void 0}),!!r)};I.contains=I.include=function(t,e){return null==t?!1:x&&t.indexOf===x?-1!=t.indexOf(e):R(t,function(t){return t===e})},I.invoke=function(t,e){var n=a.call(arguments,2),i=I.isFunction(e);return I.map(t,function(t){return(i?e:t[e]).apply(t,n)})},I.pluck=function(t,e){return I.map(t,function(t){return t[e]})},I.where=function(t,e,n){return I.isEmpty(e)?n?null:[]:I[n?"find":"filter"](t,function(t){for(var n in e)if(e[n]!==t[n])return!1;return!0})},I.findWhere=function(t,e){return I.where(t,e,!0)},I.max=function(t,e,n){if(!e&&I.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.max.apply(Math,t);if(!e&&I.isEmpty(t))return-1/0;var i={computed:-1/0,value:-1/0};return S(t,function(t,r,o){var s=e?e.call(n,t,r,o):t;s>=i.computed&&(i={value:t,computed:s})}),i.value},I.min=function(t,e,n){if(!e&&I.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.min.apply(Math,t);if(!e&&I.isEmpty(t))return 1/0;var i={computed:1/0,value:1/0};return S(t,function(t,r,o){var s=e?e.call(n,t,r,o):t;s<i.computed&&(i={value:t,computed:s})}),i.value},I.shuffle=function(t){var e,n=0,i=[];return S(t,function(t){e=I.random(n++),i[n-1]=i[e],i[e]=t}),i};var A=function(t){return I.isFunction(t)?t:function(e){return e[t]}};I.sortBy=function(t,e,n){var i=A(e);return I.pluck(I.map(t,function(t,e,r){return{value:t,index:e,criteria:i.call(n,t,e,r)}}).sort(function(t,e){var n=t.criteria,i=e.criteria;if(n!==i){if(n>i||void 0===n)return 1;if(i>n||void 0===i)return-1}return t.index<e.index?-1:1}),"value")};var j=function(t,e,n,i){var r={},o=A(e||I.identity);return S(t,function(e,s){var u=o.call(n,e,s,t);i(r,u,e)}),r};I.groupBy=function(t,e,n){return j(t,e,n,function(t,e,n){(I.has(t,e)?t[e]:t[e]=[]).push(n)})},I.countBy=function(t,e,n){return j(t,e,n,function(t,e){I.has(t,e)||(t[e]=0),t[e]++})},I.sortedIndex=function(t,e,n,i){n=null==n?I.identity:A(n);for(var r=n.call(i,e),o=0,s=t.length;s>o;){var u=o+s>>>1;n.call(i,t[u])<r?o=u+1:s=u}return o},I.toArray=function(t){return t?I.isArray(t)?a.call(t):t.length===+t.length?I.map(t,I.identity):I.values(t):[]},I.size=function(t){return null==t?0:t.length===+t.length?t.length:I.keys(t).length},I.first=I.head=I.take=function(t,e,n){return null==t?void 0:null==e||n?t[0]:a.call(t,0,e)},I.initial=function(t,e,n){return a.call(t,0,t.length-(null==e||n?1:e))},I.last=function(t,e,n){return null==t?void 0:null==e||n?t[t.length-1]:a.call(t,Math.max(t.length-e,0))},I.rest=I.tail=I.drop=function(t,e,n){return a.call(t,null==e||n?1:e)},I.compact=function(t){return I.filter(t,I.identity)};var O=function(t,e,n){return S(t,function(t){I.isArray(t)?e?u.apply(n,t):O(t,e,n):n.push(t)}),n};I.flatten=function(t,e){return O(t,e,[])},I.without=function(t){return I.difference(t,a.call(arguments,1))},I.uniq=I.unique=function(t,e,n,i){I.isFunction(e)&&(i=n,n=e,e=!1);var r=n?I.map(t,n,i):t,o=[],s=[];return S(r,function(n,i){(e?i&&s[s.length-1]===n:I.contains(s,n))||(s.push(n),o.push(t[i]))}),o},I.union=function(){return I.uniq(c.apply(r,arguments))},I.intersection=function(t){var e=a.call(arguments,1);return I.filter(I.uniq(t),function(t){return I.every(e,function(e){return I.indexOf(e,t)>=0})})},I.difference=function(t){var e=c.apply(r,a.call(arguments,1));return I.filter(t,function(t){return!I.contains(e,t)})},I.zip=function(){for(var t=a.call(arguments),e=I.max(I.pluck(t,"length")),n=new Array(e),i=0;e>i;i++)n[i]=I.pluck(t,""+i);return n},I.object=function(t,e){if(null==t)return{};for(var n={},i=0,r=t.length;r>i;i++)e?n[t[i]]=e[i]:n[t[i][0]]=t[i][1];return n},I.indexOf=function(t,e,n){if(null==t)return-1;var i=0,r=t.length;if(n){if("number"!=typeof n)return i=I.sortedIndex(t,e),t[i]===e?i:-1;i=0>n?Math.max(0,r+n):n}if(x&&t.indexOf===x)return t.indexOf(e,n);for(;r>i;i++)if(t[i]===e)return i;return-1},I.lastIndexOf=function(t,e,n){if(null==t)return-1;var i=null!=n;if(b&&t.lastIndexOf===b)return i?t.lastIndexOf(e,n):t.lastIndexOf(e);for(var r=i?n:t.length;r--;)if(t[r]===e)return r;return-1},I.range=function(t,e,n){arguments.length<=1&&(e=t||0,t=0),n=arguments[2]||1;for(var i=Math.max(Math.ceil((e-t)/n),0),r=0,o=new Array(i);i>r;)o[r++]=t,t+=n;return o},I.bind=function(t,e){if(t.bind===V&&V)return V.apply(t,a.call(arguments,1));var n=a.call(arguments,2);return function(){return t.apply(e,n.concat(a.call(arguments)))}},I.partial=function(t){var e=a.call(arguments,1);return function(){return t.apply(this,e.concat(a.call(arguments)))}},I.bindAll=function(t){var e=a.call(arguments,1);return 0===e.length&&(e=I.functions(t)),S(e,function(e){t[e]=I.bind(t[e],t)}),t},I.memoize=function(t,e){var n={};return e||(e=I.identity),function(){var i=e.apply(this,arguments);return I.has(n,i)?n[i]:n[i]=t.apply(this,arguments)}},I.delay=function(t,e){var n=a.call(arguments,2);return setTimeout(function(){return t.apply(null,n)},e)},I.defer=function(t){return I.delay.apply(I,[t,1].concat(a.call(arguments,1)))},I.throttle=function(t,e){var n,i,r,o,s=0,u=function(){s=new Date,r=null,o=t.apply(n,i)};return function(){var a=new Date,c=e-(a-s);return n=this,i=arguments,0>=c?(clearTimeout(r),r=null,s=a,o=t.apply(n,i)):r||(r=setTimeout(u,c)),o}},I.debounce=function(t,e,n){var i,r;return function(){var o=this,s=arguments,u=function(){i=null,n||(r=t.apply(o,s))},a=n&&!i;return clearTimeout(i),i=setTimeout(u,e),a&&(r=t.apply(o,s)),r}},I.once=function(t){var e,n=!1;return function(){return n?e:(n=!0,e=t.apply(this,arguments),t=null,e)}},I.wrap=function(t,e){return function(){var n=[t];return u.apply(n,arguments),e.apply(this,n)}},I.compose=function(){var t=arguments;return function(){for(var e=arguments,n=t.length-1;n>=0;n--)e=[t[n].apply(this,e)];return e[0]}},I.after=function(t,e){return 0>=t?e():function(){return--t<1?e.apply(this,arguments):void 0}},I.keys=_||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var n in t)I.has(t,n)&&(e[e.length]=n);return e},I.values=function(t){var e=[];for(var n in t)I.has(t,n)&&e.push(t[n]);return e},I.pairs=function(t){var e=[];for(var n in t)I.has(t,n)&&e.push([n,t[n]]);return e},I.invert=function(t){var e={};for(var n in t)I.has(t,n)&&(e[t[n]]=n);return e},I.functions=I.methods=function(t){var e=[];for(var n in t)I.isFunction(t[n])&&e.push(n);return e.sort()},I.extend=function(t){return S(a.call(arguments,1),function(e){if(e)for(var n in e)t[n]=e[n]}),t},I.pick=function(t){var e={},n=c.apply(r,a.call(arguments,1));return S(n,function(n){n in t&&(e[n]=t[n])}),e},I.omit=function(t){var e={},n=c.apply(r,a.call(arguments,1));for(var i in t)I.contains(n,i)||(e[i]=t[i]);return e},I.defaults=function(t){return S(a.call(arguments,1),function(e){if(e)for(var n in e)null==t[n]&&(t[n]=e[n])}),t},I.clone=function(t){return I.isObject(t)?I.isArray(t)?t.slice():I.extend({},t):t},I.tap=function(t,e){return e(t),t};var z=function(t,e,n,i){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof I&&(t=t._wrapped),e instanceof I&&(e=e._wrapped);var r=l.call(t);if(r!=l.call(e))return!1;switch(r){case"[object String]":return t==String(e);case"[object Number]":return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if("object"!=typeof t||"object"!=typeof e)return!1;for(var o=n.length;o--;)if(n[o]==t)return i[o]==e;n.push(t),i.push(e);var s=0,u=!0;if("[object Array]"==r){if(s=t.length,u=s==e.length)for(;s--&&(u=z(t[s],e[s],n,i)););}else{var a=t.constructor,c=e.constructor;if(a!==c&&!(I.isFunction(a)&&a instanceof a&&I.isFunction(c)&&c instanceof c))return!1;for(var f in t)if(I.has(t,f)&&(s++,!(u=I.has(e,f)&&z(t[f],e[f],n,i))))break;if(u){for(f in e)if(I.has(e,f)&&!s--)break;u=!s}}return n.pop(),i.pop(),u};I.isEqual=function(t,e){return z(t,e,[],[])},I.isEmpty=function(t){if(null==t)return!0;if(I.isArray(t)||I.isString(t))return 0===t.length;for(var e in t)if(I.has(t,e))return!1;return!0},I.isElement=function(t){return!(!t||1!==t.nodeType)},I.isArray=w||function(t){return"[object Array]"==l.call(t)},I.isObject=function(t){return t===Object(t)},S(["Arguments","Function","String","Number","Date","RegExp"],function(t){I["is"+t]=function(e){return l.call(e)=="[object "+t+"]"}}),I.isArguments(arguments)||(I.isArguments=function(t){return!(!t||!I.has(t,"callee"))}),"function"!=typeof/./&&(I.isFunction=function(t){return"function"==typeof t}),I.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},I.isNaN=function(t){return I.isNumber(t)&&t!=+t},I.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==l.call(t)},I.isNull=function(t){return null===t},I.isUndefined=function(t){return void 0===t},I.has=function(t,e){return f.call(t,e)},I.noConflict=function(){return t._=e,this},I.identity=function(t){return t},I.times=function(t,e,n){for(var i=Array(t),r=0;t>r;r++)i[r]=e.call(n,r);return i},I.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))};var B={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};B.unescape=I.invert(B.escape);var k={escape:new RegExp("["+I.keys(B.escape).join("")+"]","g"),unescape:new RegExp("("+I.keys(B.unescape).join("|")+")","g")};I.each(["escape","unescape"],function(t){I[t]=function(e){return null==e?"":(""+e).replace(k[t],function(e){return B[t][e]})}}),I.result=function(t,e){if(null==t)return null;var n=t[e];return I.isFunction(n)?n.call(t):n},I.mixin=function(t){S(I.functions(t),function(e){var n=I[e]=t[e];I.prototype[e]=function(){var t=[this._wrapped];return u.apply(t,arguments),P.call(this,n.apply(I,t))}})};var E=0;I.uniqueId=function(t){var e=++E+"";return t?t+e:e},I.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var F=/(.)^/,C={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},W=/\\|'|\r|\n|\t|\u2028|\u2029/g;I.template=function(t,e,n){var i;n=I.defaults({},n,I.templateSettings);var r=new RegExp([(n.escape||F).source,(n.interpolate||F).source,(n.evaluate||F).source].join("|")+"|$","g"),o=0,s="__p+='";t.replace(r,function(e,n,i,r,u){return s+=t.slice(o,u).replace(W,function(t){return"\\"+C[t]}),n&&(s+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),i&&(s+="'+\n((__t=("+i+"))==null?'':__t)+\n'"),r&&(s+="';\n"+r+"\n__p+='"),o=u+e.length,e}),s+="';\n",n.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{i=new Function(n.variable||"obj","_",s)}catch(u){throw u.source=s,u}if(e)return i(e,I);var a=function(t){return i.call(this,t,I)};return a.source="function("+(n.variable||"obj")+"){\n"+s+"}",a},I.chain=function(t){return I(t).chain()};var P=function(t){return this._chain?I(t).chain():t};I.mixin(I),S(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=r[t];I.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!=t&&"splice"!=t||0!==n.length||delete n[0],P.call(this,n)}}),S(["concat","join","slice"],function(t){var e=r[t];I.prototype[t]=function(){return P.call(this,e.apply(this._wrapped,arguments))}}),I.extend(I.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof n&&n.amd&&n("underscore",[],function(){return I})}.call(this),n("ammo_worker_api",[],function(){function t(t){this.maxBodies=1e3,this.maxVehicles=32,this.maxWheelsPerVehicle=8;for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e])}return t.prototype={init:function(){importScripts("http://assets.verold.com/verold_api/lib/ammo.js"),this.tmpVec=[new Ammo.btVector3,new Ammo.btVector3,new Ammo.btVector3],this.tmpQuaternion=[new Ammo.btQuaternion],this.tmpTrans=[new Ammo.btTransform],this.bodies=[],this.vehicles=[],this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.fire("ready")},startSimulation:function(){var t,e=this,n=0,i=0,r=1,o=8*7*this.maxBodies+8*7*this.maxVehicles*this.maxWheelsPerVehicle;this.buffers=[new ArrayBuffer(o),new ArrayBuffer(o),new ArrayBuffer(o)],t=Date.now(),this.simulationTimerId=setInterval(function(){var o,s,u,a,c,l=Date.now(),f=l-t||1;e.dynamicsWorld.stepSimulation(e.step,e.iterations);var p;p=n>0?Math.min(.1,f/1e3):.1,n=p*f+(1-p)*n;var h=1/r++;if(i=h*f+(1-h)*i,t=Date.now(),e.buffers.length>0&&(s=new Float64Array(e.buffers.pop())),s&&s.buffer instanceof ArrayBuffer){for(u in e.bodies)e.bodies[u]&&(e.tmpTrans[0].setIdentity(),e.bodies[u].getMotionState().getWorldTransform(e.tmpTrans[0]),s[7*u+0]=e.tmpTrans[0].getOrigin().x(),s[7*u+1]=e.tmpTrans[0].getOrigin().y(),s[7*u+2]=e.tmpTrans[0].getOrigin().z(),s[7*u+3]=e.tmpTrans[0].getRotation().x(),s[7*u+4]=e.tmpTrans[0].getRotation().y(),s[7*u+5]=e.tmpTrans[0].getRotation().z(),s[7*u+6]=e.tmpTrans[0].getRotation().w());for(u in e.vehicles)if(e.vehicles[u])for(o=e.vehicles[u],a=0;a<o.getNumWheels()+1;a++)e.tmpTrans[0]=o.getWheelInfo(a).get_m_worldTransform(),c=7*e.maxBodies+7*u*e.maxWheelsPerVehicle+7*a,s[c+0]=e.tmpTrans[0].getOrigin().x(),s[c+1]=e.tmpTrans[0].getOrigin().y(),s[c+2]=e.tmpTrans[0].getOrigin().z(),s[c+3]=e.tmpTrans[0].getRotation().x(),s[c+4]=e.tmpTrans[0].getRotation().y(),s[c+5]=e.tmpTrans[0].getRotation().z(),s[c+6]=e.tmpTrans[0].getRotation().w();e.fire("update",s.buffer,[s.buffer]),e.fire("stats",{currFPS:Math.round(1e3/n),allFPS:Math.round(1e3/i)})}},1e3*this.step)},stopSimulation:function(){this.simulationTimerId&&clearInterval(this.simulationTimerId)},swap:function(t){t instanceof ArrayBuffer&&this.buffers.push(t)},setStep:function(t){this.step=t},setIterations:function(t){this.iterations=t},setGravity:function(t){this.tmpVec[0].setX(t.x),this.tmpVec[0].setY(t.y),this.tmpVec[0].setZ(t.z),this.dynamicsWorld.setGravity(this.tmpVec[0])},_createCompoundShape:function(t){var e,n,i=new Ammo.btCompoundShape,r=this.tmpTrans[0];if(t.children&&t.children.length)for(var o in t.children)t.children.hasOwnProperty(o)&&(e=t.children[o],n=this._createShape(e),r.setIdentity(),this.tmpVec[0].setX(e.localTransform.position.x),this.tmpVec[0].setY(e.localTransform.position.y),this.tmpVec[0].setZ(e.localTransform.position.z),r.setOrigin(this.tmpVec[0]),this.tmpQuaternion[0].setX(e.localTransform.rotation.x),this.tmpQuaternion[0].setY(e.localTransform.rotation.y),this.tmpQuaternion[0].setZ(e.localTransform.rotation.z),this.tmpQuaternion[0].setW(e.localTransform.rotation.w),r.setRotation(this.tmpQuaternion[0]),i.addChildShape(r,n));return i},_createShape:function(t){var e;switch(t.shape){case"box":this.tmpVec[0].setX(t.halfExtents.x),this.tmpVec[0].setY(t.halfExtents.y),this.tmpVec[0].setZ(t.halfExtents.z),e=new Ammo.btBoxShape(this.tmpVec[0]);break;case"sphere":e=new Ammo.btSphereShape(t.radius);break;case"staticplane":this.tmpVec[0].setX(t.normal.x),this.tmpVec[0].setY(t.normal.y),this.tmpVec[0].setZ(t.normal.z),e=new Ammo.btStaticPlaneShape(this.tmpVec[0],t.distance);break;case"cylinder":this.tmpVec[0].setX(t.width),this.tmpVec[0].setY(t.height),this.tmpVec[0].setZ(t.depth),e=new Ammo.btCylinderShape(this.tmpVec[0]);break;case"capsule":e=new Ammo.btCapsuleShape(t.radius,t.height);break;case"cone":e=new Ammo.btConeShape(t.radius,t.height);break;case"compound":e=this._createCompoundShape(t);break;default:return console.error("Unknown shape: "+t.shape)}return e},Vehicle_create:function(t,e){var n,i=new Ammo.btVehicleTuning,r=this.bodies[t.bodyId];if(!r)return console.error("could not find body");t.tuning&&(t.tuning.suspensionStiffness&&i.set_m_suspensionStiffness(t.tuning.suspensionStiffness),t.tuning.suspensionCompression&&i.set_m_suspensionCompression(t.tuning.suspensionCompression),t.tuning.suspensionDamping&&i.set_m_suspensionDamping(t.tuning.suspensionDamping),t.tuning.maxSuspensionTravelCm&&i.set_m_maxSuspensionTravelCm(t.tuning.maxSuspensionTravelCm),t.tuning.maxSuspensionForce&&i.set_m_maxSuspensionForce(t.tuning.maxSuspensionForce),t.tuning.frictionSlip&&i.set_m_frictionSlip(t.tuning.frictionSlip)),n=new Ammo.btRaycastVehicle(i,r,new Ammo.btDefaultVehicleRaycaster(this.dynamicsWorld)),n.tuning=i,r.setActivationState(4),n.setCoordinateSystem(0,1,2),this.dynamicsWorld.addVehicle(n);var o=this.vehicles.push(n)-1;"function"==typeof e&&e(o)},Vehicle_destroy:function(t){this.dynamicsWorld.removeVehicle(this.vehicles[t]),this.vehicles[t]=void 0},Vehicle_addWheel:function(t,e){var n=this.vehicles[t.vehicleId];if(void 0!==n){var i=n.tuning,r=this.tmpVec[0],o=this.tmpVec[1],s=this.tmpVec[2];"object"==typeof t.tuning&&(i=new Ammo.btVehicleTuning,t.tuning.suspensionStiffness&&i.set_m_suspensionStiffness(t.tuning.suspensionStiffness),t.tuning.suspensionCompression&&i.set_m_suspensionCompression(t.tuning.suspensionCompression),t.tuning.suspensionDamping&&i.set_m_suspensionDamping(t.tuning.suspensionDamping),t.tuning.maxSuspensionTravelCm&&i.set_m_maxSuspensionTravelCm(t.tuning.maxSuspensionTravelCm),t.tuning.maxSuspensionForce&&i.set_m_maxSuspensionForce(t.tuning.maxSuspensionForce),t.tuning.frictionSlip&&i.set_m_frictionSlip(t.tuning.frictionSlip)),r.setX(t.connectionPoint.x),r.setY(t.connectionPoint.y),r.setZ(t.connectionPoint.z),o.setX(t.wheelDirection.x),o.setY(t.wheelDirection.y),o.setZ(t.wheelDirection.z),s.setX(t.wheelAxle.x),s.setY(t.wheelAxle.y),s.setZ(t.wheelAxle.z),n.addWheel(r,o,s,t.suspensionRestLength,t.wheelRadius,i,t.isFrontWheel),"function"==typeof e&&e(n.getNumWheels()-1)}},Vehicle_setSteeringValue:function(t){var e=this.vehicles[t.vehicleId];e&&this.vehicles[t.vehicleId].setSteeringValue(t.steeringValue,t.wheelIndex)},Vehicle_setBrake:function(t){var e=this.vehicles[t.vehicleId];e&&this.vehicles[t.vehicleId].setBrake(t.brake,t.wheelIndex)},Vehicle_setWheelInfo:function(t){var e,n=this.vehicles[t.vehicleId];if(n){e=this.vehicles[t.vehicleId].getWheelInfo(t.wheelIndex);for(var i in t.properties)t.properties.hasOwnProperty(i)&&e["set_m_"+i](t.properties[i])}},Vehicle_applyEngineForce:function(t){var e=this.vehicles[t.vehicleId];e&&this.vehicles[t.vehicleId].applyEngineForce(t.force,t.wheelIndex)},RigidBody_create:function(t,e){var n,i,r,o,s=this.tmpTrans[0],u=0!==t.mass,a=this.tmpVec[0],c=this.tmpVec[1],l=this.tmpQuaternion[0];s.setIdentity(),a.setZero(),n=this._createShape(t.shape),u&&n.calculateLocalInertia(t.mass,a),c.setX(t.position.x),c.setY(t.position.y),c.setZ(t.position.z),l.setX(t.quaternion.x),l.setY(t.quaternion.y),l.setZ(t.quaternion.z),l.setW(t.quaternion.w),s.setOrigin(c),s.setRotation(l),i=new Ammo.btDefaultMotionState(s),r=new Ammo.btRigidBodyConstructionInfo(t.mass,i,n,a),o=new Ammo.btRigidBody(r),this.dynamicsWorld.addRigidBody(o);var f=this.bodies.push(o)-1;"function"==typeof e&&e(f)},RigidBody_applyForce:function(t,e){var n=this.bodies[t.bodyId];n&&(this.tmpVec[0].setX(t.force.x),this.tmpVec[0].setY(t.force.y),this.tmpVec[0].setZ(t.force.z),this.tmpVec[1].setX(t.relativePosition.x),this.tmpVec[1].setY(t.relativePosition.y),this.tmpVec[1].setZ(t.relativePosition.z),n.applyForce(this.tmpVec[0],this.tmpVec[1])),"function"==typeof e&&e()},RigidBody_applyImpulse:function(t,e){var n=this.bodies[t.bodyId];n&&(this.tmpVec[0].setX(t.impulse.x),this.tmpVec[0].setY(t.impulse.y),this.tmpVec[0].setZ(t.impulse.z),this.tmpVec[1].setX(t.relativePosition.x),this.tmpVec[1].setY(t.relativePosition.y),this.tmpVec[1].setZ(t.relativePosition.z),n.applyImpulse(this.tmpVec[0],this.tmpVec[1])),"function"==typeof e&&e()},RigidBody_applyTorque:function(t,e){var n=this.bodies[t.bodyId];n&&(this.tmpVec[0].setX(t.torque.x),this.tmpVec[0].setY(t.torque.y),this.tmpVec[0].setZ(t.torque.z),n.applyTorque(this.tmpVec[0])),"function"==typeof e&&e()},RigidBody_setRestitution:function(t,e){var n=this.bodies[t.bodyId];n&&n.setRestitution(t.restitution),"function"==typeof e&&e()},RigidBody_setFriction:function(t,e){var n=this.bodies[t.bodyId];n&&n.setFriction(t.friction),"function"==typeof e&&e()},RigidBody_destroy:function(t){this.dynamicsWorld.removeRigidBody(this.bodies[t]),Ammo.destroy(this.bodies[t]),this.bodies[t]=void 0},shutdown:function(){Ammo.destroy(this.collisionConfiguration),Ammo.destroy(this.dispatcher),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.solver)}},t}),n("ammo_rigid_body",[],function(){function t(t,e){this.proxy=t,this.bodyId=e,this.object=void 0}return t.prototype.update=function(){var t,e,n;this.object&&this.proxy&&this.proxy.data&&(n=this.proxy.getRigidBodyOffset(this.bodyId),t=this.object.position,e=this.object.quaternion,t.x=this.proxy.data[n+0],t.y=this.proxy.data[n+1],t.z=this.proxy.data[n+2],e.x=this.proxy.data[n+3],e.y=this.proxy.data[n+4],e.z=this.proxy.data[n+5],e.w=this.proxy.data[n+6])},t.prototype.applyTorque=function(t){return this.proxy.execute("RigidBody_applyTorque",{bodyId:this.bodyId,torque:{x:t.x,y:t.y,z:t.z}})},t.prototype.applyForce=function(t,e){return this.proxy.execute("RigidBody_applyForce",{bodyId:this.bodyId,force:t,relativePosition:e||{x:0,y:0,z:0}})},t.prototype.applyCentralForce=function(t){return this.proxy.execute("RigidBody_applyCentralForce",{bodyId:this.bodyId,force:{x:t.x,y:t.y,z:t.z}})},t.prototype.applyImpulse=function(t,e){return this.proxy.execute("RigidBody_applyImpulse",{bodyId:this.bodyId,impulse:{x:t.x,y:t.y,z:t.z},relativePosition:e&&{x:e.x,y:e.y,z:e.z}||{x:0,y:0,z:0}})},t.prototype.applyCentralImpulse=function(t){return this.proxy.execute("RigidBody_applyCentralImpulse",{bodyId:this.bodyId,impulse:{x:t.x,y:t.y,z:t.z}})},t.prototype.setFriction=function(t){return this.proxy.execute("RigidBody_setFriction",{bodyId:this.bodyId,friction:t})},t.prototype.setRestitution=function(t){return this.proxy.execute("RigidBody_setRestitution",{bodyId:this.bodyId,restitution:t})},t.prototype.destroy=function(){return this.proxy.execute("RigidBody_destroy",{bodyId:this.bodyId})},t.prototype.setObject=function(t){this.object=t},t}),n("ammo_vehicle",[],function(){function t(t,e){this.proxy=t,this.vehicleId=e,this.wheelObjects=[]}return t.prototype.addWheel=function(t,e,n,i,r,o,s){var u={vehicleId:this.vehicleId,connectionPoint:t,wheelDirection:e,wheelAxle:n,suspensionRestLength:i,wheelRadius:r,isFrontWheel:o,tuning:s};return this.proxy.execute("Vehicle_addWheel",u)},t.prototype.setWheelInfo=function(t,e){var n={vehicleId:this.vehicleId,wheelIndex:t,properties:e};
return this.proxy.execute("Vehicle_setWheelInfo",n)},t.prototype.setBrake=function(t,e){var n={vehicleId:this.vehicleId,wheelIndex:t,brake:e};return this.proxy.execute("Vehicle_setBrake",n)},t.prototype.applyEngineForce=function(t,e){var n={vehicleId:this.vehicleId,wheelIndex:t,force:e};return this.proxy.execute("Vehicle_applyEngineForce",n)},t.prototype.setSteeringValue=function(t,e){var n={vehicleId:this.vehicleId,wheelIndex:t,steeringValue:e};return this.proxy.execute("Vehicle_setSteeringValue",n)},t.prototype.destroy=function(){var t={vehicleId:this.vehicleId};return this.proxy.execute("Vehicle_destroy",t)},t.prototype.addWheelObject=function(t,e){this.wheelObjects[t]=e},t.prototype.update=function(){for(var t in this.wheelObjects)this.wheelObjects.hasOwnProperty(t)&&this._updateWheel(this.wheelObjects[t],t)},t.prototype._updateWheel=function(t,e){var n,i,r,o=this.proxy.data;o&&(r=this.proxy.getWheelOffset(this.vehicleId,e),n=t.position,i=t.quaternion,n.x=o[r+0],n.y=o[r+1],n.z=o[r+2],i.x=o[r+3],i.y=o[r+4],i.z=o[r+5],i.w=o[r+6])},t}),n("ammo_proxy",["when","underscore","ammo_worker_api","ammo_rigid_body","ammo_vehicle"],function(t,e,n,i,r){function o(t){function i(t){o[t]=function(){return o.worker[t].apply(o.worker,arguments)}}var r,o=this,s=["on","fire","setStep","setIterations","setGravity","startSimulation","stopSimulation"];t=this.opts=t||{},t.gravity=t.gravity||{x:0,y:-9.82,z:0},t.iterations=t.iterations||10,t.step=t.step||1/60,t.maxBodies=t.maxBodies||1e3,t.maxVehicles=t.maxVehicles||32,t.maxWheelsPerVehicle=t.maxWheelsPerVehicle||8,this.worker=cw(new n(t)),this.worker.on("update",e.bind(this.update,this)),this.worker.on("error",function(t){console.warn(t.message)});for(r in s)s.hasOwnProperty(r)&&i(s[r]);this.setStep(t.step),this.setIterations(t.iterations),this.setGravity(t.gravity)}return o.prototype.execute=function(t,e){return this.worker[t](e)},o.prototype.addVehicle=function(n){var i=t.defer();return this.worker.Vehicle_create(n).then(e.bind(function(t){var e=this;setTimeout(function(){i.resolve(new r(e,t))},0)},this)),i.promise},o.prototype.addRigidBody=function(n){var r=t.defer();return this.worker.RigidBody_create(n).then(e.bind(function(t){var e=this;setTimeout(function(){r.resolve(new i(e,t))},0)},this)),r.promise},o.prototype.update=function(t){this.next&&(this.worker.swap(this.data&&this.data.buffer),this.data=this.next),this.next=new Float64Array(t)},o.prototype.addRigidBodyObject=function(t,e,n){n||(n=this.getShapeJSON(t));var i={mass:e,shape:n,position:{x:t.position.x,y:t.position.y,z:t.position.z},quaternion:{x:t.quaternion.x,y:t.quaternion.y,z:t.quaternion.z,w:t.quaternion.w}};return this.addRigidBody(i)},o.prototype.getRigidBodyOffset=function(t){return 7*t},o.prototype.getWheelOffset=function(t,e){return 7*this.opts.maxBodies+7*8*t+7*e},o.prototype.getShapeJSON=function(t){var e=new THREE.Matrix4,n=new THREE.Matrix4,i={shape:"compound",children:[]};return e.getInverse(t.matrixWorld),t.traverse(function(t){if(t instanceof THREE.Mesh){var r,o,s,u=new THREE.Vector3,a=new THREE.Vector3,c=new THREE.Quaternion,l=t.matrixWorld.clone(),f=new THREE.Vector3;n.copy(e),n.multiply(l),a.getPositionFromMatrix(n),f.getScaleFromMatrix(l),n.extractRotation(n),c.setFromRotationMatrix(n),t.geometry.computeBoundingBox(),r=t.geometry.boundingBox.min.clone(),o=t.geometry.boundingBox.max.clone(),u.subVectors(o,r),u.multiplyScalar(.5),u.multiplyVectors(u,f),s=u;var p=new THREE.Vector3;p.x=(r.x+o.x)/2,p.y=(r.y+o.y)/2,p.z=(r.z+o.z)/2,p.multiplyVectors(p,f),i.children.push({shape:"box",halfExtents:{x:s.x,y:s.y,z:s.z},localTransform:{position:{x:a.x,y:a.y,z:a.z},rotation:{x:c.x,y:c.y,z:c.z,w:c.w}}})}}),i},o}),e("ammo_proxy")});