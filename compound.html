<!DOCTYPE html>
<html>
<head>
  <title>AmmoWorker</title>
  <style>
  html, body, pre#info { width: 100%; height: 100%; margin: 0; padding: 0;}
  #container {
    background: #000;
    width: 100%;
    height: 100%;
  }
  </style>
</head>
<body>
  <div id="container">
  </div>
  <script src="js/catiline.js"></script>
  <script src="js/ammo_worker.js"></script>
  <script src="js/three.js"></script>
  <script>
    var el = document.getElementById('info');
    var worker = new AmmoWorker();

    worker.on('ready', function() {
      worker.addRigidBody({
        position: {
          x: 0,
          y: 0,
          z: 0
        },
        quaternion: {
          x: 0,
          y: 0,
          z: 0,
          w: 1
        },
        shape: {
          shape: 'staticplane',
          normal: {
            x: 0,
            y: 1,
            z: 0
          },
          distance: 0
        },
        friction: 0.8,
        restitution: 0.2,
        mass: 0
      });

      worker.addRigidBody({
        position: {
          x: 0,
          y: 1,
          z: 0
        },
        quaternion: {
          x: 0,
          y: 0,
          z: 0,
          w: 1
        },
        shape: {
          shape: 'box',
          halfExtents: {
            x: 5,
            y: 3.6,
            z: 20
          }
        },
        friction: 0.8,
        restitution: 0.2,
        mass: 1
      }).then(function(bodyId) {
        worker.addVehicle({
          bodyId: bodyId,
          suspensionsStiffness: 5.88,
          suspensionCompression: 0.83,
          suspensionDamping: 0.88,
          maxSuspensionLevel: 500,
          frictionSlip: 10.5,
          maxSuspensionForce: 6000
        }).then(function(vehicleId) {
          console.log('vehicle added:', vehicleId);

          for ( var i = 0; i < 4; i++ ) {
            worker.addWheel({
              vehicleId: vehicleId,
              connectionPoint: {
                x: i % 2 === 0 ? -1.6 : 1.6,
                y: -1,
                z: i < 2 ? 3.3 : -3.2
              },
              wheelDirection: { x: 0, y: -1, z: 0 },
              wheelAxle: { x: -1, y: 0, z: 0 },
              suspensionRestLength: 0.5,
              wheelRadius: 0.7,
              isFrontWheel: i < 2 ? false : true
            }).then(function() {
              console.log('wheel added');
            }.bind(this));
          }
        }.bind(this));
      }.bind(this));
    });

    worker.on('error', function(err) {
      throw(err);
    });

    worker.on('stats', function(stats) {
      console.log(stats);
    });

    worker.on('update', function(buf) {
      var data = new Float64Array(buf);
      /*
      el.innerHTML = '';
      for (var i = 0; i < 10; i++)
        el.innerHTML += [data[i * 7 + 0], data[ i * 7 + 1 ], data[ i * 7 + 2 ],
          data[ i * 7 + 3 ], data[ i * 7 + 4 ], data[ i * 7 + 5 ], data[ i * 7 + 6 ]].join(' ') + '\n';

      for (var i = 0; i < 4; i++) {
        worker.applyEngineForce({ vehicleId: 0, wheel: i, force: 1000 });
      }

      setTimeout(function() {
        worker.swap(buf, [buf])
      }, 1000/60);
      */
    });

    setTimeout(function() {
      worker.startSimulation();

      setTimeout(function() {
        worker.stopSimulation();
      }, 5000);
    }, 500);
  </script>
  <script type="text/javascript">
  function createCompoundShape() {
    var o = new THREE.Object3D();

    o.add(new THREE.Mesh(new THREE.CubeGeometry(1, 1, 1), material));

    var o1 = new THREE.Object3D();
    o1.position.x += 1;
    o1.position.y += 1;
    o1.position.z += 0;
    o1.add(new THREE.Mesh(new THREE.CubeGeometry(1, 1, 1), material));
    o.add(o1);

    var o2 = new THREE.Object3D();
    o2.position.x += 1;
    o2.position.y += 1;
    o2.position.z += 0;
    o2.add(new THREE.Mesh(new THREE.CubeGeometry(1, 1, 1), material));
    o1.add(o2);

    o.traverse(function(obj) {
      if (obj instanceof THREE.Mesh) {
        
      }
    });

    return o;
  }

  // set the scene size
  var WIDTH = document.body.clientWidth,
      HEIGHT = document.body.clientHeight;

  // set some camera attributes
  var VIEW_ANGLE = 45,
      ASPECT = WIDTH / HEIGHT,
      NEAR = 0.01,
      FAR = 1000;

  // get the DOM element to attach to
  // - assume we've got jQuery to hand
  var container = document.getElementById('container');

  // create a WebGL renderer, camera
  // and a scene
  var renderer = new THREE.WebGLRenderer();
  var camera = new THREE.PerspectiveCamera(  VIEW_ANGLE,
                                  ASPECT,
                                  NEAR,
                                  FAR  );
  var scene = new THREE.Scene();

  // the camera starts at 0,0,0 so pull it back
  camera.position.z = 50;
  camera.position.y = 10;
  camera.position.x = 10;
  camera.lookAt(new THREE.Vector3(0,2.5,0));

  // start the renderer
  renderer.setSize(WIDTH, HEIGHT);

  // attach the render-supplied DOM element
  container.appendChild(renderer.domElement);

  // create the sphere's material
  var material = new THREE.MeshLambertMaterial(
  {
      color: 0xCC0000
  });

  /*
  // set up the sphere vars
  var radius = 50, segments = 16, rings = 16;

  // create a new mesh with sphere geometry -
  // we will cover the sphereMaterial next!
  var sphere = new THREE.Mesh(
     new THREE.SphereGeometry(radius, segments, rings),
     sphereMaterial);
  */

  // add the sphere to the scene
  //scene.add(sphere);
  for (var i = 0; i < 100; i++) {
    var box = createCompoundShape();
    box.position.x = 10 - (Math.random() * 20);
    box.position.z = 10 - (Math.random() * 20);
    box.position.y = Math.random() * 5;
    box.bodyId = i;
    scene.add(box);
  }

  // and the camera
  scene.add(camera);

  // create a point light
  var pointLight = new THREE.PointLight( 0xFFFFFF );

  // set its position
  pointLight.position.x = 10;
  pointLight.position.y = 10;
  pointLight.position.z = 13;

  // add to the scene
  scene.add(pointLight);

  // draw!
  renderer.render(scene, camera);
  </script>
</body>
</html>
