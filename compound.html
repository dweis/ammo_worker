<!DOCTYPE html>
<html>
<head>
  <title>Compound Object Test</title>
  <style>
  html, body, pre#info, #container { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; }
  </style>
</head>
<body>
  <div id="container">
  </div>
  <script src="js/catiline.js"></script>
  <script src="js/ammo_worker.js"></script>
  <script src="js/three.js"></script>
  <script src="js/stats.min.js"></script>
  <script src="js/OrbitControls.js"></script>
  <script src="js/demo_scene.js"></script>
  <script type="text/javascript">
  function CompoundDemo() {
  }

  CompoundDemo.prototype = new DemoScene();

  CompoundDemo.prototype.initDemo = function() {
    this.objects=[];
    this._createShapes();
    this.scene.updateMatrixWorld(true);
    this._createBodies();
  };

  CompoundDemo.prototype._createShapes = function() {
    var material = new THREE.MeshLambertMaterial({ color: 0xCC0000 });

    for (var i = 0; i < 100; i++) {
      var box = this._createCompoundShape(material);
      box.position.x = 10 - (Math.random() * 20);
      box.position.z = 10 - (Math.random() * 20);
      box.position.y = 10 + Math.random() * 5;
      box.bodyId = i;
      this.scene.add(box);

      this.objects[i] = box;
    }
  };

  CompoundDemo.prototype._createCompoundShape = function(material) {
    var o = new THREE.Object3D();

    o.add(new THREE.Mesh(new THREE.CubeGeometry(1, 1, 1), material));

    var o1 = new THREE.Object3D();
    o1.position.x = 1;
    o1.position.y = 1;
    o1.position.z = 0;
    o1.scale.x = 1.5;
    o1.scale.y = 1.5;
    o1.scale.z = 1.5;
    o1.quaternion.setFromAxisAngle({ x: 0, y: 1, z: 0 }, Math.PI/4);
    o1.add(new THREE.Mesh(new THREE.CubeGeometry(1, 1, 1), material));
    o.add(o1);

    var o2 = new THREE.Object3D();
    o2.position.x = 1;
    o2.position.y = 1;
    o2.position.z = 0;
    o2.scale.x = 2;
    o2.scale.y = 2;
    o2.scale.z = 2;
    o2.quaternion.setFromAxisAngle({ x: 0, y: 1, z: 0 }, Math.PI/4);
    o2.add(new THREE.Mesh(new THREE.CubeGeometry(1, 1, 1), material));
    o1.add(o2);

    o.traverse(function(o) {
      o.castShadow = true;
    });

    return o;
  };

  CompoundDemo.prototype._createBody = function(object) {
    this.worker
      .addRigidBodyObject(object, 1)
      .then(function(id) {
        object.bodyIndex = id;
      });
  };

  CompoundDemo.prototype._createBodies = function() {
    for (var i in this.objects) {
      this._createBody(this.objects[i]);
    }
  };

  CompoundDemo.prototype._updateBodies = function() {
    var object, bodyIndex;

    var updateBody = function(object) {
      bodyIndex = object.bodyIndex;

      this.worker.updateBody(object, bodyIndex);
    }.bind(this);

    for (var i in this.objects) {
      updateBody(this.objects[i]);
    }
  };

  CompoundDemo.prototype.preUpdate = function() {
    this._updateBodies();
  };

  var demo = new CompoundDemo();

  demo.init();
  </script>
</body>
</html>
