<!DOCTYPE html>
<html>
<head>
  <title>Triangle Mesh Test</title>
  <style>
  html, body, pre#info, #container { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; }
  </style>
</head>
<body>
  <div id="container">
  </div>
  <script src="js/catiline.js"></script>
  <script src="js/three.js"></script>
  <script src="js/stats.min.js"></script>
  <script src="js/OrbitControls.js"></script>
  <script src="../build/ammo_proxy.js"></script>
  <script src="js/demo_scene.js"></script>
  <script src="js/OBJLoader.js"></script>
  <script type="text/javascript">
    function SimpleDemo() {
    }

    SimpleDemo.prototype = new DemoScene();

    SimpleDemo.prototype.initDemo = function() {
      var that = this,
          material = new THREE.MeshLambertMaterial({ color: 0x33CC00 });
          terrainMaterial = new THREE.MeshLambertMaterial({ color: 0xFFFFFF });

          this.camera.position.x = 200;
          this.camera.position.y = 200;
          this.camera.position.z = 200;

      this.bodies = [];

      var texture = new THREE.Texture();

      var loader = new THREE.ImageLoader( );
      loader.load( 'data/CastleMap/final_castle_texture.png', function ( image ) {
        texture.image = image;
        texture.needsUpdate = true;
      });

      loader = new THREE.OBJLoader();
        loader.load( 'data/CastleMap/castle_map_complete.obj', function ( object ) {
          var scale = new THREE.Vector3();
          var mesh;
          var tmpVector3 = new THREE.Vector3();

          object.position.y = 20;
          object.scale.x = object.scale.y = object.scale.z = 5;
          var geometry = null;

          object.traverse( function ( child ) {
            console.log('test');
            if ( child instanceof THREE.Mesh ) {
              console.log('mesh', child.geometry.vertices.length);
              child.material = terrainMaterial;
              geometry = child.geometry;
              mesh = child;
              child.material.map = texture;


          triangles = new Float64Array(geometry.faces.length * 9);

          that.scene.updateMatrixWorld();
          scale.getScaleFromMatrix(mesh.matrixWorld);

          for (var faceIdx in geometry.faces) {
            face = geometry.faces[faceIdx];

            tmpVector3.copy(geometry.vertices[face.a]);
            tmpVector3.multiply(scale);

            triangles[faceIdx * 9 + 0] = tmpVector3.x;
            triangles[faceIdx * 9 + 1] = tmpVector3.y;
            triangles[faceIdx * 9 + 2] = tmpVector3.z;

            tmpVector3.copy(geometry.vertices[face.b]);
            tmpVector3.multiply(scale);

            triangles[faceIdx * 9 + 3] = tmpVector3.x;
            triangles[faceIdx * 9 + 4] = tmpVector3.y;
            triangles[faceIdx * 9 + 5] = tmpVector3.z;

            tmpVector3.copy(geometry.vertices[face.c]);
            tmpVector3.multiply(scale);

            triangles[faceIdx * 9 + 6] = tmpVector3.x;
            triangles[faceIdx * 9 + 7] = tmpVector3.y;
            triangles[faceIdx * 9 + 8] = tmpVector3.z;
          }
          console.log(triangles.length);

            /*
          o.position.x = (Math.random() * 30) - 15;
          o.position.y = 20 + (Math.random() * 20) - 5;
          o.position.z = (Math.random() * 30) - 15;
          */

          that.proxy.addRigidBodyObject(child, 0, {
            shape: 'bvh_triangle_mesh',
            triangles: triangles
          }).then(function(rigidBody) {
            rigidBody.setObject(child);
            this.bodies.push(rigidBody);
          }.bind(this));
            }
          }.bind(this) );

         
          that.scene.add( object );
        } );


      for (var i = 0; i < 25; i++) {
        var o = this._createObject(material);
      }
    };

    SimpleDemo.prototype._createObject = function(material) {
      var o = new THREE.Object3D(),
          geometry,
          mesh,
          face,
          triangles,
          scale = new THREE.Vector3(),
          tmpVector3 = new THREE.Vector3();

      geometry = new THREE.SphereGeometry(2, 10, 10);
         mesh = new THREE.Mesh(geometry, material)

      o.add(mesh);
      this.scene.add(o);

      o.position.x = (Math.random() * 100) - 50;
      o.position.y = 60 + (Math.random() * 20) - 5;
      o.position.z = (Math.random() * 100) - 50;

      this.proxy.addRigidBodyObject(o, 1, {
        shape: 'sphere',
        radius: 2
      }).then(function(rigidBody) {
        rigidBody.setObject(o);
        this.bodies.push(rigidBody);
      }.bind(this));

      o.traverse(function(o) {
        o.castShadow = true;
      });

      return o;
    };

    SimpleDemo.prototype.updateBodies = function() {
      for (var i in this.bodies) {
        this.bodies[i].update();
      }
    };

    SimpleDemo.prototype.preUpdate = function() {
      this.updateBodies();
    };

    var demo = new SimpleDemo();

    demo.init();
  </script>
</body>
</html>
