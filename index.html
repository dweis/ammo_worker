<!DOCTYPE html>
<html>
<head>
  <title>Performance Test</title>
  <style>
  html, body, pre#info, #container { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; }
  </style>
</head>
<body>
  <div id="container">
  </div>
  <script src="js/catiline.js"></script>
  <script src="js/ammo_worker.js"></script>
  <script src="js/three.js"></script>
  <script src="js/stats.min.js"></script>
  <script src="js/OrbitControls.js"></script>
  <script src="js/demo_scene.js"></script>
  <script type="text/javascript">
    function SimpleDemo() {
    }

    SimpleDemo.prototype = new DemoScene();

    SimpleDemo.prototype.initDemo = function() {
      var material = new THREE.MeshLambertMaterial({ color: 0xCC0000 });

      this.objects = [];
      for (var i = 0; i < 100; i++) {
        var o = this._createBox(material);
        this.scene.add(o);
        this.objects.push(o);
      }
      console.log(this.objects);
    };

    SimpleDemo.prototype._createBox = function(material) {
      var o = new THREE.Object3D();

      o.add(new THREE.Mesh(new THREE.CubeGeometry(2, 2, 2), material));

      this.worker.addRigidBody({
        position: {
          x: (Math.random() * 30) - 15,
          y: 10 + (Math.random() * 20) - 10,
          z: (Math.random() * 30) - 15,
        },
        quaternion: {
          x: 0,
          y: 0,
          z: 0,
          w: 1
        },
        shape: {
          shape: 'box',
          halfExtents: {
            x: 1,
            y: 1,
            z: 1
          }
        },
        friction: 0.8,
        restitution: 0.2,
        mass: 1
      }).then(function(id) {
        o.bodyIndex = id;
      });

      o.traverse(function(o) {
        o.castShadow = true;
      });

      return o;
    };

    SimpleDemo.prototype._updateBodies = function() {
      var object, position, quaternion, update, bodyIndex;
      if (!this.data) return;

      var updateBody = function(object) {
        position = object.position;
        quaternion = object.quaternion;

        bodyIndex = object.bodyIndex;

        if (this.data) {
          position.x = this.data[bodyIndex * 7 + 0];
          position.y = this.data[bodyIndex * 7 + 1];
          position.z = this.data[bodyIndex * 7 + 2];
          quaternion.x = this.data[bodyIndex * 7 + 3];
          quaternion.y = this.data[bodyIndex * 7 + 4];
          quaternion.z = this.data[bodyIndex * 7 + 5];
          quaternion.w = this.data[bodyIndex * 7 + 6];
        }
      }.bind(this);

      for (var i in this.objects) {
        updateBody(this.objects[i]);
      }
    };

    SimpleDemo.prototype.preUpdate = function() {
      this._updateBodies();
    };

    var demo = new SimpleDemo();

    demo.init();
  </script>
</body>
</html>
