<!DOCTYPE html>
<html>
<head>
  <title>VehicleTest</title>
  <style>
  html, body, pre#info, #container { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
  #container {
    background: #000;
  }
  </style>
</head>
<body>
  <div id="container">
  </div>
  <script src="js/catiline.js"></script>
  <script src="js/ammo_worker.js"></script>
  <script src="js/three.js"></script>
  <script src="js/OrbitControls.js"></script>
  <script src="js/demo_scene.js"></script>
  <script type="text/javascript">
    function init() {

      // draw!
      var update = function() {
        typeof preUpdate === 'function' && preUpdate();
        renderer.render(scene, camera);
        typeof postUpdate === 'function' && postUpdate();
      }

      scene.updateMatrixWorld(true);

      worker.on('update', function(data) {
        next = new Float64Array(data);
      });

      requestAnimationFrame(update);
    }

    var worker = new AmmoWorker();

    worker.on('ready', function() {
      worker.addRigidBody({
        position: {
          x: 0,
          y: 0,
          z: 0
        },
        quaternion: {
          x: 0,
          y: 0,
          z: 0,
          w: 1
        },
        shape: {
          shape: 'staticplane',
          normal: {
            x: 0,
            y: 1,
            z: 0
          },
          distance: 0
        },
        friction: 0.8,
        restitution: 0.2,
        mass: 0
      });

      worker.addRigidBody({
        position: {
          x: 0,
          y: 1,
          z: 0
        },
        quaternion: {
          x: 0,
          y: 0,
          z: 0,
          w: 1
        },
        shape: {
          shape: 'box',
          halfExtents: {
            x: 5,
            y: 3.6,
            z: 20
          }
        },
        friction: 0.8,
        restitution: 0.2,
        mass: 1
      }).then(function(bodyId) {
        worker.addVehicle({
          bodyId: bodyId,
          suspensionsStiffness: 5.88,
          suspensionCompression: 0.83,
          suspensionDamping: 0.88,
          maxSuspensionLevel: 500,
          frictionSlip: 10.5,
          maxSuspensionForce: 6000
        }).then(function(vehicleId) {
          console.log('vehicle added:', vehicleId);

          for ( var i = 0; i < 4; i++ ) {
            worker.addWheel({
              vehicleId: vehicleId,
              connectionPoint: {
                x: i % 2 === 0 ? -1.6 : 1.6,
                y: -1,
                z: i < 2 ? 3.3 : -3.2
              },
              wheelDirection: { x: 0, y: -1, z: 0 },
              wheelAxle: { x: -1, y: 0, z: 0 },
              suspensionRestLength: 0.5,
              wheelRadius: 0.7,
              isFrontWheel: i < 2 ? false : true
            }).then(function() {
              console.log('wheel added');
            }.bind(this));
          }
        }.bind(this));
      }.bind(this));

      init();
    });

    worker.on('error', function(err) {
      throw(err);
    });
  </script>
</body>
</html>
